<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>(beta)Googleホームページカスタムショートカットキー配置UserScript生成・編集ツール JavaScript・親階層移動対応</title>
  <style>
    :root {
      --glass-bg: rgba(255, 255, 255, 0.8);
      --glass-border: rgba(255, 255, 255, 0.3);
      --glass-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      --folder-bg: rgba(0, 0, 0, 0.2);
      --folder-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      --item-size: 72px;
      --icon-size: 40px;
      --folder-size: 40px;
      --border-radius: 12px;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      color: #333;
    }
    
    h1 {
      margin-bottom: 0;
      color: #1a73e8;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .tab {
      margin: 15px 0;
      display: flex;
      gap: 5px;
    }
    
    .tab button {
      padding: 10px 20px;
      border: none;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      color: #333;
    }
    
    .tab button.active {
        background: #e8f0fe;
        color: #1a73e8;
        box-shadow: 0 2px 5px rgba(26, 115, 232, 0.2);
    }

    .tab button:hover {
      background: rgba(255, 255, 255, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .section {
      border-radius: var(--border-radius);
      padding: 20px;
      margin-top: 15px;
      display: none;
      background: var(--glass-bg);
      backdrop-filter: blur(0px);
      -webkit-backdrop-filter: blur(0px);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
    }
    
    .section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .tree-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.6);
      position: relative;
    }
    
    .indent {
      display: inline-block;
      text-align: center;
      color: #5f6368;
    }
    
    .tree-item {
      flex: 1;
      display: flex;
      gap: 8px;
    }
    
    .tree-item input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.8);
    }
    
    .tree-item input[type="text"] {
      flex: 1;
    }
    
    .tree-item input[type="text"]:first-child {
      flex: 0.7;
    }
    
    .folder-indicator {
      position: absolute;
      left: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #1a73e8;
    }

    .folder-row {
        padding-left: 25px !important;
    }
    
    .tree-controls {
      display: flex;
      gap: 5px;
      margin-left: 10px;
    }
    
    .tree-controls button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background: #f1f3f4;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      white-space: nowrap;
    }
    
    .tree-controls button:hover {
      background: #e8eaed;
      transform: translateY(-1px);
    }
    
    .tree-controls .add {
      background: #e8f0fe;
      color: #1a73e8;
    }
    
    .tree-controls .add:hover {
      background: #d2e3fc;
    }
    
    .tree-controls .delete {
      background: #fce8e6;
      color: #d93025;
    }
    
    .tree-controls .delete:hover {
      background: #fad2cf;
    }
    
    /* 追加: 上下移動ボタンの視認性向上 */
    .tree-controls button.move-btn {
        background: #1a73e8;
        color: #ffffff;
    }
    .tree-controls button.move-btn:hover {
        background: #1669d6;
    }

    textarea {
      width: 100%;
      height: 300px;
      margin-top: 10px;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: rgba(255, 255, 255, 0.8);
      font-family: monospace;
      resize: vertical;
      box-sizing: border-box;
    }
        
    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .button-group button {
        flex-grow: 1;
    }

    .output-container {
      display: flex;
      align-items: stretch;
      gap: 10px;
    }
    
    .output-container textarea {
      margin-top: 0;
    }
        
    .result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 15px 0 10px;
    }
    
    .config-group {
      margin: 15px 0;
      padding: 15px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.6);
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    
    .config-group h3 {
      margin-top: 0;
      color: #1a73e8;
    }
    
    .config-item {
      margin: 12px 0;
      display: flex;
      align-items: center;
    }
    
    .config-item label {
      display: inline-block;
      width: 180px;
      font-weight: 500;
    }
    
    .config-item input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100px;
    }
    
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: #1a73e8;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 5px rgba(26, 115, 232, 0.2);
    }
    
    button:hover {
      background: #1669d6;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(26, 115, 232, 0.3);
    }
        
    .hint {
      font-size: 12px;
      color: #5f6368;
      margin-top: 4px;
      font-style: italic;
    }

    .js-button {
        background-color: #34a853;
    }
    .js-button:hover {
        background-color: #2c9f42;
    }

    /* Styles for new URL rule UI */
    .url-rule-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.7);
    }
    .url-rule-row input[type="text"] {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .url-rule-row .color-options {
      display: flex;
      gap: 8px;
      align-items: center;
      white-space: nowrap;
    }
    .url-rule-row .color-options label {
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .url-rule-row button.delete-rule {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background: #fce8e6;
      color: #d93025;
      cursor: pointer;
      font-size: 12px;
    }
     .config-group button {
        background: #e8f0fe;
        color: #1a73e8;
        padding: 8px 16px;
        font-size: 14px;
        box-shadow: none;
    }
  </style>
</head>
<body>
  <h1 style="text-align: center;">Googleホームページカスタムショートカットキー配置<br>UserScript生成・編集ツール<br><span style="color: red; font-size: 0.6em;">JavaScript・親階層移動対応(beta)</span></h1>
  <div class="tab">
    <button id="generateTab" class="active">生成</button>
    <button id="editTab">編集</button>
  </div>

  <div id="generateSection" class="section active">
    <h2>新規生成</h2>
    <div class="config-group">
      <h3>基本設定</h3>
      <div class="config-item">
        <label>サイズスケール (%): </label>
        <input type="number" id="scale" value="80" min="50" max="200">
      </div>
      <div class="config-item">
        <label>グリッド列数: </label>
        <input type="number" id="gridCols" value="5" min="1" max="10">
      </div>
      <div class="config-item">
        <label>グリッド行数: </label>
        <input type="number" id="gridRows" value="2" min="1" max="10">
      </div>
      <div class="config-item">
        <label>上部オフセット (px): </label>
        <input type="number" id="topOffset" value="80">
      </div>
      <div class="config-item">
        <label>左オフセット (px): </label>
        <input type="number" id="leftOffset" value="-460">
      </div>
    </div>
    
    <div class="config-group">
        <h3>文字色指定 <span class="hint">（指定したURLで表示された場合に文字色を固定します）</span></h3>
        <div id="generateUrlRulesContainer"></div>
        <button type="button" id="addUrlRuleBtn" style="margin-top: 10px;">ルールを追加</button>
    </div>

    <h3>ショートカット設定 <span class="hint">（フォルダはURL・アイコンURLが不要）</span></h3>
    <div id="shortcutsContainer"></div>
    <br>
    <button id="addRootItemBtn">+ ルートにアイテムを追加</button>
    
    <div class="button-group">
        <button id="generateUserScriptBtn">UserScriptを生成</button>
        <button id="generateJsBtn" class="js-button">JavaScriptを生成</button>
    </div>

    <div class="result-header">
      <h3>生成結果</h3>
      <button id="copyOutputBtn">クリップボードにコピー</button>
    </div>
    <div class="output-container">
      <textarea id="outputScript" readonly></textarea>
    </div>
  </div>

  <div id="editSection" class="section">
    <h2>編集</h2>
    <p>既存のUserScriptまたはJavaScriptコードを下記のテキストエリアに貼り付け、「スクリプトを読み込む」ボタンを押してください。</p>
    <textarea id="inputScript" placeholder="ここに既存のUserScriptまたはJavaScriptコードを貼り付けてください"></textarea>
    <br>
    <button id="loadScriptBtn" style="margin-top: 10px;">スクリプトを読み込む</button>
    <hr>
    <h3>編集フォーム</h3>
    <div class="config-group">
      <h3>基本設定</h3>
      <div class="config-item">
        <label>サイズスケール (%): </label>
        <input type="number" id="editScale" min="50" max="200">
      </div>
      <div class="config-item">
        <label>グリッド列数: </label>
        <input type="number" id="editGridCols" min="1" max="10">
      </div>
      <div class="config-item">
        <label>グリッド行数: </label>
        <input type="number" id="editGridRows" min="1" max="10">
      </div>
      <div class="config-item">
        <label>上部オフセット (px): </label>
        <input type="number" id="editTopOffset">
      </div>
      <div class="config-item">
        <label>左オフセット (px): </label>
        <input type="number" id="editLeftOffset">
      </div>
    </div>
    
    <div class="config-group">
        <h3>文字色指定 <span class="hint">（指定したURLで表示された場合に文字色を固定します）</span></h3>
        <div id="editUrlRulesContainer"></div>
        <button type="button" id="addUrlRuleEditBtn" style="margin-top: 10px;">ルールを追加</button>
    </div>

    <h3>ショートカット設定 <span class="hint">（フォルダはURL・アイコンURLが不要）</span></h3>
    <div id="editShortcutsContainer"></div>
    <br>
    <button id="addRootItemEditBtn">+ ルートにアイテムを追加</button>

    <div class="button-group">
        <button id="regenerateUserScriptBtn">UserScriptを再生成</button>
        <button id="regenerateJsBtn" class="js-button">JavaScriptを再生成</button>
    </div>

    <div class="result-header">
      <h3>生成結果</h3>
      <button id="copyEditOutputBtn">クリップボードにコピー</button>
    </div>
    <div class="output-container">
      <textarea id="editOutputScript" readonly></textarea>
    </div>
  </div>

  <script>
    // Tab switching
    const generateTabBtn = document.getElementById('generateTab');
    const editTabBtn = document.getElementById('editTab');
    const generateSection = document.getElementById('generateSection');
    const editSection = document.getElementById('editSection');

    function switchTab(activeTab, inactiveTab, activeSection, inactiveSection) {
        activeTab.classList.add('active');
        inactiveTab.classList.remove('active');
        activeSection.classList.add('active');
        inactiveSection.classList.remove('active');
    }

    generateTabBtn.addEventListener('click', () => switchTab(generateTabBtn, editTabBtn, generateSection, editSection));
    editTabBtn.addEventListener('click', () => switchTab(editTabBtn, generateTabBtn, editSection, generateSection));

    // --- URL Rule Management ---
    let ruleCounter = 0;

    function createUrlRuleRow(containerId, rule = { url: '', color: 'white' }) {
        const row = document.createElement('div');
        row.className = 'url-rule-row';

        const urlInput = document.createElement('input');
        urlInput.type = 'text';
        urlInput.placeholder = 'URL (完全一致)';
        urlInput.value = rule.url;

        const colorOptionsDiv = document.createElement('div');
        colorOptionsDiv.className = 'color-options';

        const radioName = `color-rule-${containerId}-${ruleCounter++}`;

        const whiteLabel = document.createElement('label');
        const whiteRadio = document.createElement('input');
        whiteRadio.type = 'radio';
        whiteRadio.name = radioName;
        whiteRadio.value = 'white';
        whiteRadio.checked = rule.color !== 'black';
        whiteLabel.appendChild(whiteRadio);
        whiteLabel.append(' 白');

        const blackLabel = document.createElement('label');
        const blackRadio = document.createElement('input');
        blackRadio.type = 'radio';
        blackRadio.name = radioName;
        blackRadio.value = 'black';
        blackRadio.checked = rule.color === 'black';
        blackLabel.appendChild(blackRadio);
        blackLabel.append(' 黒');

        colorOptionsDiv.appendChild(whiteLabel);
        colorOptionsDiv.appendChild(blackLabel);

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '削除';
        deleteBtn.className = 'delete-rule';
        deleteBtn.type = 'button';
        deleteBtn.onclick = () => row.remove();

        row.appendChild(urlInput);
        row.appendChild(colorOptionsDiv);
        row.appendChild(deleteBtn);

        return row;
    }

    document.getElementById('addUrlRuleBtn').addEventListener('click', () => {
        const container = document.getElementById('generateUrlRulesContainer');
        container.appendChild(createUrlRuleRow('generate'));
    });

    document.getElementById('addUrlRuleEditBtn').addEventListener('click', () => {
        const container = document.getElementById('editUrlRulesContainer');
        container.appendChild(createUrlRuleRow('edit'));
    });
    
    function extractUrlRules(container) {
        const rules = [];
        container.querySelectorAll('.url-rule-row').forEach(row => {
            const url = row.querySelector('input[type="text"]').value.trim();
            const colorInput = row.querySelector('input[type="radio"]:checked');
            if (url && colorInput) {
                rules.push({ url, color: colorInput.value });
            }
        });
        return rules;
    }

    function populateUrlRulesForm(rules, container) {
        container.innerHTML = '';
        if (rules && Array.isArray(rules)) {
            rules.forEach(rule => {
                container.appendChild(createUrlRuleRow(container.id.includes('generate') ? 'generate' : 'edit', rule));
            });
        }
    }

    // --- Shortcut Tree Management ---
    function createTreeItemRow(item = { name: '', url: '', icon: '' }, depth = 0, isFolder = false) {
        const row = document.createElement('div');
        row.className = 'tree-row';
        row.dataset.depth = depth;
        row.style.paddingLeft = `${depth * 30}px`;

        let localIsFolder = isFolder || (item.children && item.children.length > 0);

        if (depth > 0) {
            const indentMarker = document.createElement('span');
            indentMarker.className = 'indent';
            indentMarker.innerHTML = '↳&nbsp;';
            row.appendChild(indentMarker);
        }
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'tree-item';
        
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.value = item.name || '';

        const urlInput = document.createElement('input');
        urlInput.type = 'text';
        urlInput.placeholder = 'URL';
        urlInput.value = item.url || '';

        const iconInput = document.createElement('input');
        iconInput.type = 'text';
        iconInput.placeholder = 'アイコンURL (空で自動生成)';
        iconInput.value = item.icon || '';

        const updateFolderState = (isNowFolder) => {
            urlInput.style.display = isNowFolder ? 'none' : '';
            iconInput.style.display = isNowFolder ? 'none' : '';
            nameInput.placeholder = isNowFolder ? 'フォルダ名' : '名前';

            if (isNowFolder && !row.classList.contains('folder-row')) {
                row.classList.add('folder-row');
                 if (!row.querySelector('.folder-indicator')) {
                    const indicator = document.createElement('div');
                    indicator.className = 'folder-indicator';
                    row.insertBefore(indicator, itemDiv);
                }
            } else if (!isNowFolder) {
                row.classList.remove('folder-row');
                const indicator = row.querySelector('.folder-indicator');
                if (indicator) indicator.remove();
            }
        };

        itemDiv.appendChild(nameInput);
        itemDiv.appendChild(urlInput);
        itemDiv.appendChild(iconInput);
        row.appendChild(itemDiv);
        
        const controlsDiv = document.createElement('div');
        controlsDiv.className = 'tree-controls';
        
        const upBtn = document.createElement('button');
        upBtn.textContent = '↑';
        upBtn.title = '上へ移動';
        upBtn.classList.add('move-btn');
        
        const downBtn = document.createElement('button');
        downBtn.textContent = '↓';
        downBtn.title = '下へ移動';
        downBtn.classList.add('move-btn');
        
        // --- ▼▼▼ 親子セットで移動するロジック ▼▼▼ ---
        const getGroupRows = (startRow) => {
            const rows = [startRow];
            const baseDepth = parseInt(startRow.dataset.depth, 10);
            let nxt = startRow.nextElementSibling;
            while (nxt && parseInt(nxt.dataset.depth, 10) > baseDepth) {
                rows.push(nxt);
                nxt = nxt.nextElementSibling;
            }
            return rows;
        };

        const moveGroup = (direction) => {
            const currentDepth = parseInt(row.dataset.depth, 10);
            const groupRows = getGroupRows(row);
            const parent = row.parentNode;

            if (direction === 'up') {
                let target = row.previousElementSibling;
                // 自分より深い階層の兄要素はスキップして、同じ階層以上の兄を探す
                while (target && parseInt(target.dataset.depth, 10) > currentDepth) {
                    target = target.previousElementSibling;
                }
                if (!target) return; // 先頭なので移動不可

                // 挿入先を見つける (移動先グループの先頭)
                const targetDepth = parseInt(target.dataset.depth, 10);
                while(target.previousElementSibling && parseInt(target.previousElementSibling.dataset.depth, 10) > targetDepth) {
                   target = target.previousElementSibling;
                }
                
                const frag = document.createDocumentFragment();
                groupRows.forEach(r => frag.appendChild(r));
                parent.insertBefore(frag, target);
            }

            if (direction === 'down') {
                const lastRowInGroup = groupRows[groupRows.length - 1];
                let targetGroupStart = lastRowInGroup.nextElementSibling;
                if (!targetGroupStart) return; // 末尾なので移動不可

                // 挿入先(次のグループの次の要素)を見つける
                const targetGroupDepth = parseInt(targetGroupStart.dataset.depth, 10);
                let targetGroupEnd = targetGroupStart;
                while (targetGroupEnd.nextElementSibling && parseInt(targetGroupEnd.nextElementSibling.dataset.depth, 10) > targetGroupDepth) {
                   targetGroupEnd = targetGroupEnd.nextElementSibling;
                }
                const insertBeforeNode = targetGroupEnd.nextElementSibling;
                
                const frag = document.createDocumentFragment();
                groupRows.forEach(r => frag.appendChild(r));
                parent.insertBefore(frag, insertBeforeNode); 
            }
        };

        upBtn.addEventListener('click', () => moveGroup('up'));
        downBtn.addEventListener('click', () => moveGroup('down'));
        // --- ▲▲▲ 親子セットで移動するロジック ▲▲▲ ---

        const addSiblingBtn = document.createElement('button');
        addSiblingBtn.textContent = '同じ階層に追加';
        addSiblingBtn.className = 'add';
        addSiblingBtn.addEventListener('click', () => {
            const newRow = createTreeItemRow({}, depth);
            // 自分のグループの最後の要素を探す
            let lastRowInGroup = row;
            let nextSibling = row.nextElementSibling;
            while(nextSibling && parseInt(nextSibling.dataset.depth, 10) > depth) {
                lastRowInGroup = nextSibling;
                nextSibling = nextSibling.nextElementSibling;
            }
            // 自分のグループの直後に挿入
            lastRowInGroup.insertAdjacentElement('afterend', newRow);
        });
        
        const addChildBtn = document.createElement('button');
        addChildBtn.textContent = '下の階層に追加';
        addChildBtn.className = 'add';
        addChildBtn.addEventListener('click', () => {
            if (!row.classList.contains('folder-row')) {
                localIsFolder = true;
                updateFolderState(true);
            }
            const newRow = createTreeItemRow({}, depth + 1);
            
            // 自分のグループの最後の要素を探す
            let lastRowInGroup = row;
            let nextSibling = row.nextElementSibling;
            while(nextSibling && parseInt(nextSibling.dataset.depth, 10) > depth) {
                lastRowInGroup = nextSibling;
                nextSibling = nextSibling.nextElementSibling;
            }
            // 自分のグループの直後に挿入
            lastRowInGroup.insertAdjacentElement('afterend', newRow);
        });
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '削除';
        deleteBtn.className = 'delete';
        deleteBtn.addEventListener('click', () => {
            // 削除対象のグループを取得してすべて削除
            const groupRows = getGroupRows(row);
            groupRows.forEach(r => r.remove());
        });
        
        controlsDiv.appendChild(upBtn);
        controlsDiv.appendChild(downBtn);
        controlsDiv.appendChild(addSiblingBtn);
        controlsDiv.appendChild(addChildBtn);
        controlsDiv.appendChild(deleteBtn);
        row.appendChild(controlsDiv);

        updateFolderState(localIsFolder);
        
        return row;
    }

    const shortcutsContainer = document.getElementById('shortcutsContainer');
    const editShortcutsContainer = document.getElementById('editShortcutsContainer');
    
    document.getElementById('addRootItemBtn').addEventListener('click', () => {
        shortcutsContainer.appendChild(createTreeItemRow());
    });
    
    document.getElementById('addRootItemEditBtn').addEventListener('click', () => {
        editShortcutsContainer.appendChild(createTreeItemRow());
    });
    
    shortcutsContainer.appendChild(createTreeItemRow({name: '', url: ''}));

    function extractTreeData(container) {
        const rootItems = [];
        const parentStack = [{ children: rootItems, depth: -1 }];

        Array.from(container.querySelectorAll('.tree-row')).forEach(row => {
            const itemDepth = parseInt(row.dataset.depth, 10);
            
            const inputs = row.querySelectorAll('input');
            const name = inputs[0].value.trim();
            const url = inputs[1].value.trim();
            let icon = inputs[2].value.trim();
            
            const isFolder = row.classList.contains('folder-row');

            if (!isFolder && url && !icon) {
                try {
                    const domain = new URL(url).hostname;
                    icon = `https://www.google.com/s2/favicons?sz=64&domain_url=${domain}`;
                } catch (e) {
                    console.warn("Invalid URL for favicon:", url);
                }
            }

            const item = { name };
            if (isFolder) {
                item.isFolder = true;
                item.children = [];
            } else {
                item.url = url;
                item.icon = icon;
            }

            while (parentStack.length > 1 && parentStack[parentStack.length - 1].depth >= itemDepth) {
                parentStack.pop();
            }

            const parentNode = parentStack[parentStack.length - 1];
            (parentNode.item ? parentNode.item.children : parentNode.children).push(item);
            
            if (isFolder) {
                parentStack.push({ item, depth: itemDepth });
            }
        });
        return rootItems;
    }

    // --- Script Generation ---
    function buildItemsString(items, indentLevel) {
        let result = "[\n";
        const indent = ' '.repeat(indentLevel * 4);
        const childIndent = ' '.repeat((indentLevel + 1) * 4);

        items.forEach((item, index) => {
            result += `${childIndent}{\n`;
            result += `${childIndent}    name: "${item.name}",\n`;
            if (item.isFolder) {
                result += `${childIndent}    isFolder: true,\n`;
                result += `${childIndent}    children: ${item.children ? buildItemsString(item.children, indentLevel + 1) : '[]'}\n`;
            } else {
                result += `${childIndent}    url: "${item.url}",\n`;
                result += `${childIndent}    icon: "${item.icon || ''}"\n`;
            }
            result += `${childIndent}}${index < items.length - 1 ? ',' : ''}\n`;
        });

        result += `${indent}]`;
        return result;
    }

    function generateScript(params, type) {
        const items = extractTreeData(params.shortcutsContainer);
        const itemsString = buildItemsString(items, 1);
        const urlRules = extractUrlRules(params.urlRulesContainer);
        const urlRulesString = JSON.stringify(urlRules, null, 4);

        const coreLogic = `
(function() {
    'use strict';

    const config = {
        scale: ${params.scale},
        gridCols: ${params.gridCols},
        gridRows: ${params.gridRows},
        topOffset: ${params.topOffset},
        leftOffset: ${params.leftOffset}
    };

    const items = ${itemsString};
    
    const urlRules = ${urlRulesString};

    const styleText = \`
      :root {
        --item-size: 72px;
        --icon-size: 40px;
        --folder-size: 40px;
        --border-radius: 12px;
      }
      .panel-style {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
        border-radius: var(--border-radius);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2), inset 0 1px 1px rgba(255,255,255,0.4);
        padding: 20px; position: fixed;
      }
      .custom-shortcuts-container {
        transform: scale(\${config.scale / 100});
        transform-origin: top left; display: grid;
        grid-template-columns: repeat(\${config.gridCols}, var(--item-size));
        grid-template-rows: repeat(\${config.gridRows}, var(--item-size));
        gap: 15px; z-index: 9999; pointer-events: auto; cursor: move;
      }
      .panel-controls {
        position: absolute; top: 8px; right: 8px; display: flex; gap: 8px; cursor: default;
      }
      .control-button {
        width: 16px; height: 16px; border-radius: 50%; display: flex;
        align-items: center; justify-content: center; font-family: sans-serif;
        font-size: 12px; line-height: 16px; cursor: pointer; transition: color 0.2s;
        user-select: none; background-color: rgba(0, 0, 0, 0.7);
      }
      .settings-button {
        width: 16px; height: 16px;
        cursor: pointer;
        background-image: url('https://kotonohaworks.com/free-icons/wp-content/uploads/kkrn_icon_haguruma_1.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        filter: invert(1);
        opacity: 0.7;
        transition: opacity 0.2s;
      }
      .settings-button:hover {
        opacity: 1;
      }
      .custom-shortcut {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        text-decoration: none; width: var(--item-size); height: var(--item-size);
        transition: all 0.2s; border-radius: var(--border-radius);
        padding: 4px; box-sizing: border-box; cursor: pointer;
      }
      .custom-shortcut:hover {
        transform: translateY(-5px); background: rgba(255,255,255,0.3);
      }
      .custom-shortcut img, .custom-shortcut .folder-icon-preview {
        width: var(--icon-size); height: var(--icon-size);
        object-fit: contain; border-radius: calc(var(--border-radius) * 0.5);
      }
      .custom-shortcut span {
        font-size: 12px; margin-top: 6px; text-align: center;
        width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        transition: color 0.3s;
      }
      .light-text .custom-shortcut span, .light-text .control-button { color: white !important; }
      .dark-text .custom-shortcut span, .dark-text .control-button { color: black !important; }
      .custom-folder .folder-icon-preview {
        display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
        gap: 2px; padding: 2px; width: var(--folder-size); height: var(--folder-size);
        background: rgba(0,0,0,0.1); border-radius: var(--border-radius);
      }
      .folder-icon-preview .preview-icon {
        width: 95%; height: 95%; background-size: contain;
        background-repeat: no-repeat; background-position: center; border-radius: 4px;
      }
      .folder-contents-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0); backdrop-filter: blur(0px); -webkit-backdrop-filter: blur(0px);
        z-index: 10000; display: flex; align-items: center; justify-content: center;
        animation: blurFadeIn 0.3s ease-out forwards;
      }
      .folder-contents {
        display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; max-width: 400px;
        transform: scale(0.8); opacity: 0; animation: scaleUp 0.15s ease-out 0.05s forwards;
        position: relative;
      }
      @keyframes scaleUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
      @keyframes blurFadeIn { to { background: rgba(0,0,0,0); backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); } }
      @keyframes blurFadeOut { from { background: rgba(0,0,0,0); backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); } to { background: rgba(0,0,0,0); backdrop-filter: blur(0px); -webkit-backdrop-filter: blur(0px); } }
      @keyframes scaleDown { from { transform: scale(1); opacity: 1; } to { transform: scale(0.8); opacity: 0; } }
      .folder-contents-overlay.closing { animation: blurFadeOut 0.3s ease-out forwards; }
      .folder-contents.closing { animation: scaleDown 0.3s ease-in forwards; }
    \`;

    let isDarkMode = false;
    const container = document.createElement('div');
    const controls = document.createElement('div');
    const settingsBtn = document.createElement('div');
    const toggleModeBtn = document.createElement('div');

    function applyTheme(isDark) {
        isDarkMode = isDark;
        container.classList.toggle('dark-text', isDarkMode);
        container.classList.toggle('light-text', !isDarkMode);
        toggleModeBtn.textContent = isDarkMode ? '●' : '◯';
    }

    function createShortcut(item) {
        const link = document.createElement('a');
        link.href = item.url;
        link.className = "custom-shortcut";
        const img = document.createElement('img');
        try {
            img.src = item.icon || \`https://www.google.com/s2/favicons?sz=64&domain_url=\${new URL(item.url).hostname}\`;
        } catch(e) { img.src = ''; }
        img.alt = item.name;
        img.onerror = (e) => { e.target.src = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; };
        const span = document.createElement('span');
        span.textContent = item.name;
        link.appendChild(img);
        link.appendChild(span);
        return link;
    }

    function createFolder(item) {
        const folder = document.createElement('div');
        folder.className = "custom-shortcut custom-folder";
        const preview = document.createElement('div');
        preview.className = 'folder-icon-preview';
        item.children.slice(0, 9).forEach(child => {
            if (child.icon) {
                const iconDiv = document.createElement('div');
                iconDiv.className = 'preview-icon';
                iconDiv.style.backgroundImage = \`url(\${child.icon})\`;
                preview.appendChild(iconDiv);
            }
        });
        const span = document.createElement('span');
        span.textContent = item.name;
        folder.appendChild(preview);
        folder.appendChild(span);
        folder.addEventListener('click', (e) => {
            e.stopPropagation();
            const overlay = document.createElement('div');
            overlay.className = 'folder-contents-overlay';
            const contents = document.createElement('div');
            contents.className = 'folder-contents panel-style';
            contents.classList.toggle('dark-text', isDarkMode);
            contents.classList.toggle('light-text', !isDarkMode);
            item.children.forEach(child => {
                if (!child.isFolder) { contents.appendChild(createShortcut(child)); }
            });
            overlay.appendChild(contents);
            document.body.appendChild(overlay);
            overlay.addEventListener('click', (ev) => {
                if (ev.target === overlay) {
                    overlay.classList.add('closing');
                    contents.classList.add('closing');
                    overlay.addEventListener('animationend', () => overlay.remove(), { once: true });
                }
            });
        });
        return folder;
    }

    container.className = "custom-shortcuts-container panel-style";
    controls.className = 'panel-controls';
    settingsBtn.className = 'settings-button';
    toggleModeBtn.className = 'control-button toggle-mode-btn';
    const closeBtn = document.createElement('div');
    closeBtn.className = 'control-button close-btn';
    closeBtn.textContent = '✕';
    controls.appendChild(settingsBtn);
    controls.appendChild(toggleModeBtn);
    controls.appendChild(closeBtn);
    container.appendChild(controls);

    toggleModeBtn.addEventListener('click', (e) => { e.stopPropagation(); applyTheme(!isDarkMode); });
    closeBtn.addEventListener('click', (e) => { e.stopPropagation(); container.style.display = 'none'; });

    // 設定ボタンのクリックイベント
    settingsBtn.addEventListener('click', (e) => {
        e.stopPropagation();

        // JSON.stringifyの結果からキーのダブルクオートを削除
        const configString = JSON.stringify(config, null, 4).replace(/"([^"]+)":/g, '$1:');

        // 設定データを文字列として生成
        const textToCopy =
\`const config = \${configString};

const items = \${JSON.stringify(items, null, 4)};

const urlRules = \${JSON.stringify(urlRules, null, 4)};\`;

        // クリップボードへのコピー処理
        const textarea = document.createElement('textarea');
        textarea.value = textToCopy;
        textarea.style.position = 'fixed';
        textarea.style.top = '-9999px';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();

        let copySuccess = false;
        try {
            copySuccess = document.execCommand('copy');
        } catch (err) {
            console.error('設定のコピーに失敗しました。', err);
            copySuccess = false;
        } finally {
            document.body.removeChild(textarea);
        }

        // 結果を通知し、ページを開くか確認
        if (copySuccess) {
            if (confirm('設定をクリップボードにコピーしました。\\n\\nOKを押すと、設定方法を説明したページを新しいタブで開きます。')) {
                window.open('https://sites.google.com/view/homepage-custom-shortcut/%E3%83%9B%E3%83%BC%E3%83%A0', '_blank');
            }
        } else {
            if (confirm('設定のコピーに失敗しました。\\nお使いのブラウザや拡張機能の設定により、コピー機能がブロックされた可能性があります。\\n\\nOKを押すと、設定方法を説明したページを新しいタブで開きます。手動で設定をコピー＆ペーストしてください。')) {
                window.open('https://sites.google.com/view/homepage-custom-shortcut/%E3%83%9B%E3%83%BC%E3%83%A0', '_blank');
            }
        }
    });

    items.slice(0, config.gridCols * config.gridRows).forEach(item => {
        container.appendChild(item.isFolder ? createFolder(item) : createShortcut(item));
    });
    
    function makeDraggableAndPosition(element) {
        setTimeout(() => {
            const scale = config.scale / 100;
            const rect = element.getBoundingClientRect();
            const containerWidth = rect.width / scale;
            const initialLeft = (window.innerWidth / 2) + config.leftOffset - (containerWidth / 2);
            element.style.left = \`\${initialLeft}px\`;
            element.style.top = \`\${config.topOffset}px\`;
        }, 0);
        let startX, startY, startLeft, startTop;
        element.addEventListener('mousedown', (e) => {
            if (e.target.closest('.custom-shortcut, .panel-controls')) { return; }
            e.preventDefault();
            const scale = config.scale / 100;
            startX = e.clientX; startY = e.clientY;
            startLeft = element.offsetLeft; startTop = element.offsetTop;
            function onMouseMove(e) {
                element.style.left = \`\${startLeft + ((e.clientX - startX) / scale)}px\`;
                element.style.top = \`\${startTop + ((e.clientY - startY) / scale)}px\`;
            }
            function onMouseUp() {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    }

    // --- Initialization ---
    document.body.appendChild(container);
    makeDraggableAndPosition(container);

    let initialThemeIsDark = false;
    const currentUrl = window.location.href;
    let ruleApplied = false;

    if (urlRules && urlRules.length > 0) {
        for (const rule of urlRules) {
            if (currentUrl === rule.url) {
                initialThemeIsDark = (rule.color === 'black');
                ruleApplied = true;
                break;
            }
        }
    }

    if (!ruleApplied) {
        if (currentUrl.endsWith('/1')) { initialThemeIsDark = true; } 
        else if (currentUrl.endsWith('/0')) { initialThemeIsDark = false; }
    }
    
    applyTheme(initialThemeIsDark);
`;

        if (type === 'userscript') {
            return `// ==UserScript==
// @name         Googleカスタムショートカット（階層・文字色指定・設定機能追加版）
// @namespace    http://tampermonkey.net/
// @version      5.2
// @description  Googleトップページにカスタムショートカットを表示（階層・文字色指定・設定機能対応）
// @author       Generated by Tool, Modified by Gemini
// @match        https://www.google.com/*
// @grant        GM_addStyle
// ==/UserScript==
${coreLogic}
    if (window.location.pathname === '/') {
        GM_addStyle(styleText);
    }
})();`;
        } else { // javascript
    // 生成されるコードの全体を `rawJs` 変数に格納
    const rawJs = `
${coreLogic}
    const styleTag = document.createElement('style');
    styleTag.textContent = styleText;
    document.head.appendChild(styleTag);
})();`;
    // 変数の先頭に 'javascript:' を付けて返す
    return `javascript:${rawJs}`;
}
    }

    // --- Event Listeners for Buttons ---
    function setupButton(buttonId, outputId, paramsProvider, scriptType) {
        document.getElementById(buttonId).addEventListener('click', () => {
            const params = paramsProvider();
            document.getElementById(outputId).value = generateScript(params, scriptType);
        });
    }

    const genParams = () => ({
        scale: document.getElementById('scale').value, gridCols: document.getElementById('gridCols').value,
        gridRows: document.getElementById('gridRows').value, topOffset: document.getElementById('topOffset').value,
        leftOffset: document.getElementById('leftOffset').value, shortcutsContainer: shortcutsContainer,
        urlRulesContainer: document.getElementById('generateUrlRulesContainer')
    });
    const editParams = () => ({
        scale: document.getElementById('editScale').value, gridCols: document.getElementById('editGridCols').value,
        gridRows: document.getElementById('editGridRows').value, topOffset: document.getElementById('editTopOffset').value,
        leftOffset: document.getElementById('editLeftOffset').value, shortcutsContainer: editShortcutsContainer,
        urlRulesContainer: document.getElementById('editUrlRulesContainer')
    });

    setupButton('generateUserScriptBtn', 'outputScript', genParams, 'userscript');
    setupButton('generateJsBtn', 'outputScript', genParams, 'javascript');
    setupButton('regenerateUserScriptBtn', 'editOutputScript', editParams, 'userscript');
    setupButton('regenerateJsBtn', 'editOutputScript', editParams, 'javascript');

    document.getElementById('loadScriptBtn').addEventListener('click', () => {
        const scriptText = document.getElementById('inputScript').value;
        const extractValue = (regex, defaultValue) => {
            const match = scriptText.match(regex);
            return match ? match[1] : defaultValue;
        };

        document.getElementById('editScale').value = extractValue(/scale: (-?\d+)/, 80);
        document.getElementById('editGridCols').value = extractValue(/gridCols: (\d+)/, 5);
        document.getElementById('editGridRows').value = extractValue(/gridRows: (\d+)/, 2);
        document.getElementById('editTopOffset').value = extractValue(/topOffset: (-?\d+)/, 80);
        document.getElementById('editLeftOffset').value = extractValue(/leftOffset: (-?\d+)/, -460);

        const itemsMatch = scriptText.match(/const items = (\[[\s\S]*?\]);/);
        editShortcutsContainer.innerHTML = '';
        if (itemsMatch && itemsMatch[1]) {
            try {
                const items = new Function(`return ${itemsMatch[1]}`)();
                populateEditForm(items, editShortcutsContainer, 0);
            } catch (e) {
                alert('スクリプトのアイテムデータの解析に失敗しました。');
                console.error("Failed to parse items:", e);
            }
        } else {
            alert('アイテムのデータが見つかりませんでした。');
        }
        
        const urlRulesMatch = scriptText.match(/const urlRules = (\[[\s\S]*?\]);/);
        const editUrlRulesContainer = document.getElementById('editUrlRulesContainer');
        editUrlRulesContainer.innerHTML = '';
         if (urlRulesMatch && urlRulesMatch[1]) {
            try {
                const rules = new Function(`return ${urlRulesMatch[1]}`)();
                populateUrlRulesForm(rules, editUrlRulesContainer);
            } catch(e) {
                console.error("URLルールの解析に失敗:", e);
            }
        }
    });

    function populateEditForm(items, container, depth) {
        items.forEach(item => {
            const isFolder = !!item.isFolder;
            const row = createTreeItemRow(item, depth, isFolder);
            container.appendChild(row);

            if (isFolder && item.children) {
                populateEditForm(item.children, container, depth + 1);
            }
        });
    }
    
    document.getElementById('copyOutputBtn').addEventListener('click', () => {
        navigator.clipboard.writeText(document.getElementById('outputScript').value).then(() => alert('コピーしました！'));
    });
    document.getElementById('copyEditOutputBtn').addEventListener('click', () => {
        navigator.clipboard.writeText(document.getElementById('editOutputScript').value).then(() => alert('コピーしました！'));
    });

  </script>
</body>
</html>