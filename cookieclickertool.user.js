// ==UserScript==
// @name         Cookie Clicker Advanced Panel 
// @namespace    https://github.com/you
// @version      3.0.8
// @description  å·¦ä¸‹ã®âš™ã§é–‹ããƒ‘ãƒãƒ«ã€‚æ¯ç§’ã®ã‚³ã‚¹ãƒ‘è¨ˆç®—ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€è‡ªå‹•è³¼å…¥ã€è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ã€è‡ªå‹•ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¯ãƒƒã‚­ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã€è‡ªå‹•ãƒˆãƒŠã‚«ã‚¤ã‚¯ãƒªãƒƒã‚¯ã€ä¸€æ‹¬å£²å´/è³¼å…¥ã€æ‰‹å‹•è³¼å…¥ã«åŠ ãˆã€åŒæ™‚ç™ºç”Ÿæ¤œå‡ºãƒ»MPå›å¾©ç›®å®‰ãƒ»ã‚»ãƒ¼ãƒ–å…¥å‡ºåŠ›ã‚’è¿½åŠ ã€‚è¨­å®šã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
// @author       Generated by ChatGPT, Modified by User Request
// @match        https://orteil.dashnet.org/cookieclicker/*
// @match        http://orteil.dashnet.org/cookieclicker/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';
    // --- è¨­å®šã‚­ãƒ¼ ---
    const LS_KEY = 'cc_advanced_panel_v1'; // v1ã‚­ãƒ¼ã‚’æµç”¨ã—ã¦è¨­å®šã‚’å¼•ãç¶™ã

// --- å»ºç‰©æ—¥æœ¬èªå ---
const BUILDING_META = [
    { id: 0, name: 'ã‚«ãƒ¼ã‚½ãƒ«' },
    { id: 1, name: 'ã‚°ãƒ©ãƒ³ãƒ' },
    { id: 2, name: 'è¾²å ´' },
    { id: 3, name: 'é‰±å±±' },
    { id: 4, name: 'å·¥å ´' },
    { id: 5, name: 'éŠ€è¡Œ' },
    { id: 6, name: 'ç¥æ®¿' },
    { id: 7, name: 'é­”æ³•ä½¿ã„ã®å¡”' },
    { id: 8, name: 'å®‡å®™èˆ¹' },
    { id: 9, name: 'éŒ¬é‡‘è¡“å®¤' },
    { id: 10, name: 'ãƒãƒ¼ã‚¿ãƒ«' },
    { id: 11, name: 'ã‚¿ã‚¤ãƒ ãƒã‚·ãƒ³' },
    { id: 12, name: 'åç‰©è³ªå‡ç¸®å™¨' },
    { id: 13, name: 'ãƒ—ãƒªã‚ºãƒ ' },
    { id: 14, name: 'ãƒãƒ£ãƒ³ã‚¹ãƒ¡ãƒ¼ã‚«ãƒ¼' },
    { id: 15, name: 'è‡ªå·±ç„¡é™ç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³' },
    { id: 16, name: 'Javascriptã‚³ãƒ³ã‚½ãƒ¼ãƒ«' },
    { id: 17, name: 'éŠä¼‘å®‡å®™' },
    { id: 18, name: 'ã‚³ãƒ¼ãƒ†ãƒƒã‚¯ã‚¹ãƒ»ãƒ™ã‚¤ã‚«ãƒ¼' },
    { id: 19, name: 'ã‚ãªãŸ' }
];

// --- ãƒ˜ãƒ«ãƒ‘ãƒ¼: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸èª­ã¿æ›¸ã ---
function loadSettings() {
    try { const s = localStorage.getItem(LS_KEY); return s ? JSON.parse(s) : null; } catch (e) { return null; }
}
function saveSettings(obj) { try { localStorage.setItem(LS_KEY, JSON.stringify(obj)); } catch (e) { console.error('saveSettings', e); } }

// --- åˆæœŸè¨­å®š ---
const defaults = {
    n: 5,
    excluded: {}, // id:true means excluded
    autoPurchase: false,
    autoClick: false,
    autoGolden: false,
    autoReindeer: false, // â˜…æ–°æ©Ÿèƒ½â˜…
    bulkTradeState: 'sell', // 'sell' ã¾ãŸã¯ 'buy'
    soldSnapshot: {}, // å£²å´æ™‚ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
    panelOpen: false
};
const loaded = loadSettings() || {};
const state = Object.assign({}, defaults, loaded);

// --- å†…éƒ¨ãƒ©ãƒ³ã‚¿ã‚¤ãƒ çŠ¶æ…‹ï¼ˆè¿½åŠ æ©Ÿèƒ½ç”¨ãƒ»éä¿å­˜ï¼‰ ---
const runtime = {
    // 1) Frenzy(7x)+æ–½è¨­ãƒ–ãƒ¼ã‚¹ãƒˆ åŒæ™‚ç™ºç”Ÿæ¤œå‡ºç”¨
    duoActive: false, // ç¾åœ¨åŒæ™‚ç™ºç”Ÿä¸­ã‹ï¼ˆãƒ•ãƒ©ã‚°ï¼‰
    savedOnDetect: null, // æ¤œå‡ºæ™‚ç‚¹ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€æ–°ï¼‰
    copyVisible: false, // å·¦ä¸Šã€Œæ¤œå‡ºã—ã¾ã—ãŸï¼ ã‚³ãƒ”ãƒ¼ã€è¡¨ç¤ºãƒ•ãƒ©ã‚°
    // 2) MPå›å¾©ç›®å®‰è¡¨ç¤ºç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    lastMpText: 'æ®‹ã‚Š--åˆ†',
};


// --- UI è¦ç´  ---
const CSS = `
 #ccadv_root{font-family:Arial,Helvetica,sans-serif}
 #ccadv_btn{position:fixed;left:12px;bottom:12px;z-index:2147483646;background:#222;color:#fff;border-radius:6px;padding:8px 10px;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.5)}
 #ccadv_panel{position:fixed;left:12px;bottom:56px;z-index:2147483646;background:rgba(10,10,10,0.95);color:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.6);width:360px;max-width:calc(100vw - 24px)}
 #ccadv_panel .row{display:flex;align-items:center;justify-content:space-between}
 #ccadv_panel .small{font-size:12px;opacity:0.9}
 #ccadv_building_list{max-height:240px;overflow:auto;margin-top:8px;background:rgba(255,255,255,0.03);padding:6px;border-radius:6px}
 .ccadv_building_item{display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px}
 .ccadv_toplist{margin-top:8px}
 .ccadv_control{display:flex;gap:8px;align-items:center}
 .ccadv_btnsmall{background:transparent;border:1px solid rgba(255,255,255,0.12);padding:4px 8px;border-radius:6px;color:#fff;cursor:pointer}
 .ccadv_backbtn{background:transparent;border:1px solid rgba(255,255,255,0.12);padding:6px 8px;border-radius:6px;color:#fff;cursor:pointer;margin-right:8px}
 .ccadv_btnsmall:disabled{opacity:0.5;cursor:not-allowed}

 /* â–¼â–¼â–¼ è¿½åŠ æ©Ÿèƒ½CSS â–¼â–¼â–¼ */
 #ccadv_feature_bar{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:6px; margin-bottom: 8px;}
 #ccadv_topbar_left{min-height:22px;display:flex;align-items:center;gap:6px; font-size: 11px;}
 #ccadv_topbar_center{min-height:22px;flex:1;text-align:center; font-size: 11px; font-weight: bold;}
 #ccadv_topbar_right{min-height:22px;display:flex;gap:6px;align-items:center;justify-content:flex-end}
 /* â–²â–²â–² è¿½åŠ æ©Ÿèƒ½CSS â–²â–²â–² */
`;

// inject CSS
let style = document.getElementById('ccadv_style');
if (style) style.remove();
style = document.createElement('style');
style.id = 'ccadv_style';
style.textContent = CSS;
document.head.appendChild(style);

// root container (only once)
let root = document.getElementById('ccadv_root');
if (!root) { root = document.createElement('div');
    root.id = 'ccadv_root';
    document.body.appendChild(root); }

// settings button âš™ (only once)
let gear = document.getElementById('ccadv_btn');
if (!gear) {
    gear = document.createElement('button');
    gear.id = 'ccadv_btn';
    gear.title = 'Open CC Advanced Panel';
    gear.innerHTML = 'âš™';
    root.appendChild(gear);
    gear.addEventListener('click', () => { renderMainView(); panel.style.display = 'block'; state.panelOpen = true; saveSettings(state); });
}

// panel (create if needed)
let panel = document.getElementById('ccadv_panel');
if (!panel) {
    panel = document.createElement('div');
    panel.id = 'ccadv_panel';
    panel.style.display = state.panelOpen ? 'block' : 'none';
    document.body.appendChild(panel);
}

// â–¼â–¼â–¼ --- è¿½åŠ æ©Ÿèƒ½ãƒ˜ãƒ«ãƒ‘ãƒ¼ --- â–¼â–¼â–¼

// ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰æ›¸ãè¾¼ã¿ãƒ˜ãƒ«ãƒ‘ãƒ¼
async function writeToClipboard(text) {
    try {
        if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            return true;
        } else {
            // http: or fallback
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            return ok;
        }
    } catch (e) {
        console.error('Clipboard write failed', e);
        return false;
    }
}

// --- Frenzy7x + å»ºç‰©ãƒ–ãƒ¼ã‚¹ãƒˆæ¤œå‡ºï¼ˆRefactoringå¯¾å¿œãƒ»å®Œæˆç‰ˆï¼‰ ---
function hasFrenzy7x() {
    try {
        if (!window.Game || !Game.buffs) return false;
        for (const [id, buff] of Object.entries(Game.buffs)) {
            if (!buff || !buff.name) continue;
            if (buff.multCpS && Math.abs(buff.multCpS - 7) < 0.2) return true;
            if (/frenzy/i.test(buff.name) && buff.multCpS && buff.multCpS > 6) return true;
        }
    } catch (e) { console.warn("[DEBUG] hasFrenzy7x error", e); }
    return false;
}

function hasBuildingBoost() {
    try {
        if (!window.Game || !Game.buffs) return false;

        // ç¾è¡Œç‰ˆã®å»ºç‰©ãƒ–ãƒ¼ã‚¹ãƒˆåã‚’è¿½åŠ 
        const buildingBoostNames = [
            "High-five", "Conglomerate", "Luxurious", "Great loop",
            "Building special", "Elder frenzy (building boost)",
            "Refactoring" // â† ã“ã‚Œã‚’è¿½åŠ ï¼
        ];

        for (const [id, buff] of Object.entries(Game.buffs)) {
            if (!buff || !buff.name) continue;
            if (buildingBoostNames.some(n => buff.name.includes(n))) {
                console.log("[DEBUG] Building boost via name:", buff.name, buff);
                return true;
            }
            if (buff.buildingTie && buff.multCpS && buff.multCpS > 1) {
                console.log("[DEBUG] Building boost via buildingTie:", buff);
                return true;
            }
        }
    } catch (e) { console.warn("[DEBUG] hasBuildingBoost error", e); }
    return false;
}

function checkFrenzyBuildingCombo() {
    if (!window.Game || !Game.ready || !Game.buffs) return;

    const frenzy = hasFrenzy7x();
    const building = hasBuildingBoost();

    if (frenzy && building) {
        // åŒæ™‚ç™ºç”Ÿä¸­
        if (!runtime.duoActive) {
            // ğŸŸ¢ åˆå›æ¤œå‡ºï¼šã“ã“ã§ã‚»ãƒ¼ãƒ–ã‚’å›ºå®šä¿å­˜
            runtime.duoActive = true;
            runtime.savedOnDetect = Game.WriteSave(1);
            runtime.copyVisible = true;
            updateDetectUI();
            console.log("â˜…â˜… Frenzy7x + Building Boost åŒæ™‚ç™ºç”Ÿ detected! (ã‚»ãƒ¼ãƒ–å›ºå®š) â˜…â˜…");
        } else {
            // ğŸ”µ ã™ã§ã«æ¤œå‡ºæ¸ˆã¿ â†’ ä½•ã‚‚ã—ãªã„ï¼ˆã‚»ãƒ¼ãƒ–ã‚’ä¸Šæ›¸ãã—ãªã„ï¼‰
        }

    } else {
        // ğŸŸ  åŒæ™‚ç™ºç”ŸãŒçµ‚äº†ã—ãŸã‚‰ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆUIã¯ç¶­æŒï¼‰
        if (runtime.duoActive) {
            runtime.duoActive = false;
            console.log("[DEBUG] Frenzy+Boost çµ‚äº† - çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆï¼ˆUIä¿æŒï¼‰");
        }
    }
}




(function waitForGame() {
    const timer = setInterval(() => {
        if (window.Game && Game.ready) {
            clearInterval(timer);
            console.log("[DEBUG] âœ… Game loaded - monitoring buffs (Refactoringå¯¾å¿œç‰ˆ)");
            setInterval(checkFrenzyBuildingCombo, 2000);
        }
    }, 1000);
})();

// 2. MPå›å¾©ç›®å®‰ï¼ˆFtHoF + Diminish Ineptitude åˆè¨ˆã¾ã§ã®åˆ†æ•°ï¼‰
function computeMinutesToSumCost() {
    try {
        if (!window.Game || !Game.ObjectsById || !Game.ObjectsById[7] || !Game.ObjectsById[7].minigame) return null;

        const wiz = Game.ObjectsById[7];
        const n = wiz.amount || 0;
        const Lv = wiz.level || 1;

        // æœ€å¤§MP = floor(4 + n^0.6 + 15ln(1 + n/15 + (2/3)(Lv-1)))
        const maxMP = Math.floor(4 + Math.pow(n, 0.6) + 15 * Math.log(1 + n/15 + (2/3)*(Lv-1)));

        const minigame = wiz.minigame;
        const curMP = (minigame && typeof minigame.magic === 'number') ? minigame.magic : 0;

        // æ¶ˆè²»MP
        const costFtHoF = 10 + 0.6 * maxMP;
        const costDiminish = 5 + 0.2 * maxMP;
        const targetSum = costFtHoF + costDiminish; // = 15 + 0.8*maxMP

        // ç›®æ¨™ã¯ç†è«–ä¸Š targetSum ã ãŒã€MPã¯æœ€å¤§å€¤ã‚’è¶…ãˆãªã„ãŸã‚ã€å®Ÿéš›åˆ°é”å¯èƒ½ãªä¸Šé™ã¯ maxMP
        const target = Math.min(targetSum, maxMP);

        if (curMP >= target) return 0; // æ—¢ã«è¶³ã‚Šã¦ã„ã‚‹

        // å›å¾©é‡/ãƒ•ãƒ¬ãƒ¼ãƒ  = max(0.000004, (ç¾åœ¨MP / max(100, æœ€å¤§MP))^0.5 * 0.002)
        const M2 = Math.max(100, maxMP);
        const fps = Game.fps || 30;
        const rmin = 0.000004; // æœ€å°å›å¾©é‡
        const c = 0.002 / Math.sqrt(M2); // å›å¾©ä¿‚æ•°: dp/dt = c*sqrt(p)

        const p0 = curMP; // é–‹å§‹MP
        const pT = target; // ç›®æ¨™MP

        // å›å¾©ãƒ¬ãƒ¼ãƒˆãŒ rmin ã‹ã‚‰ c*sqrt(p) ã«åˆ‡ã‚Šæ›¿ã‚ã‚‹é–¾å€¤ p*
        // rmin = c * sqrt(pStar) => pStar = (rmin / c)^2
        const pStar = Math.pow(rmin / c, 2);

        let frames = 0;

        if (pT <= pStar) {
            // ç›®æ¨™MPãŒé–¾å€¤ä»¥ä¸‹ãªã‚‰ã€ãšã£ã¨æœ€å°å›å¾©
            frames = (pT - p0) / rmin;
        } else {
            if (p0 < pStar) {
                // é–¾å€¤æœªæº€ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
                // 1. p0 -> pStar (æœ€å°å›å¾©)
                frames += (pStar - p0) / rmin;
                // 2. pStar -> pT (å¤‰å‹•å›å¾©)
                // dt = dp / (c*sqrt(p)) ã®ç©åˆ† -> t = (2/c) * (sqrt(pT) - sqrt(pStar))
                frames += (2 / c) * (Math.sqrt(pT) - Math.sqrt(pStar));
            } else {
                // é–¾å€¤ä»¥ä¸Šã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
                // 1. p0 -> pT (å¤‰å‹•å›å¾©)
                frames += (2 / c) * (Math.sqrt(pT) - Math.sqrt(p0));
            }
        }

        if (!isFinite(frames) || frames < 0) return null;

        const minutes = (frames / fps) / 60;
        return Math.max(0, minutes);

    } catch(e){
        // è¨ˆç®—å¤±æ•—
        return null;
    }
}

function formatMinutes(mins) {
    if (mins == null) return 'æ®‹ã‚Š--åˆ†';
    if (mins <= 0) return 'æ®‹ã‚Š0åˆ†';
    // å°æ•°ç‚¹ä»¥ä¸‹1æ¡ã§è¡¨ç¤º
    return 'æ®‹ã‚Š' + mins.toFixed(1) + 'åˆ†';
}

// 3. UIæ›´æ–°ç”¨é–¢æ•°
function updateDetectUI() {
    const leftEl = document.getElementById('ccadv_topbar_left');
    if (!leftEl) return;

    if (runtime.copyVisible && runtime.savedOnDetect) {
        // è¡¨ç¤ºãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ãŠã‚Šã€ä¸­èº«ãŒãƒœã‚¿ãƒ³ã§ãªã‘ã‚Œã°ï¼ˆäºŒé‡æç”»é˜²æ­¢ï¼‰
        if (!leftEl.querySelector('#ccadv_detect_copy')) {
            leftEl.innerHTML = ''; // æ—¢å­˜ã®è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            const msg = document.createElement('span');
            msg.textContent = 'æ¤œå‡ºã—ã¾ã—ãŸï¼';
            const btn = document.createElement('button');
            btn.id = 'ccadv_detect_copy';
            btn.className = 'ccadv_btnsmall';
            btn.textContent = 'ã‚³ãƒ”ãƒ¼';
            btn.title = 'æ¤œå‡ºæ™‚ç‚¹ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼';

            btn.addEventListener('click', async () => {
                try {
                    if (runtime.savedOnDetect) {
                        const ok = await writeToClipboard(runtime.savedOnDetect);
                        if (ok) {
                            // ã‚³ãƒ”ãƒ¼æˆåŠŸã—ãŸã‚‰éè¡¨ç¤ºã«ã™ã‚‹
                            runtime.copyVisible = false;
                            updateDetectUI();
                        } else {
                            alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        }
                    }
                } catch(e) {
                    alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            });
            leftEl.appendChild(msg);
            leftEl.appendChild(btn);
        }
    } else {
        // è¡¨ç¤ºãƒ•ãƒ©ã‚°ãŒ false ãªã‚‰éè¡¨ç¤º
        leftEl.innerHTML = '';
    }
}

function updateMpUI() {
    const centerEl = document.getElementById('ccadv_topbar_center');
    if (!centerEl) return;

    const mins = computeMinutesToSumCost();
    const txt = formatMinutes(mins);

    // è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆãŒå¤‰åŒ–ã—ãŸå ´åˆã®ã¿DOMã‚’æ›´æ–°
    if (txt !== runtime.lastMpText) {
        runtime.lastMpText = txt;
        centerEl.textContent = txt;
    }
}

async function handleExportSave() {
    try {
        if (!window.Game || typeof Game.WriteSave !== 'function') return;
        let s = '';
        try {
            s = Game.WriteSave(1); // 1 = ç”Ÿãƒ‡ãƒ¼ã‚¿
        } catch(e) {
            s = localStorage.getItem('CookieClickerGame') || '';
        }

        const ok = await writeToClipboard(s);
        if (!ok) alert('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');

    } catch(e) {
        alert('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
}

// â–¼â–¼â–¼ ä¿®æ­£ç‚¹ 1: ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®å‹•ä½œã‚’å¤‰æ›´ â–¼â–¼â–¼
function handleImportSave() { // async ã‚’å‰Šé™¤
    try {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›ã«åŸºã¥ãã€Ctrl+O ã¨åŒã˜ã‚²ãƒ¼ãƒ æ¨™æº–ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
        if (window.Game && typeof Game.ImportSave === 'function') {
            Game.ImportSave();
        } else {
            alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚');
        }
    } catch(e) {
        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
}
// â–²â–²â–² ä¿®æ­£ç‚¹ 1 â–²â–²â–²

// â–²â–²â–² --- è¿½åŠ æ©Ÿèƒ½ãƒ˜ãƒ«ãƒ‘ãƒ¼ --- â–²â–²â–²


// We'll use view modes inside panel: 'main', 'filter', 'manualbuy'
function renderMainView() {
    panel.innerHTML = `
  <div style="display:flex;justify-content:space-between;align-items:flex-start;">
    <div style="font-weight:700;">CC ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒˆãƒ‘ãƒãƒ«</div>
    <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:flex-end;max-width:260px;">
      <label style="display:flex;align-items:center;gap:4px;font-size:11px;"><input type="checkbox" id="ccadv_autoPurchase"> è‡ªå‹•è³¼å…¥</label>
      <button id="ccadv_bulkTradeBtn" class="ccadv_btnsmall" style="padding: 3px 6px; font-size: 11px;">ä¸€æ‹¬å£²å´</button>
      <button id="ccadv_manual_buy" class="ccadv_btnsmall" style="padding: 3px 6px; font-size: 11px;">æ‰‹å‹•è³¼å…¥</button>
      <button id="ccadv_filter_toggle" class="ccadv_btnsmall" style="padding: 3px 6px; font-size: 11px;">ï¾Œï½¨ï¾™ï¾€ï½°</button>
      <button id="ccadv_close" class="ccadv_btnsmall" style="padding: 3px 6px; font-size: 11px;">âœ•</button>
    </div>
  </div>

  <div id="ccadv_feature_bar">
    <div id="ccadv_topbar_left">
      </div>
    <div id="ccadv_topbar_center">
      ${runtime.lastMpText}
    </div>
    <div id="ccadv_topbar_right">
      <button id="ccadv_export_btn" class="ccadv_btnsmall" title="ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ" style="padding: 3px 6px; font-size: 11px;">â†‘</button>
      <button id="ccadv_import_btn" class="ccadv_btnsmall" title="ã‚²ãƒ¼ãƒ ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã" style="padding: 3px 6px; font-size: 11px;">â†“</button>
    </div>
  </div>
  <div style="margin-top:8px;display:flex;align-items:center;gap:8px;">
    è¡¨ç¤ºæ•°: <button id="ccadv_minus" class="ccadv_btnsmall">âˆ’</button>
    <div id="ccadv_n" style="min-width:24px;text-align:center">${state.n}</div>
    <button id="ccadv_plus" class="ccadv_btnsmall">ï¼‹</button>
    <div style="flex:1"></div>
    <label style="display:flex;align-items:center;gap:4px;font-size:11px;"><input type="checkbox" id="ccadv_autoClick"> è‡ªå‹•ï½¸ï¾˜ï½¯ï½¸</label>
    <label style="display:flex;align-items:center;gap:4px;font-size:11px;"><input type="checkbox" id="ccadv_autoGolden"> è‡ªå‹•é‡‘ï½¸ï½¯ï½·ï½°</label>
    <label style="display:flex;align-items:center;gap:4px;font-size:11px;"><input type="checkbox" id="ccadv_autoReindeer"> è‡ªå‹•ï¾„ï¾…ï½¶ï½²</label>
    </div>
  <div id="ccadv_toplist" class="ccadv_toplist"></div>
  <div id="ccadv_building_list" class="ccadv_building_list" style="display:none"></div>
  <div class="small" style="margin-top:8px;opacity:0.95">â€» è¡¨ç¤ºå¯¾è±¡ã¯ç¾åœ¨æ‰€æŒã—ã¦ã„ã‚‹å»ºç‰©ã®ã¿ã€‚ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¸ˆã¿ã®å»ºç‰©ã¯è¡¨ç¤º/è‡ªå‹•è³¼å…¥ã®å¯¾è±¡å¤–ã«ãªã‚Šã¾ã™ã€‚</div>
 `;

    // wire elements
    const el = {
        close: document.getElementById('ccadv_close'),
        nDisplay: document.getElementById('ccadv_n'),
        plus: document.getElementById('ccadv_plus'),
        minus: document.getElementById('ccadv_minus'),
        filterToggle: document.getElementById('ccadv_filter_toggle'),
        toplist: document.getElementById('ccadv_toplist'),
        buildingList: document.getElementById('ccadv_building_list'),
        autoPurchase: document.getElementById('ccadv_autoPurchase'),
        autoClick: document.getElementById('ccadv_autoClick'),
        autoGolden: document.getElementById('ccadv_autoGolden'),
        autoReindeer: document.getElementById('ccadv_autoReindeer'), // â˜…æ–°æ©Ÿèƒ½â˜…
        bulkTradeBtn: document.getElementById('ccadv_bulkTradeBtn'),
        manualBuy: document.getElementById('ccadv_manual_buy'),
        // â–¼â–¼â–¼ NEW â–¼â–¼â–¼
        exportBtn: document.getElementById('ccadv_export_btn'),
        importBtn: document.getElementById('ccadv_import_btn')
        // â–²â–²â–² NEW â–²â–²â–²
    };

    // initialize control values from state
    el.nDisplay.textContent = state.n;
    el.autoPurchase.checked = !!state.autoPurchase;
    el.autoClick.checked = !!state.autoClick;
    el.autoGolden.checked = !!state.autoGolden;
    el.autoReindeer.checked = !!state.autoReindeer; // â˜…æ–°æ©Ÿèƒ½â˜…
    el.bulkTradeBtn.textContent = (state.bulkTradeState === 'buy') ? 'ä¸€æ‹¬è³¼å…¥' : 'ä¸€æ‹¬å£²å´';

    // â–¼â–¼â–¼ NEW â–¼â–¼â–¼
    // è¿½åŠ : æ¤œå‡ºUIã¨MPè¡¨ç¤ºåˆæœŸæ›´æ–°
    updateDetectUI();
    updateMpUI();

    // è¿½åŠ : ã‚»ãƒ¼ãƒ–å…¥å‡ºåŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
    el.exportBtn.addEventListener('click', handleExportSave);
    el.importBtn.addEventListener('click', handleImportSave); // ä¿®æ­£ã•ã‚ŒãŸ handleImportSave ã‚’å‘¼ã¶
    // â–²â–²â–² NEW â–²â–²â–²


    el.close.addEventListener('click', () => { panel.style.display = 'none';
        state.panelOpen = false;
        saveSettings(state); });
    gear.addEventListener('click', () => { panel.style.display = 'block';
        state.panelOpen = true;
        saveSettings(state); });
    el.plus.addEventListener('click', () => { if (state.n < 20) { state.n++;
            el.nDisplay.textContent = state.n;
            saveSettings(state); } });
    el.minus.addEventListener('click', () => { if (state.n > 1) { state.n--;
            el.nDisplay.textContent = state.n;
            saveSettings(state); } });

    el.autoPurchase.addEventListener('change', () => { state.autoPurchase = el.autoPurchase.checked;
        saveSettings(state); });
    el.autoClick.addEventListener('change', () => { state.autoClick = el.autoClick.checked;
        saveSettings(state);
        performAutoClick(state.autoClick); });
    el.autoGolden.addEventListener('change', () => { state.autoGolden = el.autoGolden.checked;
        saveSettings(state);
        performAutoGolden(state.autoGolden); });

    // â–¼â–¼â–¼ â˜…æ–°æ©Ÿèƒ½â˜… â–¼â–¼â–¼
    el.autoReindeer.addEventListener('change', () => { state.autoReindeer = el.autoReindeer.checked;
        saveSettings(state);
        performAutoReindeer(state.autoReindeer); });
    // â–²â–²â–² â˜…æ–°æ©Ÿèƒ½â˜… â–²â–²â–²

    el.bulkTradeBtn.addEventListener('click', () => {
        if (state.bulkTradeState === 'sell') {
            // --- å£²å´ãƒ­ã‚¸ãƒƒã‚¯ ---
            state.soldSnapshot = {}; // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
            // é™¤å¤–å¯¾è±¡: Cursor(0), Temple(6), Wizard Tower(7), You(19)
            const excludeIds = new Set([0, 6, 7, 19]);

            Game.ObjectsById.forEach(obj => {
                if (!obj) return;
                if (excludeIds.has(obj.id)) return; // é™¤å¤–å¯¾è±¡ã¯ã‚¹ã‚­ãƒƒãƒ—

                const amt = obj.amount;
                if (amt > 0) {
                    state.soldSnapshot[obj.id] = amt; // å£²å´é‡ã‚’ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã«ä¿å­˜
                    obj.sell(amt); // ç¾åœ¨ã®å…¨é‡ã‚’å£²å´
                }
            });

            // çŠ¶æ…‹ã¨ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œè³¼å…¥ã€ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
            state.bulkTradeState = 'buy';
            el.bulkTradeBtn.textContent = 'ä¸€æ‹¬è³¼å…¥';

        } else {
            // --- è³¼å…¥ãƒ­ã‚¸ãƒƒã‚¯ ---
            for (const id in state.soldSnapshot) {
                const obj = Game.ObjectsById[id];
                const targetAmount = state.soldSnapshot[id] || 0;
                if (!obj || targetAmount === 0) continue;

                const currentAmount = obj.amount;
                // ä¸è¶³åˆ†ã ã‘è³¼å…¥
                const needToBuy = Math.max(0, targetAmount - currentAmount);

                if (needToBuy > 0) {
                    obj.buy(needToBuy);
                }
            }

            // è³¼å…¥ãŒå®Œäº†ã—ãŸã‚‰ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
            state.soldSnapshot = {};

            // çŠ¶æ…‹ã¨ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œå£²å´ã€ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
            state.bulkTradeState = 'sell';
            el.bulkTradeBtn.textContent = 'ä¸€æ‹¬å£²å´';
        }

        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã¨ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆç©ºã®å ´åˆã‚‚ï¼‰ã‚’ä¿å­˜
        saveSettings(state);
    });

    el.manualBuy.addEventListener('click', () => { renderManualBuyView(); });
    el.filterToggle.addEventListener('click', () => { renderFilterView(); });

    // toggle quick building list display
    el.toplist.addEventListener('dblclick', () => {
        el.buildingList.style.display = el.buildingList.style.display === 'block' ? 'none' : 'block';
    });

    // initial render content
    computeAndRenderInto(el.toplist, el.buildingList);
}

function renderFilterView() {
    panel.innerHTML = `
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div style="font-weight:700;">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š</div>
    <div>
      <button id="ccadv_filter_back" class="ccadv_backbtn">æˆ»ã‚‹</button>
      <button id="ccadv_filter_save" class="ccadv_btnsmall">ä¿å­˜</button>
    </div>
  </div>
  <div id="ccadv_filter_list" style="max-height:300px;overflow:auto;margin-top:8px;padding:6px;background:rgba(255,255,255,0.03);border-radius:6px"></div>
 `;

    const listEl = document.getElementById('ccadv_filter_list');

    // render all buildings with checkbox
    BUILDING_META.forEach(b => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.gap = '8px';
        row.style.marginBottom = '6px';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = !!state.excluded[b.id];
        const lbl = document.createElement('div');
        lbl.textContent = b.name + ' (id:' + b.id + ')';
        lbl.style.flex = '1';
        row.appendChild(cb);
        row.appendChild(lbl);
        listEl.appendChild(row);
        cb.addEventListener('change', () => { state.excluded[b.id] = cb.checked; });
    });

    document.getElementById('ccadv_filter_back').addEventListener('click', () => { renderMainView(); });
    document.getElementById('ccadv_filter_save').addEventListener('click', () => { saveSettings(state);
        renderMainView(); });
}

// --- æ‰‹å‹•è³¼å…¥ãƒ“ãƒ¥ãƒ¼ ---
function renderManualBuyView() {
    panel.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:700;">æ‰‹å‹•è³¼å…¥</div>
        <div>
          <button id="ccadv_manual_back" class="ccadv_backbtn">æˆ»ã‚‹</button>
        </div>
      </div>
      <div style="display:grid; grid-template-columns: minmax(80px, 1fr) 135px 45px auto; align-items:center; font-size:10px; padding: 4px 0; border-bottom: 1px solid #444; gap: 4px;">
        <div style="grid-column: 1;">æ–½è¨­å</div>
        <div style="grid-column: 2; text-align:center;">è³¼å…¥æ•°</div>
        <div style="grid-column: 3; text-align:center;">è³¼å…¥å¾Œ</div>
        <div style="grid-column: 4; text-align:right;">å¿…è¦ã‚¯ãƒƒã‚­ãƒ¼</div>
      </div>
      <div id="ccadv_manual_list" style="max-height:280px; overflow-y:auto; overflow-x:hidden; margin-top:8px; padding:0 4px; background:rgba(255,255,255,0.03); border-radius:6px">
        </div>
      <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
        <button id="ccadv_manual_buy_all" class="ccadv_btnsmall" style="padding: 6px 12px;">ä¸€æ‹¬è³¼å…¥</button>
        <div style="text-align:right; font-size:12px;">
          åˆè¨ˆ: <span id="ccadv_manual_total_cost" style="font-weight:700; font-size: 14px;">0</span>
        </div>
      </div>
    `;

    const listEl = document.getElementById('ccadv_manual_list');
    const totalCostEl = document.getElementById('ccadv_manual_total_cost');
    const buyAllBtn = document.getElementById('ccadv_manual_buy_all');

    const buildingUIs = [];

    // ã‚³ã‚¹ãƒˆè¨ˆç®—ã¨UIæ›´æ–°
    function updateAllCosts() {
        let totalCost = 0;
        buildingUIs.forEach(ui => {
            const k = parseInt(ui.kInput.value) || 0;
            const obj = ui.obj;
            let cost = 0;
            const k_clamped = Math.max(0, k);
            if (k_clamped > 0) {
                // C(n, k) = Cn+1 * (1.15^k - 1) / 0.15
                cost = obj.price * (Math.pow(1.15, k_clamped) - 1) / 0.15;
            }
            ui.costEl.textContent = beautify(cost);
            if (ui.checkbox.checked) {
                totalCost += cost;
            }
        });
        totalCostEl.textContent = beautify(totalCost);
    }

    // æ–½è¨­ãƒªã‚¹ãƒˆã®ç”Ÿæˆ
    BUILDING_META.forEach(b => {
        const obj = (window.Game && Game.ObjectsById) ? Game.ObjectsById[b.id] : null;
        if (!obj) return;

        const currentAmount = obj.amount;

        const row = document.createElement('div');
        row.style.display = 'grid';
        row.style.gridTemplateColumns = 'minmax(80px, 1fr) 135px 45px auto'; // ãƒ˜ãƒƒãƒ€ãƒ¼ã¨åˆã‚ã›ã‚‹
        row.style.alignItems = 'center';
        row.style.gap = '4px';
        row.style.padding = '4px 0';
        row.style.borderBottom = '1px solid rgba(255,255,255,0.05)';

        // --- 1. æ–½è¨­å ---
        const nameDiv = document.createElement('div');
        nameDiv.style.display = 'flex';
        nameDiv.style.alignItems = 'center';
        nameDiv.style.gap = '4px';
        nameDiv.style.fontSize = '12px';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.dataset.id = b.id;
        nameDiv.appendChild(checkbox);
        nameDiv.appendChild(document.createTextNode(b.name));

        // --- 2. è³¼å…¥æ•° ---
        const kControlsDiv = document.createElement('div');
        kControlsDiv.style.display = 'flex';
        kControlsDiv.style.alignItems = 'stretch';
        kControlsDiv.style.gap = '1px';
        kControlsDiv.style.width = '100%';
        kControlsDiv.style.boxSizing = 'border-box';

        const kInput = document.createElement('input');
        kInput.type = 'number';
        kInput.value = '0';
        kInput.style.width = '30px';
        kInput.style.textAlign = 'center';
        kInput.style.background = '#111';
        kInput.style.color = '#fff';
        kInput.style.border = '1px solid #555';
        kInput.style.fontSize = '10px';
        kInput.style.padding = '2px 0';
        kInput.style.flex = '1 1 30px';
        kInput.style.boxSizing = 'border-box';

        const kButtons = [-100, -10, -1, 1, 10, 100].map(val => {
            const btn = document.createElement('button');
            btn.textContent = val > 0 ? ('+' + val) : String(val);
            btn.className = 'ccadv_btnsmall';
            btn.style.padding = '2px 0';
            btn.style.fontSize = '9px';
            btn.style.flex = '1 0 16px';
            return { btn, val };
        });

        kControlsDiv.appendChild(kButtons[0].btn); // -100
        kControlsDiv.appendChild(kButtons[1].btn); // -10
        kControlsDiv.appendChild(kButtons[2].btn); // -1
        kControlsDiv.appendChild(kInput);
        kControlsDiv.appendChild(kButtons[3].btn); // +1
        kControlsDiv.appendChild(kButtons[4].btn); // +10
        kControlsDiv.appendChild(kButtons[5].btn); // +100

        // --- 3. è³¼å…¥å¾Œåˆè¨ˆ ---
        const totalInput = document.createElement('input');
        totalInput.type = 'number';
        totalInput.value = currentAmount;
        totalInput.style.width = '100%';
        totalInput.style.textAlign = 'center';
        totalInput.style.background = '#111';
        totalInput.style.color = '#fff';
        totalInput.style.border = '1px solid #555';
        totalInput.style.fontSize = '10px';
        totalInput.style.padding = '2px 0';
        totalInput.style.boxSizing = 'border-box';

        // --- 4. ã‚³ã‚¹ãƒˆ ---
        const costDiv = document.createElement('div');
        costDiv.style.textAlign = 'right';
        costDiv.style.fontSize = '10px';
        costDiv.style.wordBreak = 'break-all';

    // --- DOMã«è¿½åŠ  ---
        row.appendChild(nameDiv);       // col 1
        row.appendChild(kControlsDiv);  // col 2
        row.appendChild(totalInput);    // col 3
        row.appendChild(costDiv);       // col 4
        listEl.appendChild(row);

        const ui = {
            id: b.id,
            obj: obj,
            checkbox: checkbox,
            kInput: kInput,
            totalInput: totalInput,
            costEl: costDiv
        };
        buildingUIs.push(ui);

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        const updateFromK = () => {
            let k = parseInt(kInput.value) || 0;
            if (k < 0) { // è³¼å…¥å°‚ç”¨ã®ãŸã‚ãƒã‚¤ãƒŠã‚¹ã¯0ã«ã™ã‚‹
                k = 0;
                kInput.value = '0';
            }
            const current = Game.ObjectsById[b.id].amount; // æœ€æ–°ã®ä¿æœ‰æ•°ã‚’å–å¾—
            totalInput.value = current + k;
            updateAllCosts();
        };

        const updateFromTotal = () => {
            let total = parseInt(totalInput.value) || 0;
            const current = Game.ObjectsById[b.id].amount;
            if (total < current) { // ç¾åœ¨ä¿æœ‰æ•°ã‚ˆã‚Šå°‘ãªãã¯ã§ããªã„
                total = current;
                totalInput.value = total;
            }
            kInput.value = total - current;
            updateAllCosts();
        };

        kInput.addEventListener('input', updateFromK);
        totalInput.addEventListener('input', updateFromTotal);
        checkbox.addEventListener('change', updateAllCosts);

        kButtons.forEach(item => {
            item.btn.addEventListener('click', () => {
                let currentK = parseInt(kInput.value) || 0;
                kInput.value = Math.max(0, currentK + item.val); // 0æœªæº€ã«ãªã‚‰ãªã„ã‚ˆã†ã«
                updateFromK();
            });
        });
    });

    // åˆæœŸã‚³ã‚¹ãƒˆè¨ˆç®—
    updateAllCosts();

    // æˆ»ã‚‹ãƒœã‚¿ãƒ³
    document.getElementById('ccadv_manual_back').addEventListener('click', () => { renderMainView(); });

    // ä¸€æ‹¬è³¼å…¥ãƒœã‚¿ãƒ³
    buyAllBtn.addEventListener('click', () => {
        buildingUIs.forEach(ui => {
            if (ui.checkbox.checked) {
                const k = parseInt(ui.kInput.value) || 0;
                if (k > 0) {
                    Game.ObjectsById[ui.id].buy(k);
                }
            }
        });

        // è³¼å…¥å¾Œã€UIã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
        buildingUIs.forEach(ui => {
            ui.kInput.value = '0';
            ui.totalInput.value = Game.ObjectsById[ui.id].amount;
            ui.checkbox.checked = false;
        });
        updateAllCosts();

        // ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ã®ãƒªã‚¹ãƒˆã‚‚æ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ã«ãƒˆãƒªã‚¬ãƒ¼
        const toplistEl = document.getElementById('ccadv_toplist');
        const buildingListEl = document.getElementById('ccadv_building_list');
        if (toplistEl && buildingListEl) {
            computeAndRenderInto(toplistEl, buildingListEl);
        }
    });
}

// CPS extraction helpers
function parseNumberFromString(s) {
    if (!s) return NaN;
    s = String(s).replace(/,/g, '');
    const m = s.match(/([0-9]+\.?[0-9]*(?:e[+\-]?[0-9]+)?)/i);
    if (m) return parseFloat(m[1]);
    return NaN;
}

function getDisplayedCpsForBuilding(id) {
    try {
        let tooltipText = '';
        if (window.Game && Game.ObjectsById && Game.ObjectsById[id]) {
            const obj = Game.ObjectsById[id];
            if (typeof obj.tooltip === 'function') {
                tooltipText = obj.tooltip();
            }
        }
        if (!tooltipText) {
            const elProd = document.getElementById('product' + id);
            if (elProd) {
                tooltipText = elProd.getAttribute('onmouseover') || elProd.getAttribute('title') || elProd.title || '';
            }
        }
        if (tooltipText) {
            const plainText = tooltipText.replace(/<[^>]*>/g, ' ');
            let match = plainText.match(/æ¯ç§’\s*([0-9.,eE+\-]+)/);
            if (match && match[1]) {
                return parseNumberFromString(match[1]);
            }
            match = plainText.match(/([0-9.,eE+\-]+)\s*(cookies per second|per second|\/s|ç§’ã‚ãŸã‚Š)/i);
            if (match && match[1]) {
                return parseNumberFromString(match[1]);
            }
        }
        if (window.Game && Game.CalculateGains) {
            const base = Game.cookiesPs;
            const obj = Game.ObjectsById[id];
            if (!obj) return NaN;
            const orig = obj.amount;
            obj.amount = orig + 1;
            Game.CalculateGains();
            const after = Game.cookiesPs;
            obj.amount = orig;
            Game.CalculateGains();
            const delta = after - base;
            if (isFinite(delta) && delta > 0) return delta;
        }
    } catch (e) { console.error('getDisplayedCpsForBuilding error for id', id, e); }
    const obj = Game.ObjectsById[id];
    if (obj && obj.storedTotalCps && Game.cookiesPs > 0) {
        return obj.storedTotalCps / obj.amount;
    }
    return NaN;
}

// å˜ä½ãƒªã‚¹ãƒˆ (1e6, 1e9, 1e12, ...)
const NUMBER_UNITS = [
    'million', 'billion', 'trillion', 'quadrillion', 'quintillion',
    'sextillion', 'septillion', 'octillion', 'nonillion', 'decillion',
    'undecillion', 'duodecillion', 'tredecillion', 'quattuordecillion',
    'quindecillion', 'sexdecillion', 'septendecillion', 'octodecillion',
    'novemdecillion', 'vigintillion'
];

function beautify(n) {
    if (!isFinite(n) || n === null || n === undefined) return String(n);

    // 1 million (1e6) æœªæº€
    if (Math.abs(n) < 1e6) {
        // 1e6æœªæº€ã¯å°æ•°ç‚¹ä»¥ä¸‹3æ¡ã§è¡¨ç¤º
        return n.toFixed(3);
    }

    // n (1e6) ã‚’åŸºæº– (index 0) ã¨ã—ã¦ã€æŒ‡æ•°ã‚’è¨ˆç®—
    // 1e6 (million) ã®æŒ‡æ•°ã¯ 6
    const exponent = Math.floor(Math.log10(Math.abs(n)));

    // å˜ä½ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
    // ä¾‹: 1e6 (exp 6) -> unitIndex = floor(6/3) - 2 = 2 - 2 = 0 (million)
    // ä¾‹: 1e8 (exp 8) -> unitIndex = floor(8/3) - 2 = 2 - 2 = 0 (million)
    // ä¾‹: 1e9 (exp 9) -> unitIndex = floor(9/3) - 2 = 3 - 2 = 1 (billion)
    const unitIndex = Math.floor(exponent / 3) - 2;

    if (unitIndex < 0) { // 1e6 æœªæº€ (ã“ã®ãƒ‘ã‚¹ã«ã¯æ¥ãªã„ã¯ãšã ãŒå¿µã®ãŸã‚)
         return n.toFixed(3);
    }

    if (unitIndex >= NUMBER_UNITS.length) {
        // vigintillion (1e63) ã‚’è¶…ãˆã‚‹å ´åˆ
        // (1e66 -> exp 66 -> index 20)
        return n.toExponential(3); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ e+ è¡¨è¨˜
    }

    // è©²å½“ã™ã‚‹å˜ä½ã§å‰²ã‚‹
    // ä¾‹: unitIndex 0 (million) -> 10^((0+2)*3) = 1e6
    const divisor = Math.pow(10, (unitIndex + 2) * 3);
    const dividedValue = n / divisor;

    return dividedValue.toFixed(3) + ' ' + NUMBER_UNITS[unitIndex];
}


// --- main loop: æ¯ç§’è¨ˆç®—ã—ã¦è¡¨ç¤º & è‡ªå‹•è³¼å…¥ãªã© ---
let autoClickInterval = null;
if (state.autoClick) performAutoClick(true);
if (state.autoGolden) performAutoGolden(true);
if (state.autoReindeer) performAutoReindeer(true); // â˜…æ–°æ©Ÿèƒ½â˜…

function performAutoClick(enable) {
    if (autoClickInterval) { clearInterval(autoClickInterval);
        autoClickInterval = null; }
    if (enable) {
        autoClickInterval = setInterval(() => { try { if (window.Game && Game.ClickCookie) Game.ClickCookie(); } catch (e) {} }, 50);
    }
}

function performAutoGolden(enable) {
    if (enable) {
        if (!window.__ccadv_golden_interval) {
            window.__ccadv_golden_interval = setInterval(() => {
                try {
                    if (!window.Game || !Game.shimmers) return;
                    for (let i in Game.shimmers) { const s = Game.shimmers[i]; if (s && s.type === 'golden') { try { s.pop(); } catch (e) {} } }
                } catch (e) {}
            }, 100);
        }
    } else {
        if (window.__ccadv_golden_interval) { clearInterval(window.__ccadv_golden_interval);
            window.__ccadv_golden_interval = null; }
    }
}

// â–¼â–¼â–¼ â˜…æ–°æ©Ÿèƒ½â˜… â–¼â–¼â–¼
function performAutoReindeer(enable) {
    if (enable) {
        if (!window.__ccadv_reindeer_interval) {
            // 0.5ç§’é–“éš” (500ms)
            window.__ccadv_reindeer_interval = setInterval(() => {
                try {
                    if (!window.Game || !Game.shimmers) return;
                    for (let i in Game.shimmers) {
                        const s = Game.shimmers[i];
                        if (s && s.type === 'reindeer') {
                            try { s.pop(); } catch (e) {}
                        }
                    }
                } catch (e) {}
            }, 500);
        }
    } else {
        if (window.__ccadv_reindeer_interval) { clearInterval(window.__ccadv_reindeer_interval);
            window.__ccadv_reindeer_interval = null; }
    }
}
// â–²â–²â–² â˜…æ–°æ©Ÿèƒ½â˜… â–²â–²â–²


function computeAndRenderInto(toplistEl, buildingListEl) {
    try {
        if (typeof Game === 'undefined' || !Game.ObjectsById) return;
        // collect owned buildings
        let owned = Game.ObjectsById.filter(o => o && o.amount > 0).map(o => ({ id: o.id, obj: o }));
        if (owned.length === 0) { toplistEl.innerHTML = '<div>ã¾ã è³¼å…¥æ¸ˆã¿ã®æ–½è¨­ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>'; return; }

        // sort by price descending and take top N by price among owned
        owned.sort((a, b) => (b.obj.price || 0) - (a.obj.price || 0));
        let candidates = owned.slice(0, Math.max(state.n, owned.length));

        const list = [];
        for (const c of candidates) {
            const id = c.id;
            if (state.excluded[id]) continue; // exclude
            const obj = c.obj;
            const price = obj.price;
            const displayedCps = getDisplayedCpsForBuilding(id);
            if (!isFinite(displayedCps) || displayedCps <= 0) continue;
            const score = price > 0 ? displayedCps / price : Infinity;
            list.push({ id, name: BUILDING_META[id] ? BUILDING_META[id].name : obj.name, price, cps: displayedCps, score, amount: obj.amount });
        }
        list.sort((a, b) => b.score - a.score);

        // render toplist
        let html = '<div style="font-weight:700;margin-bottom:6px;">ä¸Šä½ ' + Math.min(state.n, list.length) + ' ä»¶ï¼ˆè‡ªå‹•è³¼å…¥ã¯æœ‰åŠ¹ãªå»ºç‰©ã®ã¿å¯¾è±¡ï¼‰</div>';
        html += '<ol style="margin:6px 0 0 18px;padding:0;">';
        for (let i = 0; i < Math.min(state.n, list.length); i++) {
            const r = list[i];
            // (ã‚³ã‚¹ãƒ‘ã® e+ è¡¨ç¤ºã¯ã€éå¸¸ã«å°ã•ã„æ•°å€¤ã«ãªã‚‹ãŸã‚ä»•æ§˜é€šã‚Šã¨ã—ã¦æ®‹ã—ã¾ã™)
            html += `<li style="margin-bottom:6px;display:flex;align-items:center;gap:8px"><div style="flex:1"><b>${r.name}</b><div class="small">ä¾¡æ ¼:${beautify(r.price)} / CPS:${beautify(r.cps)} / ã‚³ã‚¹ãƒ‘:${r.score.toExponential(3)} (æ‰€æŒ:${r.amount})</div></div></li>`;
        }
        html += '</ol>';
        toplistEl.innerHTML = html;

        // render building list (owned)
        buildingListEl.innerHTML = '';
        for (const o of Game.ObjectsById) {
            if (!o) continue;
            if (o.amount <= 0) continue;
            const bmeta = BUILDING_META[o.id] || { name: o.name };
            const row = document.createElement('div');
            row.className = 'ccadv_building_item';
            const name = document.createElement('div');
            name.style.flex = '1';
            name.innerHTML = `<b>${bmeta.name}</b> <div class='small'>æ‰€æŒ:${o.amount} ä¾¡æ ¼:${beautify(o.price)}</div>`;
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.checked = !!state.excluded[o.id];
            cb.title = 'ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆé™¤å¤–ï¼‰ã•ã‚Œã¾ã™';
            cb.addEventListener('change', () => { state.excluded[o.id] = cb.checked;
                saveSettings(state);
                computeAndRenderInto(toplistEl, buildingListEl); });
            row.appendChild(cb);
            row.appendChild(name);
            buildingListEl.appendChild(row);
        }

        // auto-purchase: buy top of list if affordable
        if (state.autoPurchase && list.length > 0) {
            const top = list[0];
            if (Game.cookies >= top.price) {
                try {
                    Game.ObjectsById[top.id].buy(1);
                    saveSettings(state);
                    // recompute now synchronously
                    computeAndRenderInto(toplistEl, buildingListEl);
                    return;
                } catch (e) { console.error('auto buy failed', e); }
            }
        }

    } catch (e) { console.error('computeAndRenderInto', e); }
}

// start main loop
let mainLoopInterval = null;

function startMainLoop() {
    if (mainLoopInterval) clearInterval(mainLoopInterval);
    mainLoopInterval = setInterval(() => {
        const toplistEl = document.getElementById('ccadv_toplist');
        const buildingListEl = document.getElementById('ccadv_building_list');
        if (toplistEl && panel.style.display === 'block') {
             computeAndRenderInto(toplistEl, buildingListEl);
        }

        // â–¼â–¼â–¼ NEW â–¼â–¼â–¼
        // MPè¡¨ç¤ºæ›´æ–°ï¼ˆæ¯ç§’ï¼‰
        updateMpUI();
        // â–²â–²â–² NEW â–²â–²â–²

    }, 1000);
}
startMainLoop();

// â–¼â–¼â–¼ NEW â–¼â–¼â–¼
// è¿½åŠ : Frenzy(7x) + æ–½è¨­ãƒ–ãƒ¼ã‚¹ãƒˆåŒæ™‚ç™ºç”Ÿãƒã‚§ãƒƒã‚¯ï¼ˆé«˜é »åº¦ï¼‰
let detectInterval = null;
function startDetectLoop() {
    if (detectInterval) clearInterval(detectInterval);
    // 250msã”ã¨ã«ãƒãƒ•çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    detectInterval = setInterval(() => {
        checkFrenzyBuildingCombo();
        // ãƒ‘ãƒãƒ«è¡¨ç¤ºä¸­ã®ã¿UIåæ˜ 
        if (panel.style.display === 'block') {
            updateDetectUI();
        }
    }, 250);
}
startDetectLoop();
// â–²â–²â–² NEW â–²â–²â–²


// react to localStorage changes
window.addEventListener('storage', (ev) => {
    if (ev.key === LS_KEY) {
        const s = loadSettings();
        if (s) {
            Object.assign(state, s);
            startMainLoop();
            performAutoClick(state.autoClick);
            performAutoGolden(state.autoGolden);
            performAutoReindeer(state.autoReindeer); // â˜…æ–°æ©Ÿèƒ½â˜…
        }
    }
});

// periodic save
setInterval(() => saveSettings(state), 5000);

// initial render
renderMainView();
})();
