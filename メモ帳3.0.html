<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¡ãƒ¢å¸³ 4.3 æ”¹</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* --- åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
    html, body { height: 100%; margin: 0; padding: 0 18px 18px 18px; box-sizing: border-box; }
    body { display: flex; flex-direction: column; font-family: sans-serif; }
    
    /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ & ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« --- */
    .header-bar { display: flex; gap: 10px; margin-top: 10px; margin-bottom: 5px; }
    #page-title { flex: 1; padding: 5px; font-weight: bold; border: 1px solid #ccc; }
    
    .controls { flex: 0 0 auto; margin-bottom: 10px; position: relative; display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
    .controls button, .controls input, .controls select { padding: 7px 7px; font-size: 12px; }
    
    /* --- ã‚¨ãƒ‡ã‚£ã‚¿ã‚¨ãƒªã‚¢ --- */
    #editor-container { flex: 1; position: relative; border: 1px solid #ccc; overflow: hidden; }
    #memo { width: 100%; height: 100%; box-sizing: border-box; padding: 10px; overflow: auto; white-space: pre-wrap; font-family: monospace; outline: none; }
    #code-editor { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: none; }
    
    /* --- ã‚¹ã‚¿ã‚¤ãƒ«è£…é£¾ --- */
    .highlight { background-color: yellow; }
    
    /* --- è¨­å®šãƒ‘ãƒãƒ« --- */
    #settings-panel { display: none; position: fixed; top: 0; left: 0; width: 320px; height: 100%; background: #f9f9f9; border-right: 1px solid #ccc; z-index: 2000; box-shadow: 2px 0 5px rgba(0,0,0,0.1); padding: 15px; overflow-y: auto; }
    #settings-panel.open { display: block; }
    .panel-header { display: flex; justify-content: flex-end; margin-bottom: 20px; }
    .panel-close { cursor: pointer; font-weight: bold; font-size: 18px; }
    #expand-btn { display: none; position: fixed; top: 10px; left: 10px; z-index: 3000; padding: 10px 15px; font-weight: bold; background: #fff; border: 2px solid #333; cursor: pointer; }

    /* --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»ç”»é¢å…±é€š --- */
    .menu-btn { width: 100%; padding: 10px; text-align: left; margin-bottom: 5px; cursor: pointer; background: #fff; border: 1px solid #ddd; }
    .menu-btn:hover { background: #eee; }
    .screen { display: none; }
    .screen.active { display: block; }
    .back-btn { margin-bottom: 10px; }
    .row { margin-bottom: 10px; }
    .row label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 12px; }
    .row input[type="text"] { width: 100%; padding: 5px; box-sizing: border-box; }
    
    .item-list { border: 1px solid #eee; padding: 5px; max-height: 350px; overflow-y: auto; margin-bottom: 10px; background: #fff; }
    .item { padding: 8px 5px; cursor: pointer; display: flex; align-items: center; border-bottom: 1px solid #f0f0f0; user-select: none; }
    .item:hover { background: #eef; }
    .item.selected { background: #ddf; border-left: 3px solid blue; }
    /* ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ç”¨ */
    .item.drag-over { border-top: 2px solid blue; }
    .item.drag-over-folder { background-color: #ffeeb0; border: 2px dashed orange; }

    .folder-icon { color: #dcb028; margin-right: 5px; }
    .memo-icon { color: #555; margin-right: 5px; }
    
    /* å¤‰æ›ç”»é¢ç”¨ */
    .transform-options { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
    .transform-options label { display: flex; align-items: center; font-size: 13px; }

    /* å€™è£œç·¨é›†ãƒªã‚¹ãƒˆç”¨ */
    .candidate-edit-row { display: flex; flex-wrap: wrap; gap: 3px; align-items: center; padding: 5px 0; border-bottom: 1px solid #ddd; }
    .candidate-edit-row input { flex: 1; min-width: 80px; font-size: 11px; padding: 3px; }
    .candidate-edit-row button { padding: 2px 6px; font-size: 11px; }

    #count { min-width: 40px; text-align: center; display: inline-block; font-size: 12px; }
    .status-msg { font-size: 10px; color: blue; margin-top: 5px; }
  </style>
</head>
<body>
  <div class="header-bar">
    <input type="text" id="page-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®š">
  </div>

  <button id="expand-btn">â¤¢ å±•é–‹ (å…ƒã«æˆ»ã™)</button>

  <div id="settings-panel">
    <div class="panel-header"><span class="panel-close">â˜’</span></div>
    
    <div id="menu-screen" class="screen active">
      <button class="menu-btn" id="btn-editor-mode">ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¢ãƒ¼ãƒ‰ ã‚ªãƒ³</button>
      <button class="menu-btn" id="btn-transform">å¤‰æ›</button>
      <button class="menu-btn" id="btn-pc-view">PCè¡¨ç¤º</button>
      <button class="menu-btn" id="btn-import">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <button class="menu-btn" id="btn-export">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="menu-btn" id="btn-memo-list">ãƒ¡ãƒ¢ä¸€è¦§</button>
      <button class="menu-btn" id="btn-memo-save">ãƒ¡ãƒ¢ä¿å­˜</button>
      <hr>
      <div style="font-size:11px; color:#666; margin-bottom:5px;">â€»APIè¨­å®šã¯æ‹¡å¼µæ©Ÿèƒ½ã§è¡Œã£ã¦ãã ã•ã„</div>
      <button class="menu-btn" id="btn-gh-connect">è¨­å®šå†èª­ã¿è¾¼ã¿</button>
      <div id="gh-status" class="status-msg"></div>
    </div>

    <div id="transform-screen" class="screen">
      <button class="back-btn">â†æˆ»ã‚‹</button>
      <h3>å¤‰æ›</h3>
      <div class="transform-options">
        <label><input type="radio" name="trans-type" value="encode" checked> ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ (URL)</label>
        <label><input type="radio" name="trans-type" value="decode"> ãƒ‡ã‚³ãƒ¼ãƒ‰ (URL)</label>
        <label><input type="radio" name="trans-type" value="remove-comment"> ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤ (//)</label>
        <label><input type="radio" name="trans-type" value="custom"> ã‚«ã‚¹ã‚¿ãƒ </label>
        <label style="margin-left:20px; color:#555;"><input type="checkbox" id="chk-one-line"> æ”¹è¡Œã‚’å‰Šé™¤ã—ã¦1è¡Œã«ã™ã‚‹</label>
      </div>
      
      <div class="row" style="margin-top:10px;"><label>å¤‰æ›å…ƒ (ã‚«ã‚¹ã‚¿ãƒ ç”¨)</label><input type="text" id="trans-from"></div>
      <div class="row"><label>å¤‰æ›å…ˆ (ã‚«ã‚¹ã‚¿ãƒ ç”¨)</label><input type="text" id="trans-to"></div>
      
      <div style="display:flex; justify-content:space-between; margin-top:15px;">
        <button id="do-confirm-transform">ç¢ºèª (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼)</button>
        <button id="do-transform" style="font-weight:bold;">å¤‰æ›å®Ÿè¡Œ</button>
      </div>
    </div>

    <div id="import-screen" class="screen">
      <button class="back-btn">â†æˆ»ã‚‹</button>
      <h3>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
      <div class="row"><label>URL</label><input type="text" id="import-url" placeholder="GitHub Raw / ãƒªãƒã‚¸ãƒˆãƒª / ã‚µã‚¤ãƒˆURL"></div>
      <div style="display:flex; justify-content:space-between; margin-bottom:15px; flex-wrap: wrap; gap:5px;">
        <button id="do-import-url">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <button id="btn-import-file">ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰</button>
        <input type="file" id="file-input" style="display:none">
        <button id="btn-candidates">å€™è£œ</button>
      </div>
    </div>

    <div id="candidate-view-screen" class="screen">
      <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
         <button class="back-btn" data-target="import-screen">â†æˆ»ã‚‹</button>
         <button id="btn-cand-edit-mode">ç·¨é›†</button>
      </div>
      <h3>å€™è£œä¸€è¦§</h3>
      <div id="candidate-list-view" class="item-list"></div>
    </div>

    <div id="candidate-edit-screen" class="screen">
      <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
         <button id="cand-edit-back">â†æˆ»ã‚‹</button>
         <button id="cand-save-sync" style="background:gold;">ä¿å­˜</button>
      </div>
      <h3>å€™è£œç·¨é›†</h3>
      <div style="font-size:10px; color:#666; margin-bottom:5px;">å€™è£œå | URL | è¿½åŠ /å‰Šé™¤/ç§»å‹•</div>
      <div id="candidate-list-edit" class="item-list" style="height:350px;"></div>
    </div>

    <div id="export-screen" class="screen">
      <button class="back-btn">â†æˆ»ã‚‹</button>
      <h3>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
      <div class="row"><label>ãƒ•ã‚¡ã‚¤ãƒ«å</label><input type="text" id="export-name" placeholder="memo"></div>
      <div class="row"><label>æ‹¡å¼µå­</label><input type="text" id="export-ext" placeholder="txt"></div>
      <button id="do-export">ä¿å­˜</button>
    </div>

    <div id="list-screen" class="screen">
      <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <button class="back-btn">â†æˆ»ã‚‹</button>
        <button id="btn-edit-mode">ç·¨é›†</button>
      </div>
      <h3>ãƒ¡ãƒ¢ä¸€è¦§</h3>
      <div id="memo-tree-view" class="item-list">Loading...</div>
      
      <div style="margin-top:15px; font-weight:bold; font-size:12px;">ä¸€æ™‚ãƒ¡ãƒ¢</div>
      <div id="temp-memo-view" class="item" style="border:1px solid #ccc; background:#fff;">
        <span class="memo-icon">ğŸ“‹ï¸</span> ä¸€æ™‚ãƒ¡ãƒ¢
      </div>
    </div>

    <div id="list-edit-ui" class="screen">
       <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <button id="list-edit-back">â†æˆ»ã‚‹</button>
          <button id="list-edit-save" style="background:gold;">ä¿å­˜</button>
       </div>
       <h3>ç·¨é›†ä¸­</h3>
       <div style="font-size:11px; color:blue; margin-bottom:5px;">â€»ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ç§»å‹•å¯èƒ½ã§ã™</div>
       <div id="memo-tree-edit" class="item-list" style="min-height:200px;"></div>
       
       <div id="edit-controls" style="display:none; padding:10px; background:#eee; margin-top:5px; border-top:1px solid #ccc;">
          <div style="display:flex; gap:5px; margin-bottom:5px;">
             <button id="edit-copy">ã‚³ãƒ”ãƒ¼</button>
             <button id="edit-del" style="color:red;">å‰Šé™¤</button>
             <button id="edit-enter-folder" style="display:none;">â†’ä¸‹ã®éšå±¤ã¸</button>
          </div>
          <div style="display:flex; gap:5px;">
             <input type="text" id="edit-rename-input" placeholder="åå‰å¤‰æ›´">
             <button id="edit-rename-apply">å¤‰æ›´</button>
          </div>
       </div>

       <div class="row" style="border-top:1px solid #eee; padding-top:10px; margin-top:15px;">
        <label>ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ (ç¾åœ¨ã®éšå±¤)</label>
        <div style="display:flex; gap:5px;">
          <input type="text" id="new-folder-name-edit" placeholder="ãƒ•ã‚©ãƒ«ãƒ€å">
          <button id="create-folder-edit">ä½œæˆ</button>
        </div>
      </div>
    </div>

    <div id="save-screen" class="screen">
      <button class="back-btn">â†æˆ»ã‚‹</button>
      <h3>ãƒ¡ãƒ¢ä¿å­˜</h3>
      <div class="row"><label>ã‚¿ã‚¤ãƒˆãƒ«å</label><input type="text" id="save-title"></div>
      <div class="row"><label>ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</label>
        <div id="save-tree-view" class="item-list"></div>
      </div>
      <div style="display:flex; justify-content:space-between;">
        <button id="do-save-memo">ä¿å­˜</button>
        <button id="do-save-temp">ä¸€æ™‚ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div class="controls">
    <button id="settings-btn">âš™ï¸</button>
    <button id="undo">â†</button>
    <button id="redo">â†’</button>
    <button id="clear">ã‚¯ãƒªã‚¢</button>
    <button id="copy">ã‚³ãƒ”ãƒ¼</button>
    <input id="search-input" type="text" placeholder="ğŸ” æ¤œç´¢">
    <button id="do-search">æ¤œç´¢</button>
    <span id="count">0</span>
    <input id="prefix" type="text" placeholder="å§‹ã‚" style="width:40px;">
    <input id="suffix" type="text" placeholder="çµ‚ã‚ã‚Š" style="width:40px;">
    <button id="add-prefix-suffix">è¿½åŠ </button>
    
    <select id="exec-type">
      <option value="js">JavaScript</option>
      <option value="html">HTML</option>
      <option value="md">Markdown</option>
      <option value="svg">SVG</option>
    </select>
    <button id="do-exec">å®Ÿè¡Œ</button>
    <button id="open-new-url">ï¼‹</button>
    <button id="char-count-btn" title="æ–‡å­—æ•°">0</button>
  </div>

  <div id="editor-container">
    <div id="memo" contenteditable="true"></div>
    <div id="code-editor"></div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* -------------------------------------------------------------------------- */
  /* åˆæœŸåŒ– & ã‚¨ãƒ‡ã‚£ã‚¿                                 */
  /* -------------------------------------------------------------------------- */
  const memo = document.getElementById('memo');
  const editorDiv = document.getElementById('code-editor');
  const titleInput = document.getElementById('page-title');
  let aceEditor = null;
  let isEditorMode = false;
  let history = [''];
  let currentStep = 0;

  function initAce() {
    try {
      if (typeof ace !== 'undefined') {
        aceEditor = ace.edit("code-editor");
        aceEditor.setTheme("ace/theme/twilight");
        aceEditor.session.setMode("ace/mode/javascript");
        aceEditor.setOptions({ fontSize: "14px", showLineNumbers: true, wrap: true });
        aceEditor.on("change", () => updateHistory(aceEditor.getValue()));
      }
    } catch(e) { console.error("Ace init failed", e); }
  }
  initAce();

  document.getElementById('exec-type').addEventListener('change', (e) => {
    const map = {'js':'ace/mode/javascript','html':'ace/mode/html','md':'ace/mode/markdown','svg':'ace/mode/xml'};
    if (aceEditor) aceEditor.session.setMode(map[e.target.value]);
  });

  document.getElementById('btn-editor-mode').addEventListener('click', () => {
    const btn = document.getElementById('btn-editor-mode');
    if (!isEditorMode) {
      const current = memo.innerText;
      memo.style.display = 'none'; editorDiv.style.display = 'block';
      if(aceEditor) aceEditor.setValue(current, -1);
      isEditorMode = true; btn.textContent = "ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¢ãƒ¼ãƒ‰ ã‚ªãƒ•";
    } else {
      const current = aceEditor ? aceEditor.getValue() : "";
      editorDiv.style.display = 'none'; memo.style.display = 'block';
      memo.innerText = current;
      isEditorMode = false; btn.textContent = "ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¢ãƒ¼ãƒ‰ ã‚ªãƒ³";
    }
  });

  function getText() { return isEditorMode && aceEditor ? aceEditor.getValue() : memo.innerText; }
  function setText(text) { 
    if(isEditorMode && aceEditor) aceEditor.setValue(text, -1); 
    else memo.innerText = text; 
    document.getElementById('char-count-btn').textContent = text.length;
  }
  function updateHistory(text) {
    if (history[currentStep] !== text) {
      history = history.slice(0, currentStep + 1);
      history.push(text);
      currentStep++;
    }
    document.getElementById('char-count-btn').textContent = text.length;
  }

  /* -------------------------------------------------------------------------- */
  /* ãƒ‘ãƒãƒ« & ç”»é¢é·ç§»                                */
  /* -------------------------------------------------------------------------- */
  const panel = document.getElementById('settings-panel');
  const screens = document.querySelectorAll('.screen');
  const expandBtn = document.getElementById('expand-btn');

  document.getElementById('settings-btn').addEventListener('click', () => { 
    panel.classList.add('open'); 
    showScreen('menu-screen'); 
    loadGhSettingsFromExt();
  });
  document.querySelector('.panel-close').onclick = () => panel.classList.remove('open');
  
  function showScreen(id) {
    screens.forEach(s => s.classList.remove('active'));
    const target = document.getElementById(id);
    if(target) target.classList.add('active');
  }

  document.querySelectorAll('.back-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      showScreen(e.target.dataset.target || 'menu-screen');
    });
  });

  const bindScreen = (id, screen) => {
    const el = document.getElementById(id);
    if(el) el.onclick = () => showScreen(screen);
  };
  bindScreen('btn-transform', 'transform-screen');
  bindScreen('btn-import', 'import-screen');
  bindScreen('btn-export', 'export-screen');

  /* -------------------------------------------------------------------------- */
  /* PCè¡¨ç¤ºãƒœã‚¿ãƒ³ & +ãƒœã‚¿ãƒ³                           */
  /* -------------------------------------------------------------------------- */
  document.getElementById('btn-pc-view').onclick = () => {
    const meta = document.querySelector('meta[name="viewport"]');
    if (meta.content.includes('width=device-width')) {
      meta.content = 'width=2000, initial-scale=0.5';
      alert('PCè¡¨ç¤º(å¹…2000px)ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');
    } else {
      meta.content = 'width=device-width, initial-scale=1.0';
      alert('ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºã«æˆ»ã—ã¾ã—ãŸ');
    }
  };

  document.getElementById('open-new-url').onclick = () => {
    window.open('https://gadget-otaku.github.io/Bookmarklet/%E3%83%A1%E3%83%A2%E5%B8%B32.0', '_blank');
  };

  /* -------------------------------------------------------------------------- */
  /* æ¤œç´¢æ©Ÿèƒ½ (ä¿®æ­£ç‰ˆ)                                */
  /* -------------------------------------------------------------------------- */
  document.getElementById('do-search').onclick = () => {
    const query = document.getElementById('search-input').value;
    if (!query) return;

    if (isEditorMode && aceEditor) {
      aceEditor.find(query, {
        backwards: false,
        wrap: true,
        caseSensitive: false,
        wholeWord: false,
        regExp: false
      });
    } else {
      // ContentEditableç”¨ (window.find)
      if (window.find) {
        // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å…ˆé ­ã«æˆ»ã£ã¦å†æ¤œç´¢
        if (!window.find(query, false, false, true, false, false, false)) {
          const sel = window.getSelection();
          sel.collapse(document.body, 0);
          window.find(query, false, false, true, false, false, false);
        }
      } else {
        alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯æ¤œç´¢ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
      }
    }
  };

  /* -------------------------------------------------------------------------- */
  /* æ‹¡å¼µæ©Ÿèƒ½é€£æº                                    */
  /* -------------------------------------------------------------------------- */
  let ghConfig = null;

  function sendExtMessage(payload) {
    return new Promise((resolve, reject) => {
      const id = Date.now() + Math.random();
      let handled = false;
      const handler = (e) => {
        if (e.data && e.data.source === 'MEMO_EXTENSION' && e.data.id === id) {
          window.removeEventListener('message', handler);
          handled = true;
          resolve(e.data.payload);
        }
      };
      window.addEventListener('message', handler);
      window.postMessage({ source: 'MEMO_TOOL_V3', id, payload }, "*");
      setTimeout(() => {
        if (!handled) { window.removeEventListener('message', handler); reject('EXTENSION_TIMEOUT'); }
      }, 1000);
    });
  }

  async function loadGhSettingsFromExt() {
    try {
      const res = await sendExtMessage({ type: 'GET_SETTINGS' });
      const stat = document.getElementById('gh-status');
      if (res && res.githubToken) {
        const match = res.repoUrl.match(/github\.com\/([^\/]+)\/([^\/]+)/);
        if(match) {
          ghConfig = { 
            token: res.githubToken, 
            owner: match[1], 
            repo: match[2].replace(/(\.git)+$/, '').replace(/#.*$/, ''), 
            filename: res.fileName 
          };
          stat.textContent = "æ‹¡å¼µæ©Ÿèƒ½ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ";
          stat.style.color = "green";
        } else {
          stat.textContent = "ãƒªãƒã‚¸ãƒˆãƒªURLãŒç„¡åŠ¹ã§ã™";
        }
      } else {
        stat.textContent = "æ‹¡å¼µæ©Ÿèƒ½ã§è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„";
        stat.style.color = "red";
      }
    } catch(e) {
      const stat = document.getElementById('gh-status');
      if(stat) {
        stat.textContent = "æ‹¡å¼µæ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
        stat.style.color = "red";
      }
    }
  }
  loadGhSettingsFromExt();
  document.getElementById('btn-gh-connect').onclick = loadGhSettingsFromExt;

  /* -------------------------------------------------------------------------- */
  /* ãƒ‡ãƒ¼ã‚¿æ“ä½œ (Fetch / Save)                        */
  /* -------------------------------------------------------------------------- */
  let currentGitHubData = null; 
  let currentSha = null;

  async function fetchGitHubData() {
    if (!ghConfig) { await loadGhSettingsFromExt(); if(!ghConfig) { alert('GitHubè¨­å®šãŒã‚ã‚Šã¾ã›ã‚“'); return false; } }
    const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/${ghConfig.filename}`;
    
    try {
      const res = await sendExtMessage({ type: 'GITHUB_FETCH', url: url, token: ghConfig.token });
      if (res.ok || res.success) {
        currentSha = res.data.sha;
        const content = decodeURIComponent(escape(atob(res.data.content)));
        currentGitHubData = JSON.parse(content);
        if(!currentGitHubData.folders) currentGitHubData.folders = [];
        if(!currentGitHubData.candidates) currentGitHubData.candidates = [];
        return true;
      } else {
        alert('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + res.error);
        return false;
      }
    } catch(e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e); return false; }
  }

  async function saveToGitHub(msg, overrideData = null) {
    if (!ghConfig) return false;
    const dataToSave = overrideData || currentGitHubData;
    const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/${ghConfig.filename}`;
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(dataToSave, null, 2))));
    
    const res = await sendExtMessage({
      type: 'GITHUB_FETCH', method: 'PUT', url: url, token: ghConfig.token,
      body: { message: msg, content: content, sha: currentSha }
    });
    
    if (res.ok || res.success) {
      currentSha = res.data.content.sha;
      if (overrideData) currentGitHubData = overrideData;
      return true;
    } else {
      alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + res.error);
      return false;
    }
  }

  /* -------------------------------------------------------------------------- */
  /* è¡Œé ­ãƒ»è¡Œæœ« / ã‚³ãƒ”ãƒ¼ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆ                  */
  /* -------------------------------------------------------------------------- */
  document.getElementById('add-prefix-suffix').addEventListener('click', () => {
    const prefix = document.getElementById('prefix').value || "";
    const suffix = document.getElementById('suffix').value || "";
    const beforeText = getText();
    if (history[currentStep] !== beforeText) updateHistory(beforeText);

    if (isEditorMode && aceEditor) {
      const range = aceEditor.getSelectionRange();
      const doc = aceEditor.session.getDocument();
      for (let r = range.start.row; r <= range.end.row; r++) {
        let line = doc.getLine(r);
        aceEditor.session.replace(new ace.Range(r, 0, r, line.length), prefix + line + suffix);
      }
    } else {
      const sel = window.getSelection();
      let textToReplace = sel.toString();
      if (!textToReplace) textToReplace = memo.innerText;
      
      const lines = textToReplace.split(/\r?\n/);
      const newText = lines.map(line => prefix + line + suffix).join('\n');
      setText(newText); // ç°¡æ˜“åŒ–ã®ãŸã‚å…¨ç½®æ›
    }
    updateHistory(getText());
  });

  document.getElementById('copy').addEventListener('click', () => {
    const text = getText();
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
  });

  document.getElementById('btn-import-file').onclick = () => document.getElementById('file-input').click();
  document.getElementById('file-input').onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => { setText(reader.result); document.getElementById('import-url').value = file.name; };
    reader.readAsText(file);
  };

  document.getElementById('do-import-url').onclick = async () => {
    const url = document.getElementById('import-url').value;
    if(!url) return;
    let target = url;
    if(url.includes('github.com') && !url.includes('raw')) target = url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
    try {
      const res = await sendExtMessage({ type: 'FETCH_URL', url: target });
      if(res.success) {
        setText(res.text); 
        showScreen('menu-screen');
        panel.classList.remove('open');
      } else alert('å¤±æ•—: '+res.error);
    } catch(e) { alert('æ‹¡å¼µæ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼: '+e); }
  };

  document.getElementById('do-export').onclick = () => {
    const name = document.getElementById('export-name').value || "memo";
    const ext = document.getElementById('export-ext').value || "txt";
    const blob = new Blob([getText()], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${name}.${ext}`;
    a.click();
    panel.classList.remove('open');
  };

  /* -------------------------------------------------------------------------- */
  /* å€™è£œæ©Ÿèƒ½ (View / Edit åˆ†é›¢ & ä¿®æ­£)               */
  /* -------------------------------------------------------------------------- */
  let tempCandidates = []; // ç·¨é›†ç”¨ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿

  // 1. å€™è£œä¸€è¦§è¡¨ç¤º (View)
  function renderCandidateView() {
    const list = document.getElementById('candidate-list-view');
    list.innerHTML = '';
    if (!currentGitHubData || !currentGitHubData.candidates) return;
    
    currentGitHubData.candidates.forEach(c => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerText = c.name;
      div.onclick = () => {
        document.getElementById('import-url').value = c.url;
        showScreen('import-screen');
      };
      list.appendChild(div);
    });
  }

  // 2. å€™è£œç·¨é›†è¡¨ç¤º (Edit)
  function renderCandidateEdit() {
    const list = document.getElementById('candidate-list-edit');
    list.innerHTML = '';
    
    tempCandidates.forEach((c, i) => {
      const row = document.createElement('div');
      row.className = 'candidate-edit-row';
      
      const nameInput = document.createElement('input');
      nameInput.value = c.name;
      nameInput.placeholder = "åå‰";
      nameInput.onchange = (e) => { tempCandidates[i].name = e.target.value; };

      const urlInput = document.createElement('input');
      urlInput.value = c.url;
      urlInput.placeholder = "URL";
      urlInput.onchange = (e) => { tempCandidates[i].url = e.target.value; };

      const addBtn = document.createElement('button');
      addBtn.innerText = "è¿½åŠ ";
      addBtn.onclick = () => {
        tempCandidates.splice(i + 1, 0, { name: "", url: "" });
        renderCandidateEdit();
      };

      const delBtn = document.createElement('button');
      delBtn.innerText = "å‰Šé™¤";
      delBtn.onclick = () => {
        tempCandidates.splice(i, 1);
        renderCandidateEdit();
      };

      const upBtn = document.createElement('button');
      upBtn.innerText = "â†‘";
      upBtn.onclick = () => {
        if (i > 0) {
          [tempCandidates[i], tempCandidates[i-1]] = [tempCandidates[i-1], tempCandidates[i]];
          renderCandidateEdit();
        }
      };

      const downBtn = document.createElement('button');
      downBtn.innerText = "â†“";
      downBtn.onclick = () => {
        if (i < tempCandidates.length - 1) {
          [tempCandidates[i], tempCandidates[i+1]] = [tempCandidates[i+1], tempCandidates[i]];
          renderCandidateEdit();
        }
      };

      row.append(nameInput, urlInput, addBtn, delBtn, upBtn, downBtn);
      list.appendChild(row);
    });

    // ãƒªã‚¹ãƒˆãŒç©ºã®å ´åˆã®åˆæœŸè¿½åŠ ãƒœã‚¿ãƒ³
    if (tempCandidates.length === 0) {
       const btn = document.createElement('button');
       btn.innerText = "æ–°è¦è¿½åŠ ";
       btn.onclick = () => { tempCandidates.push({name:"", url:""}); renderCandidateEdit(); };
       list.appendChild(btn);
    }
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
  document.getElementById('btn-candidates').onclick = async () => {
    if (await fetchGitHubData()) {
      renderCandidateView();
      showScreen('candidate-view-screen');
    }
  };

  document.getElementById('btn-cand-edit-mode').onclick = () => {
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹æ™‚ã€ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
    tempCandidates = JSON.parse(JSON.stringify(currentGitHubData.candidates || []));
    renderCandidateEdit();
    showScreen('candidate-edit-screen');
  };

  document.getElementById('cand-save-sync').onclick = async () => {
    // ä¿å­˜ãƒœã‚¿ãƒ³: GitHubã¸åŒæœŸ
    currentGitHubData.candidates = tempCandidates;
    if (await saveToGitHub("Update candidates")) {
      renderCandidateView();
      showScreen('candidate-view-screen');
    }
  };

  document.getElementById('cand-edit-back').onclick = () => {
    // æˆ»ã‚‹ãƒœã‚¿ãƒ³: ä¿å­˜ã›ãšã«ä¸€è¦§ã¸ (å¤‰æ›´ç ´æ£„)
    showScreen('candidate-view-screen');
  };


  /* -------------------------------------------------------------------------- */
  /* ãƒ¡ãƒ¢ä¸€è¦§ãƒ»ãƒ„ãƒªãƒ¼ãƒ»D&D (ä¿®æ­£ç‰ˆ)                   */
  /* -------------------------------------------------------------------------- */
  let currentPath = [];
  let tempFolders = []; // ç·¨é›†ç”¨ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿
  let selectedItemIndex = -1; // ç·¨é›†ä¸­ã®é¸æŠã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: ãƒ‘ã‚¹ã‹ã‚‰ãƒ•ã‚©ãƒ«ãƒ€ç‰¹å®š
  function getFolderByPath(root, path) {
    let target = { children: root };
    for (const p of path) {
      if (!target.children) return null;
      target = target.children.find(c => c.type === 'folder' && c.name === p);
      if (!target) return null;
    }
    return target;
  }

  // 1. ãƒ¡ãƒ¢ä¸€è¦§ (View Mode)
  document.getElementById('btn-memo-list').onclick = async () => {
    // ä¸€è¦§ã‚’é–‹ã„ãŸæ™‚ç‚¹ã§å¿…ãšãƒ­ãƒ¼ãƒ‰
    if (await fetchGitHubData()) {
      currentPath = [];
      renderTreeView(document.getElementById('memo-tree-view'));
      
      // ä¸€æ™‚ãƒ¡ãƒ¢è¡¨ç¤ºæ›´æ–°
      const tempDiv = document.getElementById('temp-memo-view');
      tempDiv.onclick = () => {
        setText(currentGitHubData.tempMemo || "");
        titleInput.value = "ä¸€æ™‚ãƒ¡ãƒ¢";
        panel.classList.remove('open');
      };
      
      showScreen('list-screen');
    }
  };

  function renderTreeView(container) {
    container.innerHTML = '';
    
    // éšå±¤ç§»å‹• (ä¸Šã¸)
    if (currentPath.length > 0) {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<span class="folder-icon">ğŸ“</span> .. (ä¸Šã®éšå±¤ã¸)`;
      div.onclick = () => {
        currentPath.pop();
        renderTreeView(container);
      };
      container.appendChild(div);
    }

    const currentFolder = getFolderByPath(currentGitHubData.folders, currentPath);
    if (!currentFolder || !currentFolder.children) return;

    currentFolder.children.forEach(node => {
      const div = document.createElement('div');
      div.className = 'item';
      if (node.type === 'folder') {
        div.innerHTML = `<span class="folder-icon">ğŸ“</span> ${escapeHTML(node.name)}`;
        div.onclick = () => {
          currentPath.push(node.name);
          renderTreeView(container);
        };
      } else {
        div.innerHTML = `<span class="memo-icon">ğŸ“‹ï¸</span> ${escapeHTML(node.name)}`;
        div.onclick = () => {
          setText(node.content);
          titleInput.value = node.name;
          panel.classList.remove('open');
        };
      }
      container.appendChild(div);
    });
  }

  // 2. ãƒ¡ãƒ¢ç·¨é›† (Edit Mode)
  document.getElementById('btn-edit-mode').onclick = () => {
    // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ã—ã¦ç·¨é›†é–‹å§‹
    tempFolders = JSON.parse(JSON.stringify(currentGitHubData.folders));
    selectedItemIndex = -1;
    document.getElementById('edit-controls').style.display = 'none';
    renderTreeEdit();
    showScreen('list-edit-ui');
  };

  document.getElementById('list-edit-back').onclick = () => {
    // å¤‰æ›´ã‚’ç ´æ£„ã—ã¦æˆ»ã‚‹
    currentPath = [];
    renderTreeView(document.getElementById('memo-tree-view'));
    showScreen('list-screen');
  };

  document.getElementById('list-edit-save').onclick = async () => {
    // GitHubã¸ä¿å­˜
    currentGitHubData.folders = tempFolders;
    if (await saveToGitHub("Update folder structure")) {
      currentPath = [];
      renderTreeView(document.getElementById('memo-tree-view'));
      showScreen('list-screen');
    }
  };

  /* --- ç·¨é›†ãƒ»D&D ãƒ­ã‚¸ãƒƒã‚¯ --- */
  function renderTreeEdit() {
    const container = document.getElementById('memo-tree-edit');
    container.innerHTML = '';
    
    // ä¸Šã®éšå±¤ã¸ (Drop Target)
    if (currentPath.length > 0) {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerText = 'ğŸ“ .. (ä¸Šã®éšå±¤ã¸)';
      div.onclick = () => { 
        currentPath.pop(); selectedItemIndex=-1; 
        document.getElementById('edit-controls').style.display='none';
        renderTreeEdit(); 
      };
      // ä¸Šã®éšå±¤ã¸ã®ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
      setupDragDrop(div, -1, true); 
      container.appendChild(div);
    }

    const currentFolder = getFolderByPath(tempFolders, currentPath);
    const children = currentFolder.children || [];

    children.forEach((node, i) => {
      const div = document.createElement('div');
      div.className = 'item';
      div.draggable = true; // ãƒ‰ãƒ©ãƒƒã‚°æœ‰åŠ¹
      if (i === selectedItemIndex) div.classList.add('selected');
      
      div.innerHTML = node.type === 'folder' ? `ğŸ“ ${escapeHTML(node.name)}` : `ğŸ“‹ï¸ ${escapeHTML(node.name)}`;
      
      // ã‚¯ãƒªãƒƒã‚¯é¸æŠ
      div.onclick = () => {
        selectedItemIndex = i;
        const controls = document.getElementById('edit-controls');
        const renameInput = document.getElementById('edit-rename-input');
        const enterFolderBtn = document.getElementById('edit-enter-folder');
        
        controls.style.display = 'block';
        renameInput.value = node.name;
        
        if (node.type === 'folder') {
          enterFolderBtn.style.display = 'inline-block';
          enterFolderBtn.onclick = () => {
            currentPath.push(node.name);
            selectedItemIndex = -1;
            controls.style.display = 'none';
            renderTreeEdit();
          };
        } else {
          enterFolderBtn.style.display = 'none';
        }
        renderTreeEdit(); // å†æç”»ã—ã¦é¸æŠã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
      };

      setupDragDrop(div, i, false, node.type === 'folder');
      container.appendChild(div);
    });
  }

  // --- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å®Ÿè£… ---
  let dragSrcIndex = null;
  
  function setupDragDrop(el, index, isParentLink, isFolder = false) {
    el.addEventListener('dragstart', (e) => {
      if (isParentLink) { e.preventDefault(); return; }
      dragSrcIndex = index;
      e.dataTransfer.effectAllowed = 'move';
      el.style.opacity = '0.4';
    });

    el.addEventListener('dragend', (e) => {
      el.style.opacity = '1';
      document.querySelectorAll('.item').forEach(item => {
        item.classList.remove('drag-over');
        item.classList.remove('drag-over-folder');
      });
    });

    el.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      if (isParentLink) {
         el.classList.add('drag-over-folder'); // ä¸Šã®éšå±¤ã¯ãƒ•ã‚©ãƒ«ãƒ€æ‰±ã„
      } else if (isFolder && dragSrcIndex !== index) {
         // ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸Šãªã‚‰ä¸­ã«å…¥ã‚Œã‚‹è¡¨ç¤º
         el.classList.add('drag-over-folder');
         el.classList.remove('drag-over'); 
      } else {
         el.classList.add('drag-over');
         el.classList.remove('drag-over-folder');
      }
    });

    el.addEventListener('dragleave', (e) => {
      el.classList.remove('drag-over');
      el.classList.remove('drag-over-folder');
    });

    el.addEventListener('drop', (e) => {
      e.stopPropagation();
      if (dragSrcIndex === null) return;
      
      const folder = getFolderByPath(tempFolders, currentPath);
      const itemToMove = folder.children[dragSrcIndex];

      // 1. ä¸Šã®éšå±¤ã¸ç§»å‹•
      if (isParentLink) {
        if (!confirm("ä¸Šã®éšå±¤ã¸ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ")) return;
        folder.children.splice(dragSrcIndex, 1);
        
        // è¦ªãƒ•ã‚©ãƒ«ãƒ€ã‚’æ¢ã™ (ç¾åœ¨ã®ãƒ‘ã‚¹ã®1ã¤ä¸Š)
        const parentPath = currentPath.slice(0, -1);
        const parentFolder = getFolderByPath(tempFolders, parentPath);
        parentFolder.children.push(itemToMove);
        
        selectedItemIndex = -1;
        renderTreeEdit();
        return;
      }

      // 2. ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­ã¸ç§»å‹•
      if (isFolder && index !== dragSrcIndex) {
         // ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­ã«ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸã‹åˆ¤å®š (drag-over-folderã‚¯ãƒ©ã‚¹ãŒä»˜ã„ã¦ã„ã‚‹ã‹)
         if (el.classList.contains('drag-over-folder')) {
           const targetFolder = folder.children[index];
           if (targetFolder.type === 'folder') {
             folder.children.splice(dragSrcIndex, 1);
             if(!targetFolder.children) targetFolder.children = [];
             targetFolder.children.push(itemToMove);
             selectedItemIndex = -1;
             renderTreeEdit();
             return;
           }
         }
      }

      // 3. ä¸¦ã³æ›¿ãˆ
      if (dragSrcIndex !== index) {
        folder.children.splice(dragSrcIndex, 1);
        folder.children.splice(index, 0, itemToMove);
        selectedItemIndex = -1; // é¸æŠè§£é™¤
        renderTreeEdit();
      }
    });
  }

  /* --- ç·¨é›†æ“ä½œãƒœã‚¿ãƒ³ (ã‚³ãƒ”ãƒ¼ãƒ»å‰Šé™¤ãƒ»ãƒªãƒãƒ¼ãƒ ãƒ»ä½œæˆ) --- */
  document.getElementById('edit-copy').onclick = () => {
    if (selectedItemIndex >= 0) {
      const folder = getFolderByPath(tempFolders, currentPath);
      const original = folder.children[selectedItemIndex];
      const copy = JSON.parse(JSON.stringify(original)); // Deep copy
      copy.name += " - ã‚³ãƒ”ãƒ¼";
      folder.children.splice(selectedItemIndex + 1, 0, copy);
      renderTreeEdit();
    }
  };

  document.getElementById('edit-del').onclick = () => {
    if (selectedItemIndex >= 0) {
      if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ (ãƒ•ã‚©ãƒ«ãƒ€ã®å ´åˆã¯ä¸­èº«ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™)")) return;
      const folder = getFolderByPath(tempFolders, currentPath);
      folder.children.splice(selectedItemIndex, 1);
      selectedItemIndex = -1;
      document.getElementById('edit-controls').style.display = 'none';
      renderTreeEdit();
    }
  };

  document.getElementById('edit-rename-apply').onclick = () => {
    if (selectedItemIndex >= 0) {
      const folder = getFolderByPath(tempFolders, currentPath);
      folder.children[selectedItemIndex].name = document.getElementById('edit-rename-input').value;
      renderTreeEdit();
    }
  };

  document.getElementById('create-folder-edit').onclick = () => {
    const name = document.getElementById('new-folder-name-edit').value;
    if (!name) return;
    const folder = getFolderByPath(tempFolders, currentPath);
    if (!folder.children) folder.children = [];
    folder.children.push({ type: 'folder', name: name, children: [] });
    document.getElementById('new-folder-name-edit').value = "";
    renderTreeEdit();
  };

  /* -------------------------------------------------------------------------- */
  /* ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ (View Modeã‹ã‚‰ã®ä¿å­˜)               */
  /* -------------------------------------------------------------------------- */
  document.getElementById('btn-memo-save').onclick = async () => {
    if (await fetchGitHubData()) {
      currentPath = [];
      document.getElementById('save-title').value = titleInput.value;
      renderTreeView(document.getElementById('save-tree-view')); // ãƒ„ãƒªãƒ¼æç”»ã¯Viewã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ©ç”¨
      showScreen('save-screen');
    }
  };

  document.getElementById('do-save-memo').onclick = async () => {
    const title = document.getElementById('save-title').value;
    if (!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    
    // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ‘ã‚¹(save-tree-viewã§æ“ä½œã•ã‚ŒãŸcurrentPath)ã‚’åˆ©ç”¨
    const folder = getFolderByPath(currentGitHubData.folders, currentPath);
    if (!folder.children) folder.children = [];
    
    const existingIdx = folder.children.findIndex(c => c.type === 'memo' && c.name === title);
    if (existingIdx >= 0) {
      if (!confirm("åŒã˜ã‚¿ã‚¤ãƒˆãƒ«åã®ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã™ã€‚ä¸Šæ›¸ãä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return;
      folder.children[existingIdx].content = getText();
    } else {
      folder.children.push({ type: 'memo', name: title, content: getText() });
    }
    
    if (await saveToGitHub(`Save memo: ${title}`)) {
      alert("ä¿å­˜ã—ã¾ã—ãŸ");
      titleInput.value = title;
    }
  };

  document.getElementById('do-save-temp').onclick = async () => {
    currentGitHubData.tempMemo = getText();
    if (await saveToGitHub("Update temp memo")) {
      alert("ä¸€æ™‚ä¿å­˜ã—ã¾ã—ãŸ");
    }
  };

  /* -------------------------------------------------------------------------- */
  /* å¤‰æ› / å®Ÿè¡Œ / ãã®ä»–                             */
  /* -------------------------------------------------------------------------- */
  document.getElementById('clear').onclick=()=>{setText(''); titleInput.value='';};
  document.getElementById('undo').onclick=()=>{if(currentStep>0){currentStep--;setText(history[currentStep]);}};
  document.getElementById('redo').onclick=()=>{if(currentStep<history.length-1){currentStep++;setText(history[currentStep]);}};

  // å¤‰æ›æ©Ÿèƒ½
  let originalContent = null;
  document.getElementById('do-confirm-transform').onclick = () => executeTransform(true);
  document.getElementById('do-transform').onclick = () => executeTransform(false);
  
  function executeTransform(isConfirm) {
    const type = document.querySelector('input[name="trans-type"]:checked').value;
    const isOneLine = document.getElementById('chk-one-line').checked;
    const customFrom = document.getElementById('trans-from').value;
    const customTo = document.getElementById('trans-to').value;
    const currentText = getText();
    let result = currentText;

    if (type === 'encode') result = encodeURIComponent(currentText);
    else if (type === 'decode') result = decodeURIComponent(currentText);
    else if (type === 'remove-comment') {
      result = currentText.split('\n').map(l => {
        let idx = l.indexOf('//');
        return idx !== -1 ? l.substring(0, idx) : l; 
      }).join('\n');
    } else if (type === 'custom') {
      if(customFrom) result = currentText.split(customFrom).join(customTo);
    }

    if (isOneLine) {
      result = result.replace(/\r?\n/g, '');
    }

    if (isConfirm) {
      originalContent = currentText;
      setText(result);
      
      if(isEditorMode) {
        aceEditor.setReadOnly(true);
        // èƒŒæ™¯è‰²å¤‰æ›´ã¯Aceã§ã¯è¤‡é›‘ãªãŸã‚å‰²æ„›ã—ã€ReadOnlyã«ã™ã‚‹ã®ã¿
      } else {
        memo.contentEditable = false;
        memo.style.backgroundColor = "#fffbcc"; // é»„è‰²ã£ã½ã
      }
      
      panel.classList.remove('open');
      expandBtn.style.display = 'block';
      expandBtn.textContent = "å¤‰æ›ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ (å…ƒã«æˆ»ã™)";
    } else {
      // ç¢ºå®šå®Ÿè¡Œ
      if (originalContent !== null) {
         // ç¢ºèªãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰ã®å®Ÿè¡Œãªã‚‰ãƒªã‚»ãƒƒãƒˆå‡¦ç†ã‚’æŒŸã‚€
         if(isEditorMode) aceEditor.setReadOnly(false);
         else { memo.contentEditable = true; memo.style.backgroundColor = ""; }
         expandBtn.style.display = 'none';
         originalContent = null;
      }
      setText(result);
      updateHistory(result);
      alert('å¤‰æ›ã—ã¾ã—ãŸ');
      panel.classList.remove('open');
    }
  }

  expandBtn.onclick = () => {
    if (originalContent !== null) {
      if(isEditorMode) {
        aceEditor.setValue(originalContent, -1); 
        aceEditor.setReadOnly(false);
      } else {
        memo.innerText = originalContent; 
        memo.contentEditable = true;
        memo.style.backgroundColor = "";
      }
      originalContent = null;
      expandBtn.style.display = 'none';
      panel.classList.add('open');
    }
  };

  document.getElementById('do-exec').onclick = () => {
    const type = document.getElementById('exec-type').value;
    let code = "";
    if (isEditorMode && aceEditor) {
      code = aceEditor.getSelectedText() || aceEditor.getValue();
    } else {
      const sel = window.getSelection();
      code = (sel.rangeCount && !sel.isCollapsed && memo.contains(sel.anchorNode)) ? sel.toString() : memo.innerText;
    }

    if (type === 'js') {
      try { new Function(code)(); } catch(e) { alert(e); }
    } else {
      const w = window.open();
      const content = type === 'md' ? marked.parse(code) : code;
      w.document.write(content);
      w.document.close();
    }
  };

  function escapeHTML(s) { return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m])); }
});
</script>
</body>
</html>
