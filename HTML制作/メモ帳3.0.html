<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¡ãƒ¢å¸³ 3.0</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    html, body { height: 100%; margin: 0; padding: 0 18px 18px 18px; box-sizing: border-box; }
    body { display: flex; flex-direction: column; font-family: sans-serif; }
    
    /* ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒ¼ & ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
    .header-bar { display: flex; gap: 10px; margin-top: 10px; margin-bottom: 5px; }
    #page-title { flex: 1; padding: 5px; font-weight: bold; border: 1px solid #ccc; }
    
    .controls { flex: 0 0 auto; margin-bottom: 10px; position: relative; display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
    .controls button, .controls input, .controls select { padding: 7px 7px; font-size: 12px; }
    
    /* ã‚¨ãƒ‡ã‚£ã‚¿ã‚¨ãƒªã‚¢ (ãƒ¬ã‚¤ãƒ¤ãƒ¼é‡ã­åˆã‚ã›ã®ãŸã‚ relative æŒ‡å®š) */
    #editor-container { flex: 1; position: relative; border: 1px solid #ccc; overflow: hidden; }

    /* ãƒ¡ã‚¤ãƒ³å…¥åŠ›æ¬„ (#memo) */
    #memo { 
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%; 
      box-sizing: border-box; 
      padding: 10px; 
      overflow: auto; 
      white-space: pre-wrap; 
      font-family: monospace; 
      outline: none;
      z-index: 2; /* æ‰‹å‰ */
      background-color: transparent; /* é‡è¦: é€æ˜ */
      color: inherit;
    }

    /* ãƒã‚¤ãƒ©ã‚¤ãƒˆå°‚ç”¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ (#highlight-layer) */
    #highlight-layer {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      box-sizing: border-box;
      padding: 10px; /* #memoã¨åˆã‚ã›ã‚‹ */
      overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯JSã§åŒæœŸ */
      white-space: pre-wrap;
      font-family: monospace;
      z-index: 1; /* å¥¥ */
      pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯é€é */
      color: transparent; /* æ–‡å­—ã¯é€æ˜ */
      background-color: #fff; /* ã‚¨ãƒ‡ã‚£ã‚¿èƒŒæ™¯è‰² */
      display: block;
    }

    /* ã‚¹ã‚¿ã‚¤ãƒ«è£…é£¾ */
    /* æ¤œç´¢ãƒ’ãƒƒãƒˆç”¨ (ãƒ¬ã‚¤ãƒ¤ãƒ¼å†…) */
    #highlight-layer .highlight { background-color: yellow; color: transparent; }

    /* å¤‰æ›ç¢ºèªç”¨ (memoå†…ã«ç›´æ¥æç”») */
    .highlight-change { background-color: cyan; cursor: pointer; } /* é’è‰²ãƒãƒ¼ã‚«ãƒ¼ (å¤‰æ›´å¾Œ) */
    .highlight-delete { background-color: #ffcccc; text-decoration: line-through; color: #cc0000; cursor: pointer; } /* èµ¤è‰²ãƒãƒ¼ã‚«ãƒ¼ (å‰Šé™¤å¯¾è±¡) */
    
    /* â˜…è¿½åŠ : ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒãƒ¼ã‚«ãƒ¼ (å–ã‚Šæ¶ˆã—çŠ¶æ…‹) */
    .highlight-disabled { 
      background-color: #e0e0e0 !important; 
      text-decoration: none !important; 
      color: inherit !important; 
      cursor: pointer;
    }

    /* Ace Editor */
    #code-editor { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: none; z-index: 10; background: #141414; }
    
    /* è¨­å®šãƒ‘ãƒãƒ« */
    #settings-panel { display: none; position: fixed; top: 0; left: 0; width: 320px; height: 100%; background: #f9f9f9; border-right: 1px solid #ccc; z-index: 2000; box-shadow: 2px 0 5px rgba(0,0,0,0.1); padding: 15px; overflow-y: auto; }
    #settings-panel.open { display: block; }
    .panel-header { display: flex; justify-content: flex-end; margin-bottom: 20px; }
    .panel-close { cursor: pointer; font-weight: bold; font-size: 18px; }
    
    /* ç¢ºèªãƒ¢ãƒ¼ãƒ‰ç”¨ã®ãƒœã‚¿ãƒ³ç¾¤ */
    .preview-btns { display: none; position: fixed; top: 10px; left: 10px; z-index: 3000; }
    .preview-btns button { padding: 10px 15px; font-weight: bold; border: 2px solid #333; cursor: pointer; margin-right: 5px; }
    #expand-btn { background: #fff; }
    #apply-btn { background: #ccffcc; }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ç­‰ */
    .menu-btn { width: 100%; padding: 10px; text-align: left; margin-bottom: 5px; cursor: pointer; background: #fff; border: 1px solid #ddd; }
    .menu-btn:hover { background: #eee; }
    .screen { display: none; }
    .screen.active { display: block; }
    .row { margin-bottom: 10px; }
    .row label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 12px; }
    .row input[type="text"], .row input[type="password"] { width: 100%; padding: 5px; box-sizing: border-box; }
    .item-list { border: 1px solid #eee; padding: 5px; max-height: 250px; overflow-y: auto; margin-bottom: 10px; background: #fff; }
    .item { padding: 5px; cursor: pointer; display: flex; align-items: center; border-bottom: 1px solid #f0f0f0; }
    .item:hover { background: #eef; }
    .item.selected { background: #ddf; border-left: 3px solid blue; }
    .folder-icon { color: #dcb028; margin-right: 5px; }
    .memo-icon { color: #555; margin-right: 5px; }
    
    #count { min-width: 40px; text-align: center; display: inline-block; font-size: 12px; }
    .status-msg { font-size: 10px; color: blue; margin-top: 5px; }
    
    /* ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ç”¨ */
    .dragging { opacity: 0.5; }
    .drop-target { background-color: #e0f7fa; border: 2px dashed #00796b; }
    .drop-hint { position: absolute; background: #00796b; color: white; padding: 2px 5px; border-radius: 3px; font-size: 12px; z-index: 1000; }
    
    /* å¤‰æ›ç”»é¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿®æ­£ */
    #transform-screen label { display: block; margin-bottom: 5px; }
    #transform-screen input[type="radio"] { margin-right: 5px; }
    /* ç„¡åŠ¹åŒ–æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .disabled-input { opacity: 0.5; pointer-events: none; }
    
    /* å€™è£œç·¨é›†ç”»é¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .candidate-edit-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
    .candidate-edit-row input { flex: 1; padding: 5px; }
    .candidate-edit-row .candidate-buttons { display: flex; gap: 2px; }
    .temp-memo-separator { border-top: 2px solid #ccc; margin-top: 10px; padding-top: 10px; }
    
    /* ç·¨é›†ç”»é¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .edit-controls { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
    .name-edit-row { display: flex; gap: 5px; margin-top: 10px; }
    .name-edit-row input { flex: 1; padding: 5px; }
  </style>
</head>
<body>
  <div class="header-bar">
    <input type="text" id="page-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®š">
  </div>

  <div class="preview-btns" id="preview-controls">
    <button id="expand-btn">â¤¢ å±•é–‹ (ã‚­ãƒ£ãƒ³ã‚»ãƒ«)</button>
    <button id="apply-btn">ãƒ¬ ç¢ºå®š (é©ç”¨)</button>
  </div>

  <div id="settings-panel">
    <div class="panel-header"><span class="panel-close">â˜’</span></div>
    
    <div id="menu-screen" class="screen active">
      <button class="menu-btn" id="btn-editor-mode">ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¢ãƒ¼ãƒ‰ ã‚ªãƒ³</button>
      <button class="menu-btn" id="btn-transform">å¤‰æ›</button>
      <button class="menu-btn" id="btn-pc-view">PCè¡¨ç¤º</button>
      <button class="menu-btn" id="btn-import">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <button class="menu-btn" id="btn-export">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="menu-btn" id="btn-memo-list">ãƒ¡ãƒ¢ä¸€è¦§</button>
      <button class="menu-btn" id="btn-memo-save">ãƒ¡ãƒ¢ä¿å­˜</button>
      <hr>
      <div style="font-size:11px; color:#666; margin-bottom:5px;">â€»APIè¨­å®šã¯æ‹¡å¼µæ©Ÿèƒ½ã§è¡Œã£ã¦ãã ã•ã„</div>
      <button class="menu-btn" id="btn-gh-connect">è¨­å®šå†èª­ã¿è¾¼ã¿</button>
      <div id="gh-status" class="status-msg"></div>
    </div>

    <div id="transform-screen" class="screen">
      <button class="back-btn">â†æˆ»ã‚‹</button>
      <h3>å¤‰æ›</h3>
      <label><input type="radio" name="trans-type" value="encode" checked> ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰</label>
      <label><input type="radio" name="trans-type" value="decode"> ãƒ‡ã‚³ãƒ¼ãƒ‰</label>
      <label><input type="radio" name="trans-type" value="remove-comment"> ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤</label>
      <div style="margin-left:20px;">
        <label id="lbl-one-line"><input type="checkbox" id="chk-one-line"> 1æ–‡</label>
      </div>
      <label><input type="radio" name="trans-type" value="custom"> ã‚«ã‚¹ã‚¿ãƒ </label>
      <div class="row" style="margin-top:10px;"><label>å¤‰æ›å…ƒ</label><input type="text" id="trans-from"></div>
      <div class="row"><label>å¤‰æ›å…ˆ</label><input type="text" id="trans-to"></div>
      <div style="display:flex; justify-content:space-between; margin-top:15px;">
        <button id="do-transform">å¤‰æ› (å³æ™‚)</button>
        <button id="do-confirm-transform">ç¢ºèª</button>
      </div>
    </div>

    <div id="import-screen" class="screen">
      <button class="back-btn">â†æˆ»ã‚‹</button>
      <h3>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
      <div class="row"><label>URL</label><input type="text" id="import-url" placeholder="GitHub Raw / ãƒªãƒã‚¸ãƒˆãƒª / ã‚µã‚¤ãƒˆURL"></div>
      <div style="display:flex; justify-content:space-between; margin-bottom:15px; flex-wrap: wrap; gap:5px;">
        <button id="do-import-url">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <button id="btn-import-file">ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰</button>
        <input type="file" id="file-input" style="display:none">
        <button id="btn-candidates">å€™è£œ</button>
      </div>
    </div>

    <div id="candidate-list-screen" class="screen">
      <button class="back-btn" data-target="import-screen">â†æˆ»ã‚‹</button>
      <button id="candidate-edit-btn" style="float:right;">ç·¨é›†</button>
      <h3>å€™è£œä¸€è¦§</h3>
      <div class="row">
        <div id="candidate-list" class="item-list"></div>
      </div>
    </div>

    <div id="candidate-edit-screen" class="screen">
      <button class="back-btn" data-target="candidate-list-screen">â†æˆ»ã‚‹</button>
      <button id="save-candidates" style="float:right;">ä¿å­˜</button>
      <h3>å€™è£œç·¨é›†</h3>
      <div id="candidate-edit-container">
        </div>
      <div style="display:flex; gap:5px; margin-top:10px;">
        <button id="candidate-add-row">è¿½åŠ </button>
      </div>
    </div>

    <div id="export-screen" class="screen">
      <button class="back-btn">â†æˆ»ã‚‹</button>
      <h3>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
      <div class="row"><label>ãƒ•ã‚¡ã‚¤ãƒ«å</label><input type="text" id="export-name" placeholder="memo"></div>
      <div class="row"><label>æ‹¡å¼µå­</label><input type="text" id="export-ext" placeholder="txt"></div>
      <button id="do-export">ä¿å­˜</button>
    </div>

    <div id="list-screen" class="screen">
      <button class="back-btn">â†æˆ»ã‚‹</button>
      <button id="btn-edit-mode" style="float:right;">ç·¨é›†</button>
      <h3>ãƒ¡ãƒ¢ä¸€è¦§</h3>
      <div id="memo-tree-view" class="item-list">Loading...</div>
      <div class="temp-memo-separator">
        <div class="item" id="temp-memo-item">
          <span class="memo-icon">ğŸ“‹ï¸</span> <b>ä¸€æ™‚ãƒ¡ãƒ¢</b>
        </div>
      </div>
    </div>

    <div id="list-edit-ui" class="screen">
      <button class="back-btn" data-target="list-screen">â†æˆ»ã‚‹</button>
      <button id="list-save-btn" style="float:right;">ä¿å­˜</button>
      <h3>ç·¨é›†ä¸­</h3>
      <div id="memo-tree-edit" class="item-list"></div>
      <div class="edit-controls">
        <button id="edit-copy">ã‚³ãƒ”ãƒ¼</button>
        <button id="edit-del">å‰Šé™¤</button>
        <button id="edit-enter-folder" style="display:none;">â†’ä¸‹ã®éšå±¤ã¸</button>
      </div>
      <div class="name-edit-row">
        <input type="text" id="edit-name-input" placeholder="åå‰">
        <button id="edit-rename">å¤‰æ›´</button>
      </div>
    </div>

    <div id="save-screen" class="screen">
      <button class="back-btn">â†æˆ»ã‚‹</button>
      <h3>ãƒ¡ãƒ¢ä¿å­˜</h3>
      <div class="row"><label>ã‚¿ã‚¤ãƒˆãƒ«å</label><input type="text" id="save-title"></div>
      <div class="row"><label>ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</label>
        <div id="save-tree-view" class="item-list"></div>
      </div>
      <div style="display:flex; justify-content:space-between;">
        <button id="do-save-memo">ä¿å­˜</button>
        <button id="do-save-temp">ä¸€æ™‚ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div class="controls">
    <button id="settings-btn">âš™ï¸</button>
    <button id="undo">â†</button>
    <button id="redo">â†’</button>
    <button id="clear">ã‚¯ãƒªã‚¢</button>
    <button id="copy">ã‚³ãƒ”ãƒ¼</button>
    <input id="search" type="text" placeholder="ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢">
    <button id="prev"><</button>
    <span id="count">0/0</span>
    <button id="next">></button>
    <input id="prefix" type="text" placeholder="å§‹ã‚">
    <input id="suffix" type="text" placeholder="çµ‚ã‚ã‚Š">
    <button id="add-prefix-suffix">è¿½åŠ </button>
    
    <select id="exec-type">
      <option value="js">JavaScript</option>
      <option value="html">HTML</option>
      <option value="md">Markdown</option>
      <option value="svg">SVG</option>
    </select>
    <button id="do-exec">å®Ÿè¡Œ</button>
    <button id="open-url">ï¼‹</button>
    <button id="char-count-btn" title="æ–‡å­—æ•°">0</button>
  </div>

  <div id="editor-container">
    <div id="highlight-layer"></div>
    <div id="memo" contenteditable="true"></div>
    <div id="code-editor"></div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* -------------------------------------------------------------------------- */
  /* åˆæœŸåŒ– & ã‚¨ãƒ‡ã‚£ã‚¿                                 */
  /* -------------------------------------------------------------------------- */
  const memo = document.getElementById('memo');
  const highlightLayer = document.getElementById('highlight-layer');
  const editorDiv = document.getElementById('code-editor');
  const titleInput = document.getElementById('page-title');
  let aceEditor = null;
  let isEditorMode = false;
  let history = [''];
  let currentStep = 0;

  function initAce() {
    try {
      if (typeof ace !== 'undefined') {
        aceEditor = ace.edit("code-editor");
        aceEditor.setTheme("ace/theme/twilight");
        aceEditor.session.setMode("ace/mode/javascript");
        aceEditor.setOptions({ fontSize: "14px", showLineNumbers: true, wrap: true });
        aceEditor.on("change", () => updateHistory(aceEditor.getValue()));
      }
    } catch(e) { console.error("Ace init failed", e); }
  }
  initAce();

  document.getElementById('exec-type').addEventListener('change', (e) => {
    const map = {'js':'ace/mode/javascript','html':'ace/mode/html','md':'ace/mode/markdown','svg':'ace/mode/xml'};
    if (aceEditor) aceEditor.session.setMode(map[e.target.value]);
  });

  document.getElementById('btn-editor-mode').addEventListener('click', () => {
    const btn = document.getElementById('btn-editor-mode');
    if (!isEditorMode) {
      const current = memo.innerText;
      memo.style.display = 'none'; 
      highlightLayer.style.display = 'none';
      editorDiv.style.display = 'block';
      if(aceEditor) aceEditor.setValue(current, -1);
      isEditorMode = true; btn.textContent = "ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¢ãƒ¼ãƒ‰ ã‚ªãƒ•";
    } else {
      const current = aceEditor ? aceEditor.getValue() : "";
      editorDiv.style.display = 'none'; 
      memo.style.display = 'block';
      highlightLayer.style.display = 'block';
      memo.innerText = current;
      isEditorMode = false; btn.textContent = "ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¢ãƒ¼ãƒ‰ ã‚ªãƒ³";
      document.getElementById('search').dispatchEvent(new Event('input'));
    }
  });

  function getText() { return isEditorMode && aceEditor ? aceEditor.getValue() : memo.innerText; }
  function setText(text) { 
    if(isEditorMode && aceEditor) aceEditor.setValue(text, -1); 
    else {
      memo.innerText = text; 
      if(document.getElementById('search').value) updateHighlights();
    }
  }
  function updateHistory(text) {
    if (history[currentStep] !== text) {
      history = history.slice(0, currentStep + 1);
      history.push(text);
      currentStep++;
    }
    document.getElementById('char-count-btn').textContent = text.length;
  }

  /* -------------------------------------------------------------------------- */
  /* ãƒ‘ãƒãƒ« & ç”»é¢é·ç§»                                */
  /* -------------------------------------------------------------------------- */
  const panel = document.getElementById('settings-panel');
  const screens = document.querySelectorAll('.screen');
  const previewControls = document.getElementById('preview-controls');
  const expandBtn = document.getElementById('expand-btn');

  document.getElementById('settings-btn').addEventListener('click', () => { 
    panel.classList.add('open'); 
    showScreen('menu-screen'); 
    loadGhSettingsFromExt();
    updateTransformUI(); // UIçŠ¶æ…‹æ›´æ–°
  });
  document.querySelector('.panel-close').onclick = () => panel.classList.remove('open');
  
  function showScreen(id) {
    screens.forEach(s => s.classList.remove('active'));
    const target = document.getElementById(id);
    if(target) target.classList.add('active');
  }

  document.querySelectorAll('.back-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      showScreen(e.target.dataset.target || 'menu-screen');
    });
  });

  const bindScreen = (id, screen) => {
    const el = document.getElementById(id);
    if(el) el.onclick = () => showScreen(screen);
  };
  bindScreen('btn-transform', 'transform-screen');
  bindScreen('btn-import', 'import-screen');
  bindScreen('btn-export', 'export-screen');

  document.getElementById('btn-pc-view').onclick = () => {
    const meta = document.querySelector('meta[name="viewport"]');
    if (meta.content.includes('width=device-width')) {
      meta.content = 'width=2000, initial-scale=0.5';
      alert('PCè¡¨ç¤º(å¹…2000px)ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');
    } else {
      meta.content = 'width=device-width, initial-scale=1.0';
      alert('ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºã«æˆ»ã—ã¾ã—ãŸ');
    }
  };

  /* -------------------------------------------------------------------------- */
  /* å¤‰æ›æ©Ÿèƒ½ UIåˆ¶å¾¡ (è¦ä»¶1: ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ»å…¥åŠ›æ¬„ã®åˆ¶å¾¡)               */
  /* -------------------------------------------------------------------------- */
  const transRadios = document.querySelectorAll('input[name="trans-type"]');
  transRadios.forEach(radio => radio.addEventListener('change', updateTransformUI));

  function updateTransformUI() {
    const type = document.querySelector('input[name="trans-type"]:checked').value;
    
    // 1æ–‡ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹: ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤æ™‚ã®ã¿æœ‰åŠ¹
    const chkOneLine = document.getElementById('chk-one-line');
    const lblOneLine = document.getElementById('lbl-one-line');
    if (type === 'remove-comment') {
      chkOneLine.disabled = false;
      lblOneLine.classList.remove('disabled-input');
    } else {
      chkOneLine.disabled = true;
      chkOneLine.checked = false; // ç„¡åŠ¹æ™‚ã¯ãƒã‚§ãƒƒã‚¯å¤–ã™
      lblOneLine.classList.add('disabled-input');
    }

    // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›æ¬„: ã‚«ã‚¹ã‚¿ãƒ æ™‚ã®ã¿æœ‰åŠ¹
    const txtFrom = document.getElementById('trans-from');
    const txtTo = document.getElementById('trans-to');
    if (type === 'custom') {
      txtFrom.disabled = false;
      txtTo.disabled = false;
    } else {
      txtFrom.disabled = true;
      txtTo.disabled = true;
    }
  }

  /* -------------------------------------------------------------------------- */
  /* æ‹¡å¼µæ©Ÿèƒ½é€£æº                                    */
  /* -------------------------------------------------------------------------- */
  let ghConfig = null;

  function sendExtMessage(payload) {
    return new Promise((resolve, reject) => {
      const id = Date.now() + Math.random();
      let handled = false;
      const handler = (e) => {
        if (e.data && e.data.source === 'MEMO_EXTENSION' && e.data.id === id) {
          window.removeEventListener('message', handler);
          handled = true;
          resolve(e.data.payload);
        }
      };
      window.addEventListener('message', handler);
      window.postMessage({ source: 'MEMO_TOOL_V3', id, payload }, "*");
      setTimeout(() => {
        if (!handled) { window.removeEventListener('message', handler); reject('EXTENSION_TIMEOUT'); }
      }, 3000);
    });
  }

  async function loadGhSettingsFromExt() {
    try {
      const res = await sendExtMessage({ type: 'GET_SETTINGS' });
      const stat = document.getElementById('gh-status');
      if (res && res.githubToken) {
        const match = res.repoUrl.match(/github\.com\/([^\/]+)\/([^\/]+)/);
        if(match) {
          ghConfig = { 
            token: res.githubToken, 
            owner: match[1], 
            repo: match[2].replace(/(\.git)+$/, '').replace(/#.*$/, ''), 
            filename: res.fileName 
          };
          stat.textContent = "æ‹¡å¼µæ©Ÿèƒ½ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ";
          stat.style.color = "green";
        } else {
          stat.textContent = "ãƒªãƒã‚¸ãƒˆãƒªURLãŒç„¡åŠ¹ã§ã™";
        }
      } else {
        stat.textContent = "æ‹¡å¼µæ©Ÿèƒ½ã§è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„";
        stat.style.color = "red";
      }
    } catch(e) {
      const stat = document.getElementById('gh-status');
      if(stat) {
        stat.textContent = "æ‹¡å¼µæ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ç¢ºèª)";
        stat.style.color = "red";
      }
    }
  }
  
  loadGhSettingsFromExt();
  document.getElementById('btn-gh-connect').onclick = loadGhSettingsFromExt;

  /* -------------------------------------------------------------------------- */
  /* ãƒ‡ãƒ¼ã‚¿æ“ä½œ (Fetch / Save)                        */
  /* -------------------------------------------------------------------------- */
  let currentGitHubData = null; 
  let currentSha = null;

  async function fetchGitHubData() {
    if (!ghConfig) { await loadGhSettingsFromExt(); if(!ghConfig) return alert('GitHubè¨­å®šãŒã‚ã‚Šã¾ã›ã‚“'); }
    const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/${ghConfig.filename}`;
    
    try {
      const res = await sendExtMessage({ type: 'GITHUB_FETCH', url: url, token: ghConfig.token });
      if (res.ok || res.success) {
        currentSha = res.data.sha;
        const content = decodeURIComponent(escape(atob(res.data.content)));
        currentGitHubData = JSON.parse(content);
        if(!currentGitHubData.folders) currentGitHubData.folders = [];
        if(!currentGitHubData.candidates) currentGitHubData.candidates = [];
        return true;
      } else {
        alert('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + res.error);
        return false;
      }
    } catch(e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e); return false; }
  }

  async function saveToGitHub(msg) {
    if (!ghConfig || !currentGitHubData) return;
    const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/${ghConfig.filename}`;
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(currentGitHubData, null, 2))));
    
    const res = await sendExtMessage({
      type: 'GITHUB_FETCH', method: 'PUT', url: url, token: ghConfig.token,
      body: { message: msg, content: content, sha: currentSha }
    });
    
    if (res.ok || res.success) {
      currentSha = res.data.content.sha;
      return true;
    } else {
      alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + res.error);
      return false;
    }
  }

  /* -------------------------------------------------------------------------- */
  /* ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢æ©Ÿèƒ½ (ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æ–¹å¼)                  */
  /* -------------------------------------------------------------------------- */
  let searchIndex = 0;
  let searchMatches = [];
  let aceSearchResults = [];
  const searchInput = document.getElementById('search');
  let isComposing = false;

  memo.addEventListener('scroll', () => {
    highlightLayer.scrollTop = memo.scrollTop;
    highlightLayer.scrollLeft = memo.scrollLeft;
  });

  memo.addEventListener('input', () => {
    if (searchInput.value && !isComposing) updateHighlights();
  });

  searchInput.addEventListener('compositionstart', () => { isComposing = true; });
  searchInput.addEventListener('compositionend', () => { isComposing = false; searchInput.dispatchEvent(new Event('input')); });

  searchInput.addEventListener('input', () => {
    if (isComposing) return;
    searchIndex = 0;
    
    if (isEditorMode && aceEditor) {
      execAceSearch();
    } else {
      updateHighlights();
    }
  });

  function updateHighlights() {
    const searchTerm = searchInput.value;
    const text = memo.innerText;
    
    if (!searchTerm) {
      highlightLayer.innerHTML = '';
      document.getElementById('count').textContent = '0/0';
      searchMatches = [];
      return;
    }

    const escapedText = escapeHTML(text);
    const escapedTerm = escapeHTML(searchTerm); 
    const regex = new RegExp(escapeRegExp(escapedTerm), 'gi');
    
    let matchCount = 0;
    const html = escapedText.replace(regex, (match) => {
      matchCount++;
      return `<span class="highlight">${match}</span>`;
    });

    highlightLayer.innerHTML = html;
    searchMatches = highlightLayer.querySelectorAll('.highlight');
    document.getElementById('count').textContent = matchCount > 0 ? `1/${matchCount}` : '0/0';

    if (matchCount > 0) scrollToCurrentMatch();
  }

  function execAceSearch() {
    aceSearchResults = [];
    const searchTerm = searchInput.value;
    if (!searchTerm) {
      document.getElementById('count').textContent = '0/0';
      return;
    }
    const text = aceEditor.getValue();
    const regex = new RegExp(escapeRegExp(searchTerm), 'gi');
    let match;
    while ((match = regex.exec(text)) !== null) {
      aceSearchResults.push(match.index);
    }
    document.getElementById('count').textContent = aceSearchResults.length > 0 ? `1/${aceSearchResults.length}` : '0/0';
    if(aceSearchResults.length > 0) scrollToCurrentAceMatch();
  }

  document.getElementById('next').addEventListener('click', () => {
    if (isEditorMode) {
        if(aceSearchResults.length === 0) return;
        searchIndex = (searchIndex + 1) % aceSearchResults.length;
        scrollToCurrentAceMatch();
    } else {
        if (searchMatches.length === 0) return;
        searchIndex = (searchIndex + 1) % searchMatches.length;
        scrollToCurrentMatch();
    }
    updateCountLabel();
  });

  document.getElementById('prev').addEventListener('click', () => {
    if (isEditorMode) {
        if(aceSearchResults.length === 0) return;
        searchIndex = (searchIndex - 1 + aceSearchResults.length) % aceSearchResults.length;
        scrollToCurrentAceMatch();
    } else {
        if (searchMatches.length === 0) return;
        searchIndex = (searchIndex - 1 + searchMatches.length) % searchMatches.length;
        scrollToCurrentMatch();
    }
    updateCountLabel();
  });

  function updateCountLabel() {
    const len = isEditorMode ? aceSearchResults.length : searchMatches.length;
    if(len > 0) document.getElementById('count').textContent = `${searchIndex + 1}/${len}`;
  }

  function scrollToCurrentMatch() {
    const target = searchMatches[searchIndex];
    if (target) {
      const layerRect = highlightLayer.getBoundingClientRect();
      const targetRect = target.getBoundingClientRect();
      const relativeTop = targetRect.top - layerRect.top;
      memo.scrollTop = relativeTop + memo.scrollTop - (memo.clientHeight / 2);
    }
  }

  function scrollToCurrentAceMatch() {
    if(aceEditor && aceSearchResults[searchIndex] !== undefined) {
       const pos = aceEditor.session.doc.indexToPosition(aceSearchResults[searchIndex]);
       aceEditor.selection.moveToPosition(pos);
       aceEditor.centerSelection();
    }
  }

  document.getElementById('add-prefix-suffix').addEventListener('click', () => {
    const prefix = document.getElementById('prefix').value || "";
    const suffix = document.getElementById('suffix').value || "";
    const beforeText = getText();
    if (history[currentStep] !== beforeText) updateHistory(beforeText);

    if (isEditorMode && aceEditor) {
      const range = aceEditor.getSelectionRange();
      const doc = aceEditor.session.getDocument();
      for (let r = range.start.row; r <= range.end.row; r++) {
        let line = doc.getLine(r);
        aceEditor.session.replace(new ace.Range(r, 0, r, line.length), prefix + line + suffix);
      }
    } else {
      const sel = window.getSelection();
      let textToReplace = "";
      let range = null;

      if (sel.rangeCount && !sel.isCollapsed && memo.contains(sel.anchorNode)) {
        range = sel.getRangeAt(0);
        textToReplace = sel.toString();
      } else {
        textToReplace = memo.innerText;
      }

      if (textToReplace) {
        const lines = textToReplace.split(/\r?\n/);
        const newTextSegment = lines.map(line => prefix + line + suffix).join('\n');
        
        if (range) {
          range.deleteContents();
          range.insertNode(document.createTextNode(newTextSegment));
        } else {
          memo.innerText = newTextSegment;
        }
      }
    }
    updateHistory(getText());
    if(document.getElementById('search').value) updateHighlights();
  });

  document.getElementById('copy').addEventListener('click', () => {
    const text = getText();
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).catch(err => execCopyFallback(text));
    } else {
      execCopyFallback(text);
    }
  });

  function execCopyFallback(text) {
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
  }

  /* -------------------------------------------------------------------------- */
  /* å¤‰æ›æ©Ÿèƒ½: ã‚³ãƒ¡ãƒ³ãƒˆæ¤œå‡ºãƒ»ç¢ºèªãƒ»é©ç”¨                                */
  /* -------------------------------------------------------------------------- */
  document.getElementById('do-transform').onclick = () => executeTransform(false);
  document.getElementById('do-confirm-transform').onclick = () => executeTransform(true);
  
  let originalContent = null;
  // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªå¤‰æ›´ã®ãŸã‚ã«ã€spanã‚¿ã‚°ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©
  window.toggleHighlight = function(el) {
    el.classList.toggle('highlight-disabled');
  };

  function processComments(text, mode, removeNewlines) {
    let output = "";
    let i = 0;
    const len = text.length;

    const append = (str, isDeleted) => {
      if (mode === 'strip') {
        if (!isDeleted) output += str;
      } else {
        // markãƒ¢ãƒ¼ãƒ‰: å‰Šé™¤å¯¾è±¡ã‚’spanã§å›²ã‚€ (onclickä»˜ä¸)
        if (isDeleted) output += `<span class="highlight-delete" onclick="toggleHighlight(this)">${escapeHTML(str)}</span>`;
        else output += escapeHTML(str);
      }
    };

    while (i < len) {
      let isStartOfElement = (i === 0) || (['\n', '\r', ' ', '\t'].includes(text[i-1]));

      // 1. UserScript ãƒ–ãƒ­ãƒƒã‚¯ã®ä¿è­·
      if (isStartOfElement && text.startsWith("// ==UserScript==", i)) {
        let closeTag = "// ==/UserScript==";
        let endIdx = text.indexOf(closeTag, i + 17);
        if (endIdx === -1) {
           closeTag = "// ==UserScript==";
           endIdx = text.indexOf(closeTag, i + 17);
        }
        if (endIdx !== -1) {
          let contentEnd = endIdx + closeTag.length;
          let content = text.substring(i, contentEnd);
          append(content, false);
          i = contentEnd;
          continue;
        }
      }

      // 2. ãƒ–ãƒ­ãƒƒã‚¯ã‚³ãƒ¡ãƒ³ãƒˆ /* ... */
      if (isStartOfElement && text.startsWith("/*", i)) {
        let endIdx = text.indexOf("*/", i + 2);
        if (endIdx !== -1) {
          let content = text.substring(i, endIdx + 2);
          append(content, true);
          i = endIdx + 2;
          continue;
        }
      }

      // 3. è¡Œã‚³ãƒ¡ãƒ³ãƒˆ //
      if (isStartOfElement && text.startsWith("//", i)) {
          let eol = text.indexOf("\n", i);
          if (eol === -1) eol = len;
          let content = text.substring(i, eol);
          append(content, true);
          i = eol;
          continue;
      }

      // 4. æ”¹è¡Œå‰Šé™¤ï¼ˆ1æ–‡ãƒ¢ãƒ¼ãƒ‰ï¼‰
      // ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤æ™‚ã®1æ–‡ãƒã‚§ãƒƒã‚¯ã¯ã“ã“ã§å‡¦ç†
      if (removeNewlines && (text[i] === '\n' || text[i] === '\r')) {
          if (mode === 'mark') {
             append(text[i] === '\r' ? '' : 'â†µ\n', true);
          }
          i++;
          continue;
      }

      // é€šå¸¸æ–‡å­—
      append(text[i], false);
      i++;
    }
    return output;
  }

  function executeTransform(isConfirm) {
    const type = document.querySelector('input[name="trans-type"]:checked').value;
    const isOneLine = document.getElementById('chk-one-line').checked && !document.getElementById('chk-one-line').disabled;
    const customFrom = document.getElementById('trans-from').value;
    const customTo = document.getElementById('trans-to').value;
    const currentText = getText();
    let result = currentText;

    // å³æ™‚å®Ÿè¡Œã®ãƒ­ã‚¸ãƒƒã‚¯
    if (!isConfirm) {
      if (type === 'encode') result = encodeURIComponent(currentText);
      else if (type === 'decode') result = decodeURIComponent(currentText);
      else if (type === 'remove-comment') {
        result = processComments(currentText, 'strip', isOneLine);
      } else if (type === 'custom') {
        if(customFrom) result = currentText.split(customFrom).join(customTo);
      }
      // 1æ–‡ãƒã‚§ãƒƒã‚¯ãŒã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤ä»¥å¤–ãªã‚‰å¾Œå‡¦ç†ï¼ˆè¦ä»¶é€šã‚ŠUIåˆ¶å¾¡ã—ãŸãŒä¸€å¿œï¼‰
      if (type !== 'remove-comment' && isOneLine) {
          // â€»UIåˆ¶å¾¡ã§ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤ä»¥å¤–ã¯1æ–‡ãƒã‚§ãƒƒã‚¯ã§ããªã„ã‚ˆã†ã«ã—ãŸãŒã€
          // ä¸‡ãŒä¸€ã®å ´åˆã¯ã“ã“ã‚’é€šã‚‹å¯èƒ½æ€§ã‚ã‚Šã€‚ãŸã è¦ä»¶çš„ã«ã¯ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤æ™‚ã®ã¿ã€‚
      }
      setText(result);
      updateHistory(result);
      return;
    }

    // --- ç¢ºèªãƒ¢ãƒ¼ãƒ‰ (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼) ---
    originalContent = currentText;
    panel.classList.remove('open');
    previewControls.style.display = 'block'; // ãƒœã‚¿ãƒ³è¡¨ç¤º
    highlightLayer.style.display = 'none';

    if(isEditorMode && aceEditor) {
      // Aceã®å ´åˆã¯ç°¡æ˜“è¡¨ç¤ºã®ã¿ï¼ˆã‚¯ãƒªãƒƒã‚¯æ“ä½œã¯éå¯¾å¿œï¼‰
      // ãƒ­ã‚¸ãƒƒã‚¯è¨ˆç®—ã—ã¦è¡¨ç¤º
      if (type === 'encode') result = encodeURIComponent(currentText);
      else if (type === 'decode') result = decodeURIComponent(currentText);
      else if (type === 'remove-comment') result = processComments(currentText, 'strip', isOneLine);
      else if (type === 'custom' && customFrom) result = currentText.split(customFrom).join(customTo);
      aceEditor.setValue(result, -1); aceEditor.setReadOnly(true);
    } else {
      memo.contentEditable = false;
      memo.style.backgroundColor = "#eef";

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLã®ç”Ÿæˆ (onclickä»˜ä¸)
      if (type === 'remove-comment') {
          memo.innerHTML = processComments(currentText, 'mark', isOneLine);
      } 
      else if (type === 'custom' && !customTo && customFrom) {
           // ã‚«ã‚¹ã‚¿ãƒ å‰Šé™¤
           let tempHtml = escapeHTML(currentText);
           const safeFrom = escapeRegExp(customFrom);
           // å‰Šé™¤ç®‡æ‰€ã‚’èµ¤ã
           tempHtml = tempHtml.replace(new RegExp(safeFrom, 'g'), `<span class="highlight-delete" onclick="toggleHighlight(this)">$&</span>`);
           memo.innerHTML = tempHtml;
      } 
      else if (type === 'custom' && customFrom) {
           // ç½®æ› (é’ãƒãƒ¼ã‚«ãƒ¼) - å¤‰æ›å¾Œã‚’è¡¨ç¤ºã—ã€å…ƒãƒ‡ãƒ¼ã‚¿ã‚’dataå±æ€§ã«æŒã¤
           const parts = currentText.split(customFrom);
           const safeTo = escapeHTML(customTo);
           const safeFrom = escapeHTML(customFrom);
           // é’ãƒãƒ¼ã‚«ãƒ¼ã«ã¯ data-original ã‚’ä»˜ä¸ã—ã¦ã‚¯ãƒªãƒƒã‚¯æ™‚ã«å…ƒã«æˆ»ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹...
           // ã¨ã„ã†ã‚ˆã‚Šã€disableæ™‚ã¯å…ƒãƒ†ã‚­ã‚¹ãƒˆã«æˆ»ã™ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ã€‚
           // é’ãƒãƒ¼ã‚«ãƒ¼ï¼šè¡¨ç¤ºã¯NewTextã€‚ç„¡åŠ¹åŒ–æ™‚ã¯OldTextã«æˆ»ã™ã€‚
           memo.innerHTML = parts.map(p => escapeHTML(p)).join(`<span class="highlight-change" data-original="${safeFrom}" onclick="toggleHighlight(this)">${safeTo}</span>`);
      } else {
           // å…¨ä½“å¤‰æ›ç³»
           const safeResult = escapeHTML(type === 'encode' ? encodeURIComponent(currentText) : decodeURIComponent(currentText));
           const safeOriginal = escapeHTML(currentText);
           if (currentText !== safeResult) {
              memo.innerHTML = `<span class="highlight-change" data-original="${safeOriginal}" onclick="toggleHighlight(this)">${safeResult}</span>`;
           } else {
              memo.innerHTML = safeResult;
           }
      }
    }
  }

  // é©ç”¨ãƒœã‚¿ãƒ³ã®å‡¦ç†
  document.getElementById('apply-btn').onclick = () => {
    // ç¾åœ¨ã®memoå†…ã®HTMLã‚’è§£æã—ã¦çµæœæ–‡å­—åˆ—ã‚’æ§‹ç¯‰
    let finalString = "";
    
    // #memo ã®å­ãƒãƒ¼ãƒ‰ã‚’èµ°æŸ»
    const nodes = memo.childNodes;
    nodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        finalString += node.textContent;
      } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'SPAN') {
        const isDisabled = node.classList.contains('highlight-disabled');
        
        if (node.classList.contains('highlight-delete')) {
          // èµ¤ãƒãƒ¼ã‚«ãƒ¼: æœ‰åŠ¹ãªã‚‰å‰Šé™¤(è¿½åŠ ã—ãªã„)ã€ç„¡åŠ¹ãªã‚‰å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ(innerText)ã‚’è¿½åŠ 
          if (isDisabled) {
            finalString += node.innerText;
          }
        } else if (node.classList.contains('highlight-change')) {
          // é’ãƒãƒ¼ã‚«ãƒ¼: æœ‰åŠ¹ãªã‚‰ä»Šã®ãƒ†ã‚­ã‚¹ãƒˆ(innerText=å¤‰æ›å¾Œ)ã€ç„¡åŠ¹ãªã‚‰å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ(data-original)
          if (isDisabled) {
             finalString += (node.getAttribute('data-original') || node.innerText);
          } else {
             finalString += node.innerText;
          }
        } else {
          // ãã®ä»–ã®span
          finalString += node.innerText;
        }
      }
    });

    // ç¢ºå®šå‡¦ç†
    resetPreviewState();
    setText(finalString);
    updateHistory(finalString);
  };

  // å±•é–‹(ã‚­ãƒ£ãƒ³ã‚»ãƒ«)ãƒœã‚¿ãƒ³
  expandBtn.onclick = () => {
    if (originalContent !== null) {
      if(isEditorMode && aceEditor) {
        aceEditor.setValue(originalContent, -1); aceEditor.setReadOnly(false);
      } else {
        memo.innerText = originalContent; 
      }
      resetPreviewState();
    }
  };

  function resetPreviewState() {
    originalContent = null;
    memo.contentEditable = true;
    memo.style.backgroundColor = ""; 
    highlightLayer.style.display = 'block'; 
    previewControls.style.display = 'none';
    if(searchInput.value) updateHighlights();
  }

  /* -------------------------------------------------------------------------- */
  /* ã‚¤ãƒ³ãƒãƒ¼ãƒˆ / ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / å€™è£œ                  */
  /* -------------------------------------------------------------------------- */
  document.getElementById('btn-import-file').onclick = () => document.getElementById('file-input').click();
  document.getElementById('file-input').onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => { setText(reader.result); document.getElementById('import-url').value = file.name; };
    reader.readAsText(file);
  };

  document.getElementById('do-import-url').onclick = async () => {
    const url = document.getElementById('import-url').value;
    if(!url) return;
    let target = url;
    if(url.includes('github.com') && !url.includes('raw')) target = url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
    try {
      const res = await sendExtMessage({ type: 'FETCH_URL', url: target });
      if(res.success) setText(res.text); else alert('å¤±æ•—: '+res.error);
    } catch(e) { alert('æ‹¡å¼µæ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼: '+e); }
  };

  document.getElementById('do-export').onclick = () => {
    const name = document.getElementById('export-name').value || "memo";
    const ext = document.getElementById('export-ext').value || "txt";
    const blob = new Blob([getText()], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${name}.${ext}`;
    a.click();
    panel.classList.remove('open');
  };

  /* å€™è£œæ©Ÿèƒ½ */
  let selectedCandidateIdx = -1;
  function renderCandidates() {
    const list = document.getElementById('candidate-list');
    list.innerHTML = '';
    (currentGitHubData.candidates || []).forEach((c, i) => {
      const div = document.createElement('div');
      div.className = 'item';
      if(i === selectedCandidateIdx) div.classList.add('selected');
      div.innerText = c.name;
      div.onclick = () => {
        selectedCandidateIdx = i;
        showScreen('candidate-edit-screen');
        renderCandidateEdit();
      };
      list.appendChild(div);
    });
  }

  document.getElementById('btn-candidates').onclick = async () => {
    if (await fetchGitHubData()) {
      renderCandidates();
      showScreen('candidate-list-screen');
    }
  };

  function renderCandidateEdit() {
      const container = document.getElementById('candidate-edit-container');
      container.innerHTML = '';
      (currentGitHubData.candidates || []).forEach((c, i) => {
        const row = document.createElement('div');
        row.className = 'candidate-edit-row';
        row.innerHTML = `
          <input type="text" class="cand-name" value="${escapeHTML(c.name)}" placeholder="å€™è£œå">
          <input type="text" class="cand-url" value="${escapeHTML(c.url)}" placeholder="URL">
          <div class="candidate-buttons">
            <button class="cand-up" data-index="${i}">â†‘</button>
            <button class="cand-down" data-index="${i}">â†“</button>
            <button class="cand-del" data-index="${i}">å‰Šé™¤</button>
          </div>
        `;
        container.appendChild(row);
      });
      
      container.querySelectorAll('.cand-up').forEach(btn => {
        btn.onclick = (e) => {
          const index = parseInt(e.target.dataset.index);
          if (index > 0) {
            const arr = currentGitHubData.candidates;
            [arr[index], arr[index-1]] = [arr[index-1], arr[index]];
            renderCandidateEdit();
          }
        };
      });
      
      container.querySelectorAll('.cand-down').forEach(btn => {
        btn.onclick = (e) => {
          const index = parseInt(e.target.dataset.index);
          if (index < currentGitHubData.candidates.length - 1) {
            const arr = currentGitHubData.candidates;
            [arr[index], arr[index+1]] = [arr[index+1], arr[index]];
            renderCandidateEdit();
          }
        };
      });
      
      container.querySelectorAll('.cand-del').forEach(btn => {
        btn.onclick = (e) => {
          const index = parseInt(e.target.dataset.index);
          currentGitHubData.candidates.splice(index, 1);
          renderCandidateEdit();
        };
      });
  }

  document.getElementById('candidate-add-row').onclick = () => {
    if (!currentGitHubData.candidates) currentGitHubData.candidates = [];
    currentGitHubData.candidates.push({ name: '', url: '' });
    renderCandidateEdit();
  };

  document.getElementById('save-candidates').onclick = async () => {
    const rows = document.querySelectorAll('#candidate-edit-container .candidate-edit-row');
    rows.forEach((row, i) => {
      const name = row.querySelector('.cand-name').value;
      const url = row.querySelector('.cand-url').value;
      if (currentGitHubData.candidates[i]) {
        currentGitHubData.candidates[i].name = name;
        currentGitHubData.candidates[i].url = url;
      }
    });
    currentGitHubData.candidates = currentGitHubData.candidates.filter(c => c.name.trim() !== '' || c.url.trim() !== '');
    
    if (await saveToGitHub("Update candidates")) {
      renderCandidates();
      showScreen('candidate-list-screen');
    }
  };

  /* -------------------------------------------------------------------------- */
  /* ãƒ¡ãƒ¢ä¸€è¦§ãƒ»ä¿å­˜ãƒ»ãƒ„ãƒªãƒ¼                           */
  /* -------------------------------------------------------------------------- */
  let currentPath = [];
  let editSelectedIdx = -1;

  function getFolder(root, path) {
    let target = { children: root };
    for (const p of path) {
      if (!target.children) return null;
      target = target.children.find(c => c.type === 'folder' && c.name === p);
      if (!target) return null;
    }
    return target;
  }

  function renderTree(container, folders, mode = 'view') {
    container.innerHTML = '';
    
    if (currentPath.length > 0) {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<span class="folder-icon">ğŸ“</span> .. (ä¸Šã®éšå±¤ã¸)`;
      div.onclick = () => {
        currentPath.pop();
        renderTree(container, folders, mode);
      };
      container.appendChild(div);
    }

    const currentFolder = getFolder(folders, currentPath);
    if (!currentFolder || !currentFolder.children) return;

    currentFolder.children.forEach((node, index) => {
      const div = document.createElement('div');
      div.className = 'item';
      
      if (node.type === 'folder') {
        div.innerHTML = `<span class="folder-icon">ğŸ“</span> ${escapeHTML(node.name)}`;
        if (mode === 'view') {
          div.onclick = () => {
            currentPath.push(node.name);
            renderTree(container, folders, mode);
          };
        }
      } else {
        div.innerHTML = `<span class="memo-icon">ğŸ“‹ï¸</span> ${escapeHTML(node.name)}`;
        if (mode === 'view') {
          div.onclick = () => {
            setText(node.content);
            titleInput.value = node.name;
            panel.classList.remove('open');
          };
        }
      }

      if (mode === 'edit') {
        if(index === editSelectedIdx) div.classList.add('selected');
        div.onclick = (e) => {
           if (!e.target.classList.contains('folder-icon') && !e.target.classList.contains('memo-icon')) {
             editSelectedIdx = index;
             document.getElementById('edit-name-input').value = node.name;
             const enterBtn = document.getElementById('edit-enter-folder');
             enterBtn.style.display = (node.type === 'folder') ? 'inline-block' : 'none';
             renderEditTree();
           }
        };
      }
      container.appendChild(div);
    });
    
    if (mode === 'view' && currentGitHubData.tempMemo) {
      const tempDiv = document.getElementById('temp-memo-item');
      tempDiv.onclick = () => {
        setText(currentGitHubData.tempMemo);
        titleInput.value = "ä¸€æ™‚ãƒ¡ãƒ¢";
        panel.classList.remove('open');
      };
    }
  }

  document.getElementById('btn-memo-list').onclick = async () => {
    if (await fetchGitHubData()) {
      currentPath = [];
      renderTree(document.getElementById('memo-tree-view'), currentGitHubData.folders, 'view');
      showScreen('list-screen');
    }
  };

  document.getElementById('btn-edit-mode').onclick = () => {
    editSelectedIdx = -1;
    renderEditTree();
    showScreen('list-edit-ui');
  };

  function renderEditTree() {
    renderTree(document.getElementById('memo-tree-edit'), currentGitHubData.folders, 'edit');
  }

  document.getElementById('edit-copy').onclick = () => {
    if(editSelectedIdx >= 0) {
      const folder = getFolder(currentGitHubData.folders, currentPath);
      const node = JSON.parse(JSON.stringify(folder.children[editSelectedIdx]));
      node.name += " - ã‚³ãƒ”ãƒ¼";
      folder.children.splice(editSelectedIdx + 1, 0, node);
      editSelectedIdx++; renderEditTree();
    }
  };
  document.getElementById('edit-del').onclick = () => {
    if(editSelectedIdx >= 0) {
      const folder = getFolder(currentGitHubData.folders, currentPath);
      folder.children.splice(editSelectedIdx, 1);
      editSelectedIdx = -1; renderEditTree();
    }
  };
  document.getElementById('edit-enter-folder').onclick = () => {
    if(editSelectedIdx >= 0) {
      const folder = getFolder(currentGitHubData.folders, currentPath);
      const target = folder.children[editSelectedIdx];
      if (target && target.type === 'folder') {
        currentPath.push(target.name);
        editSelectedIdx = -1;
        renderEditTree();
      }
    }
  };
  document.getElementById('edit-rename').onclick = () => {
    if(editSelectedIdx >= 0) {
      const newName = document.getElementById('edit-name-input').value.trim();
      if (!newName) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      const folder = getFolder(currentGitHubData.folders, currentPath);
      folder.children[editSelectedIdx].name = newName;
      renderEditTree();
    }
  };

  document.getElementById('list-save-btn').onclick = async () => {
    if (await saveToGitHub("Update structure")) {
      currentPath = [];
      renderTree(document.getElementById('memo-tree-view'), currentGitHubData.folders, 'view');
      showScreen('list-screen');
    }
  };

  /* -------------------------------------------------------------------------- */
  /* ãƒ¡ãƒ¢ä¿å­˜æ©Ÿèƒ½                                   */
  /* -------------------------------------------------------------------------- */
  document.getElementById('btn-memo-save').onclick = async () => {
    if (await fetchGitHubData()) {
      currentPath = [];
      document.getElementById('save-title').value = titleInput.value;
      renderTree(document.getElementById('save-tree-view'), currentGitHubData.folders, 'save');
      showScreen('save-screen');
    }
  };

  document.getElementById('do-save-memo').onclick = async () => {
    const title = document.getElementById('save-title').value;
    if (!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    const folder = getFolder(currentGitHubData.folders, currentPath);
    if (!folder.children) folder.children = [];
    
    const existingIdx = folder.children.findIndex(c => c.type === 'memo' && c.name === title);
    if (existingIdx >= 0) {
      if (!confirm("åŒã˜ã‚¿ã‚¤ãƒˆãƒ«åã®ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã™ã€‚ä¸Šæ›¸ãä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return;
      folder.children[existingIdx].content = getText();
    } else {
      folder.children.push({ type: 'memo', name: title, content: getText() });
    }
    
    if (await saveToGitHub(`Save memo: ${title}`)) {
      alert("ä¿å­˜ã—ã¾ã—ãŸ");
      titleInput.value = title;
    }
  };

  document.getElementById('do-save-temp').onclick = async () => {
    currentGitHubData.tempMemo = getText();
    if (await saveToGitHub("Update temp memo")) {
      alert("ä¸€æ™‚ä¿å­˜ã—ã¾ã—ãŸ");
    }
  };

  /* -------------------------------------------------------------------------- */
  /* ãã®ä»– / å®Ÿè¡Œ / +ãƒœã‚¿ãƒ³                           */
  /* -------------------------------------------------------------------------- */
  document.getElementById('clear').onclick=()=>{setText(''); titleInput.value='';};
  document.getElementById('undo').onclick=()=>{if(currentStep>0){currentStep--;setText(history[currentStep]);}};
  document.getElementById('redo').onclick=()=>{if(currentStep<history.length-1){currentStep++;setText(history[currentStep]);}};

  document.getElementById('do-exec').onclick = () => {
    const type = document.getElementById('exec-type').value;
    let code = "";
    if (isEditorMode && aceEditor) {
      code = aceEditor.getSelectedText() || aceEditor.getValue();
    } else {
      const sel = window.getSelection();
      code = (sel.rangeCount && !sel.isCollapsed && memo.contains(sel.anchorNode)) ? sel.toString() : memo.innerText;
    }

    if (type === 'js') {
      try { new Function(code)(); } catch(e) { alert(e); }
    } else {
      const w = window.open();
      const content = type === 'md' ? marked.parse(code) : code;
      w.document.write(content);
      w.document.close();
    }
  };

  document.getElementById('open-url').onclick = () => {
    window.open('https://gadget-otaku.github.io/Bookmarklet/HTML%E5%88%B6%E4%BD%9C/%E3%83%A1%E3%83%A2%E5%B8%B33.0', '_blank');
  };

  // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
  function escapeHTML(s) { return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m])); }
  function escapeRegExp(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

}); // End DOMContentLoaded
</script>
</body>
</html>
