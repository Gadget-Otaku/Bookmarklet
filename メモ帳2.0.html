<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¡ãƒ¢ãƒ„ãƒ¼ãƒ«</title>
  <style>
    html, body { height: 100%; margin: 0; padding: 18px; box-sizing: border-box; }
    body { display: flex; flex-direction: column; font-family: sans-serif; }
    .controls { flex: 0 0 auto; margin-bottom: 10px; }
    .controls button, .controls input {
      margin-right: 5px;
      padding: 8px 8px;
      font-size: 12px;
    }
    #memo {
      flex: 1 1 auto;
      width: 100%;
      border: 1px solid #ccc;
      padding: 10px;
      overflow: auto;
      white-space: pre-wrap;
      font-family: monospace;
    }
    .highlight { background-color: yellow; }
    #transform-window {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 1px solid #ccc;
      padding: 20px;
      z-index: 1000;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    #transform-window label {
      display: block;
      margin: 10px 0 5px;
    }
    #transform-window input[type="text"] {
      width: 100%;
      padding: 5px;
      margin-bottom: 10px;
    }
    #transform-window button {
      padding: 5px 10px;
      margin-right: 5px;
    }
    #close-transform {
      position: absolute;
      top: 5px;
      right: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    #download-window {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 1px solid #ccc;
      padding: 20px;
      z-index: 1000;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    #close-download {
      float: right;
    }
  </style>
</head>
<body>
  <div class="controls">
    <button id="undo">â†</button>
    <button id="redo">â†’</button>
    <button id="clear">ã‚¯ãƒªã‚¢</button>
    <button id="copy">ã‚³ãƒ”ãƒ¼</button>
    <input id="search" type="text" placeholder="ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢">
    <button id="prev"><</button>
    <span id="count">0/0</span>
    <button id="next">></button>
    <input id="prefix" type="text" placeholder="å§‹ã‚">
    <input id="suffix" type="text" placeholder="çµ‚ã‚ã‚Š">
    <button id="add-prefix-suffix">è¿½åŠ </button>
    <button id="exec-js">JavaScriptã‚’å®Ÿè¡Œ</button>
    <button id="exec-html">HTMLã‚’å®Ÿè¡Œ</button>
    <button id="exec-bm">â–½</button>
    <button id="transform">â˜…</button> <!-- æ˜Ÿãƒœã‚¿ãƒ³ -->
    <button id="open-url">ï¼‹</button>
    <button id="download-btn">ğŸ–¥ï¸</button>

    <!-- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
    <div id="download-window">
      <button id="close-download">â˜’</button>
      <div>
        <label>ãƒ•ã‚¡ã‚¤ãƒ«å</label><br>
        <input id="filename" type="text" placeholder="example"><br><br>
        <label>æ‹¡å¼µå­</label><br>
        <input id="extension" type="text" placeholder="txt"><br><br>
        <button id="save-file">ä¿å­˜</button>
      </div>
    </div>

    <!-- å¤‰æ›ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
    <div id="transform-window">
      <div id="close-transform">â˜’</div>
      <label>
        <input type="radio" name="action" value="encode" checked> ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
      </label>
      <label>
        <input type="radio" name="action" value="decode"> ãƒ‡ã‚³ãƒ¼ãƒ‰
      </label>
      <label>
        <input type="radio" name="action" value="remove"> ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤
      </label>
      <label>
        <input type="radio" name="action" value="remove1"> ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤(1æ–‡)
      </label>
      <label>
        <input type="radio" name="action" value="custom"> ã‚«ã‚¹ã‚¿ãƒ 
      </label>
      <div id="customMapping" style="display: none;">
        <label for="customFrom">ã‚«ã‚¹ã‚¿ãƒ å¤‰æ› (å¤‰æ›å…ƒ â†’ å¤‰æ›å…ˆ)</label>
        <input type="text" id="customFrom" placeholder="å¤‰æ›å…ƒ">
        <input type="text" id="customTo" placeholder="å¤‰æ›å…ˆ">
      </div>
      <button id="convertButton">å¤‰æ›</button>
    </div>
  </div>
  <div id="memo" contenteditable="true"></div>

  <script>
    const memo = document.getElementById('memo');
    const undoBtn = document.getElementById('undo');
    const redoBtn = document.getElementById('redo');
    const clearBtn = document.getElementById('clear');
    const copyBtn = document.getElementById('copy');
    const searchInput = document.getElementById('search');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const countSpan = document.getElementById('count');
    const execJsBtn = document.getElementById('exec-js');
    const execHtmlBtn = document.getElementById('exec-html');
    const execBmBtn = document.getElementById('exec-bm');
    const openUrlBtn = document.getElementById('open-url');
    const transformBtn = document.getElementById('transform');
    const transformWindow = document.getElementById('transform-window');
    const closeTransform = document.getElementById('close-transform');
    const convertButton = document.getElementById('convertButton');
    const customMapping = document.getElementById('customMapping');
    const customFrom = document.getElementById('customFrom');
    const customTo = document.getElementById('customTo');
    const prefixInput = document.getElementById('prefix');
    const suffixInput = document.getElementById('suffix');
    const addPrefixSuffixBtn = document.getElementById('add-prefix-suffix');
    const downloadBtn = document.getElementById('download-btn');
    const downloadWindow = document.getElementById('download-window');
    const closeDownload = document.getElementById('close-download');
    const saveFileBtn = document.getElementById('save-file');
    const filenameInput = document.getElementById('filename');
    const extensionInput = document.getElementById('extension');

    let rawText = memo.innerText;
    let matches = [];
    let currentIndex = 0;
    let history = [memo.innerText];
    let currentStep = 0;

    // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›æ™‚ã®å±¥æ­´æ›´æ–°
    memo.addEventListener('input', () => {
      const newText = memo.innerText;
      if (newText !== history[currentStep]) {
        history = history.slice(0, currentStep + 1);
        history.push(newText);
        currentStep++;
      }
      rawText = newText;
      countSpan.innerText = '0/0';
    });

    // ãƒšãƒ¼ã‚¹ãƒˆæ™‚ã®å‡¦ç†
    memo.addEventListener('paste', (e) => {
      e.preventDefault();
      const text = e.clipboardData.getData('text/plain');
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      const range = selection.getRangeAt(0);
      range.deleteContents();
      range.insertNode(document.createTextNode(text));
      rawText = memo.innerText;
      history = history.slice(0, currentStep + 1);
      history.push(rawText);
      currentStep++;
    });

    // Undoæ©Ÿèƒ½
    undoBtn.addEventListener('click', () => {
      if (currentStep > 0) {
        currentStep--;
        const state = history[currentStep];
        memo.innerText = state;
        rawText = state;
        clearHighlights();
      }
    });

    // Redoæ©Ÿèƒ½
    redoBtn.addEventListener('click', () => {
      if (currentStep < history.length - 1) {
        currentStep++;
        const state = history[currentStep];
        memo.innerText = state;
        rawText = state;
        clearHighlights();
      }
    });

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤
    function clearHighlights() {
      memo.innerText = rawText;
      matches = [];
      currentIndex = 0;
      countSpan.innerText = '0/0';
    }

    // ã‚¯ãƒªã‚¢æ©Ÿèƒ½
    clearBtn.addEventListener('click', () => {
      history = [''];
      currentStep = 0;
      rawText = '';
      memo.innerText = '';
      clearHighlights();
    });

    // ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
    copyBtn.addEventListener('click', () => {
      const ta = document.createElement('textarea');
      ta.value = rawText;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    });

    // æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½
    function highlightSearch() {
      clearHighlights();
      const term = searchInput.value.trim();
      if (!term) return;
      const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp(escapedTerm, 'gi');
      const escaped = escapeHTML(rawText);
      const highlighted = escaped.replace(regex, match => `<span class="highlight">${match}</span>`);
      memo.innerHTML = highlighted;
      matches = Array.from(memo.querySelectorAll('.highlight'));
      if (matches.length) {
        currentIndex = 0;
        matches[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        countSpan.innerText = `${currentIndex + 1}/${matches.length}`;
      }
    }

    function escapeHTML(s) {
      return s.replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;');
    }

    searchInput.addEventListener('input', highlightSearch);
    prevBtn.addEventListener('click', () => {
      if (!matches.length) return;
      currentIndex = (currentIndex - 1 + matches.length) % matches.length;
      matches[currentIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
      countSpan.innerText = `${currentIndex + 1}/${matches.length}`;
    });
    nextBtn.addEventListener('click', () => {
      if (!matches.length) return;
      currentIndex = (currentIndex + 1) % matches.length;
      matches[currentIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
      countSpan.innerText = `${currentIndex + 1}/${matches.length}`;
    });

    // JavaScriptå®Ÿè¡Œ
    execJsBtn.addEventListener('click', () => {
      let code = '';
      const sel = window.getSelection();
      if (sel.rangeCount && memo.contains(sel.anchorNode)) {
        code = sel.toString();
      }
      if (!code) code = rawText;
      try {
        const result = new Function(code)();
        if (result !== undefined) alert(result);
      } catch (e) {
        alert('Error: ' + e);
      }
    });

    // HTMLå®Ÿè¡Œ
    execHtmlBtn.addEventListener('click', () => {
      let html = '';
      const sel = window.getSelection();
      if (sel.rangeCount && memo.contains(sel.anchorNode)) {
        html = sel.toString();
      }
      if (!html) html = rawText;
      const w = window.open();
      w.document.open();
      w.document.write(html);
      w.document.close();
    });

    // â–½ãƒœã‚¿ãƒ³ï¼ˆãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼‰
    execBmBtn.addEventListener('click', () => {
    javascript:(function() {const panel = document.createElement('div');panel.style = 'position:fixed;top:10px;left:10px;background:white;border:1px solid black;padding:10px;z-index:9999;box-shadow:0 0 10px rgba(0,0,0,0.3);font-family:Arial, sans-serif;';document.body.appendChild(panel);const closeButton = document.createElement('button');closeButton.textContent = 'â˜’';closeButton.onclick = () => document.body.removeChild(panel);closeButton.style = 'float:right;background:transparent;border:none;font-size:16px;cursor:pointer;';panel.appendChild(closeButton);function createItem(data, container) {if (data.children && data.children.length > 0) {const folder = document.createElement('div');const folderBtn = document.createElement('button');folderBtn.textContent = 'â–½ ' + data.name;folderBtn.style = 'display:block;margin:5px 0;background:#ADD8E6;color:black;padding:5px 10px;width:100%;text-align:left;border:none;cursor:pointer;';const childContainer = document.createElement('div');childContainer.style.display = 'none';folder.appendChild(folderBtn);folder.appendChild(childContainer);folderBtn.onclick = function() {childContainer.style.display = childContainer.style.display === 'none' ? 'block' : 'none';folderBtn.textContent = (childContainer.style.display === 'none' ? 'â–½ ' : 'â–³ ') + data.name;};data.children.forEach(child => createItem(child, childContainer));container.appendChild(folder);} else {const btn = document.createElement('button');btn.textContent = data.name;btn.style = 'display:block;margin:5px 0;background:#4a90e2;color:white;padding:5px 10px;width:100%;text-align:left;border:none;cursor:pointer;';btn.onclick = function() {try {eval(data.script);} catch(e) {console.error('ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', e);}panel.style.display = 'none';};container.appendChild(btn);}}createItem({"name":"ãƒ¡ãƒ¢å¸³","script":"","children":[{"name":"ãƒ¡ãƒ¢å¸³(github)","script":"javascript:(function(){window.open('https://github.com/Gadget-Otaku/Bookmarklet/blob/main/%E3%83%A1%E3%83%A2%E5%B8%B32.0.html', '_blank');})();","children":[]},{"name":"ãƒ¡ãƒ¢å¸³ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼","script":"javascript:(function(){window.open('https://gadget-otaku.github.io/Bookmarklet/%E3%83%A1%E3%83%A2%E5%B8%B3%E3%82%A8%E3%83%87%E3%82%A3%E3%82%BF%E3%83%BC', '_blank');})();","children":[]}]}, panel);createItem({"name":"ãƒ„ãƒ¼ãƒ«ãƒ‘ãƒãƒ«","script":"","children":[{"name":"ãƒ„ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ç”Ÿæˆï¼†ç·¨é›†ã‚µã‚¤ãƒˆ","script":"javascript:(function(){window.open('https://sites.google.com/view/toolpaneleditor/ãƒ›ãƒ¼ãƒ ','_blank');})();","children":[]},{"name":"Github ãƒ„ãƒ¼ãƒ«ãƒ‘ãƒãƒ« JavaScript","script":"javascript:(function(){window.open('https://github.com/Gadget-Otaku/Bookmarklet/blob/main/%E3%83%84%E3%83%BC%E3%83%AB%E3%83%91%E3%83%8D%E3%83%AB2.1.js', '_blank');})();","children":[]}]}, panel);createItem({"name":"UserScriptç”Ÿæˆãƒ»ç·¨é›†ã‚µã‚¤ãƒˆ","script":"javascript:(function(){window.open('https://sites.google.com/view/userscriptgenerator/%E3%83%9B%E3%83%BC%E3%83%A0','_blank');})();","children":[]}, panel);createItem({"name":"GreasyFork","script":"javascript:(function(){window.open('https://greasyfork.org/ja/users/1433480-ã‚¹ãƒãƒ›ã‚ªã‚¿ã‚¯ã«ã‚ã‹','_blank');})();","children":[]}, panel);createItem({"name":"Github","script":"","children":[{"name":"Githubã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰","script":"javascript:(function(){window.open('https://github.com/Gadget-Otaku/Bookmarklet/upload/main','_blank');})();","children":[]},{"name":"HTMLãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰URLã«é£›ã¶","script":"javascript:(function(){\n              if (window._bmUI4) return;\n              window._bmUI4 = true;\n    \n              const style = `\n                #bm4-generator {\n                  position: fixed;\n                  top: 20px;\n                  left: 20px;\n                  background: white;\n                  border: 1px solid #ccc;\n                  padding: 10px;\n                  z-index: 99999;\n                  font-family: sans-serif;\n                  box-shadow: 2px 2px 10px rgba(0,0,0,0.2);\n                }\n                #bm4-generator input {\n                  width: 300px;\n                  padding: 5px;\n                  margin: 5px 0;\n                }\n                #bm4-generator button {\n                  padding: 5px 10px;\n                  margin-right: 5px;\n                }\n                #bm4-close {\n                  position: absolute;\n                  top: 5px;\n                  right: 5px;\n                  cursor: pointer;\n                  font-weight: bold;\n                }\n              `;\n    \n              const html = `\n                <div id=\"bm4-generator\">\n                  <div id=\"bm4-close\">â˜’</div>\n                  <input id=\"bm4-text\" type=\"text\" placeholder=\"ãƒ•ã‚¡ã‚¤ãƒ«å å…¥åŠ›æ¬„\" />\n                  <br/>\n                  <button id=\"bm4-search\">æ¤œç´¢</button>\n                </div>\n              `;\n    \n              const styleTag = document.createElement('style');\n              styleTag.textContent = style;\n              document.head.appendChild(styleTag);\n    \n              const container = document.createElement('div');\n              container.innerHTML = html;\n              document.body.appendChild(container);\n    \n              const closeUI = () => {\n                container.remove();\n                styleTag.remove();\n                delete window._bmUI4;\n              };\n    \n              document.getElementById('bm4-close').onclick = closeUI;\n    \n              document.getElementById('bm4-search').onclick = () => {\n                const filename = document.getElementById('bm4-text').value.trim();\n                if (!filename) return alert(\"ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\");\n                const url = 'https://gadget-otaku.github.io/Bookmarklet/' + encodeURIComponent(filename);\n                window.open(url, '_blank');\n                closeUI();\n              };\n            })();","children":[]},{"name":"Githubãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§","script":"javascript:(function(){window.open('https://github.com/Gadget-Otaku/Bookmarklet', '_blank');})();","children":[]}]}, panel);createItem({"name":"æ–‡å­—æ¯”è¼ƒ","script":"javascript:(function(){window.open('https://difff.jp/','_blank');})();","children":[]}, panel);createItem({"name":"å®šå‹æ–‡","script":"","children":[{"name":"execommand(copy)å®šå‹æ–‡","script":"javascript:(function(){const t=document.createElement('textarea');t.value='ã‚³ãƒ”ãƒ¼ã¯å¿…ãšexecommand(coppy)ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚';document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);})();","children":[]},{"name":"â˜’ã®èª¬æ˜å®šå‹æ–‡","script":"javascript:(function(){const t=document.createElement('textarea');t.value='â˜’ã‚’æŠ¼ã™ã¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒéè¡¨ç¤ºã«ãªã‚Šã¾ã™';document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);})();","children":[]},{"name":"çœç•¥ã›ãšå®Œæˆç‰ˆã‚’ä½œã£ã¦ã»ã—ã„","script":"javascript:(function(){const t=document.createElement('textarea');t.value='çœç•¥ã›ãšã€å®Œæˆç‰ˆã‚’ä½œã£ã¦ã»ã—ã„';document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);})();","children":[]}]}, panel);createItem({"name":"ç°¡æ˜“ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆä½œæˆ","script":"","children":[{"name":"å®šå‹æ–‡ã‚³ãƒ”ãƒ¼ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç”Ÿæˆ","script":"javascript:(function(){\n              if (window._bmUI3) return;\n              window._bmUI3 = true;\n    \n              const style = `\n                #bm3-generator {\n                  position: fixed;\n                  top: 20px;\n                  left: 20px;\n                  background: white;\n                  border: 1px solid #ccc;\n                  padding: 10px;\n                  z-index: 99999;\n                  font-family: sans-serif;\n                  box-shadow: 2px 2px 10px rgba(0,0,0,0.2);\n                }\n                #bm3-generator input {\n                  width: 300px;\n                  padding: 5px;\n                  margin: 5px 0;\n                }\n                #bm3-generator button {\n                  padding: 5px 10px;\n                  margin-right: 5px;\n                }\n                #bm3-close {\n                  position: absolute;\n                  top: 5px;\n                  right: 5px;\n                  cursor: pointer;\n                  font-weight: bold;\n                }\n              `;\n    \n              const html = `\n                <div id=\"bm3-generator\">\n                  <div id=\"bm3-close\">â˜’</div>\n                  <input id=\"bm3-text\" type=\"text\" placeholder=\"æŒ‡å®šæ–‡è¨€ å…¥åŠ›æ¬„\" />\n                  <br/>\n                  <button id=\"bm3-copy\">ã‚³ãƒ”ãƒ¼</button>\n                </div>\n              `;\n    \n              const styleTag = document.createElement('style');\n              styleTag.textContent = style;\n              document.head.appendChild(styleTag);\n    \n              const container = document.createElement('div');\n              container.innerHTML = html;\n              document.body.appendChild(container);\n    \n              document.getElementById('bm3-close').onclick = () => {\n                container.remove();\n                styleTag.remove();\n                delete window._bmUI3;\n              };\n    \n              document.getElementById('bm3-copy').onclick = () => {\n                const text = document.getElementById('bm3-text').value;\n                if (!text) return alert(\"æ–‡è¨€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\");\n    \n                const escaped = text.replace(/\\\\/g, '\\\\\\\\').replace(/'/g, \"\\\\'\");\n                const bookmarklet = `javascript:(function(){const t=document.createElement('textarea');t.value='${escaped}';document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);})();`;\n    \n                const textarea = document.createElement('textarea');\n                textarea.value = bookmarklet;\n                document.body.appendChild(textarea);\n                textarea.select();\n                document.execCommand('copy');\n                document.body.removeChild(textarea);\n                alert(\"æ–‡è¨€ã‚³ãƒ”ãƒ¼ç”¨ã®ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ\");\n              };\n            })();","children":[]},{"name":"æ–°ã—ãã‚¿ãƒ–ã‚’é–‹ããƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç”Ÿæˆ","script":"javascript:(function(){\n              if (window._bmUI) return;\n              window._bmUI = true;\n    \n              const style = `\n                #bm-generator {\n                  position: fixed;\n                  top: 20px;\n                  left: 20px;\n                  background: white;\n                  border: 1px solid #ccc;\n                  padding: 10px;\n                  z-index: 99999;\n                  font-family: sans-serif;\n                  box-shadow: 2px 2px 10px rgba(0,0,0,0.2);\n                }\n                #bm-generator input {\n                  width: 300px;\n                  padding: 5px;\n                  margin: 5px 0;\n                }\n                #bm-generator button {\n                  padding: 5px 10px;\n                  margin-right: 5px;\n                }\n                #bm-close {\n                  position: absolute;\n                  top: 5px;\n                  right: 5px;\n                  cursor: pointer;\n                  font-weight: bold;\n                }\n              `;\n    \n              const html = `\n                <div id=\"bm-generator\">\n                  <div id=\"bm-close\">â˜’</div>\n                  <input id=\"bm-url\" type=\"text\" placeholder=\"URL å…¥åŠ›æ¬„\" />\n                  <br/>\n                  <button id=\"bm-copy\">ã‚³ãƒ”ãƒ¼</button>\n                </div>\n              `;\n    \n              const styleTag = document.createElement('style');\n              styleTag.textContent = style;\n              document.head.appendChild(styleTag);\n    \n              const container = document.createElement('div');\n              container.innerHTML = html;\n              document.body.appendChild(container);\n    \n              document.getElementById('bm-close').onclick = () => {\n                container.remove();\n                styleTag.remove();\n                delete window._bmUI;\n              };\n    \n              document.getElementById('bm-copy').onclick = () => {\n                const url = document.getElementById('bm-url').value.trim();\n                if (!url) return alert(\"URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\");\n                const bookmarklet = `javascript:(function(){window.open('${url.replace(/'/g, \"\\\\'\")}', '_blank');})();`;\n    \n                const textarea = document.createElement('textarea');\n                textarea.value = bookmarklet;\n                document.body.appendChild(textarea);\n                textarea.select();\n                document.execCommand('copy');\n                document.body.removeChild(textarea);\n                alert(\"ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ\");\n              };\n            })();","children":[]}]}, panel);document.addEventListener('click', function(e) {if (!panel.contains(e.target)) {panel.style.display = 'none';}}, { capture: true });})();
    });

    // æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
    openUrlBtn.addEventListener('click', () => {
      window.open(location.href, '_blank');
    });

    // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒ»ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹è¿½åŠ 
    addPrefixSuffixBtn.addEventListener('click', () => {
      const sel = window.getSelection();
      if (!sel.rangeCount || !memo.contains(sel.anchorNode)) return;
      const range = sel.getRangeAt(0);
      const selectedText = sel.toString();
      if (!selectedText) return;
      const prefix = prefixInput.value ?? '';
      const suffix = suffixInput.value ?? '';
      const lines = selectedText.split('\n');
      const modified = lines.map(line => prefix + line + suffix).join('\n');
      range.deleteContents();
      range.insertNode(document.createTextNode(modified));
      rawText = memo.innerText;
      history = history.slice(0, currentStep + 1);
      history.push(rawText);
      currentStep++;
    });

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
    downloadBtn.addEventListener('click', () => {
      downloadWindow.style.display = 'block';
    });

    closeDownload.addEventListener('click', () => {
      downloadWindow.style.display = 'none';
    });

    saveFileBtn.addEventListener('click', () => {
      const name = filenameInput.value.trim();
      const ext = extensionInput.value.trim().replace(/^\./, '');
      if (!name || !ext) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«åã¨æ‹¡å¼µå­ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      const blob = new Blob([memo.innerText], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${name}.${ext}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      downloadWindow.style.display = 'none';
    });

    // æ˜Ÿãƒœã‚¿ãƒ³ã§å¤‰æ›ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦è¡¨ç¤º
    transformBtn.addEventListener('click', () => {
      transformWindow.style.display = 'block';
    });

    // â˜’ãƒœã‚¿ãƒ³ã§å¤‰æ›ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹
    closeTransform.addEventListener('click', () => {
      transformWindow.style.display = 'none';
    });

    // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒƒãƒ”ãƒ³ã‚°ã®è¡¨ç¤º/éè¡¨ç¤º
    document.querySelectorAll('#transform-window input[name="action"]').forEach(radio => {
      radio.addEventListener('change', () => {
        customMapping.style.display = radio.value === 'custom' ? 'block' : 'none';
      });
    });

    // å¤‰æ›å‡¦ç†
    convertButton.addEventListener('click', () => {
      const action = document.querySelector('#transform-window input[name="action"]:checked').value;
      const sel = window.getSelection();
      let text = '';
      let isSelection = false;

      if (sel.rangeCount && memo.contains(sel.anchorNode)) {
        text = sel.toString();
        isSelection = true;
      } else {
        text = memo.innerText;
      }

      let result = '';
      if (action === 'encode') {
        result = encodeURIComponent(text);
      } else if (action === 'decode') {
        result = decodeURIComponent(text);
      } else if (action === 'remove' || action === 'remove1') {
        let lines = text.split('\n').map(line => {
          let idx = line.indexOf('//');
          while (idx !== -1) {
            if (idx >= 6 && line.substring(idx - 6, idx) === "https:") {
              idx = line.indexOf('//', idx + 2);
            } else {
              break;
            }
          }
          return idx !== -1 ? line.slice(0, idx) : line;
        });
        result = action === 'remove1' ? lines.join('') : lines.join('\n');
      } else if (action === 'custom') {
        const from = customFrom.value;
        const to = customTo.value;
        if (from && to) {
          result = text.split(from).join(to);
        } else {
          alert('ã‚«ã‚¹ã‚¿ãƒ å¤‰æ›ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚å¤‰æ›å…ƒã¨å¤‰æ›å…ˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
      }

      if (isSelection) {
        const range = sel.getRangeAt(0);
        range.deleteContents();
        range.insertNode(document.createTextNode(result));
      } else {
        memo.innerText = result;
      }

      rawText = memo.innerText;
      history = history.slice(0, currentStep + 1);
      history.push(rawText);
      currentStep++;
      transformWindow.style.display = 'none';
    });
  </script>
</body>
</html>
