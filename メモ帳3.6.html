<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¡ãƒ¢å¸³ 3.6</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    html, body { height: 100%; margin: 0; padding: 18px; box-sizing: border-box; }
    body { display: flex; flex-direction: column; font-family: sans-serif; }
    .controls { flex: 0 0 auto; margin-bottom: 10px; position: relative; display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
    .controls button, .controls input, .controls select { padding: 7px 7px; font-size: 12px; }
    
    #editor-container { flex: 1; position: relative; border: 1px solid #ccc; overflow: hidden; }
    #memo { width: 100%; height: 100%; box-sizing: border-box; padding: 10px; overflow: auto; white-space: pre-wrap; font-family: monospace; outline: none; }
    #code-editor { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: none; }
    
    .highlight { background-color: yellow; }
    .highlight-delete { background-color: #ffcccc; text-decoration: line-through; }
    .highlight-change { background-color: cyan; }
    .ace-marker-change { background-color: rgba(0, 255, 255, 0.4); position: absolute; }
    .ace-marker-delete { background-color: rgba(255, 0, 0, 0.3); position: absolute; }

    #settings-panel { display: none; position: fixed; top: 0; left: 0; width: 300px; height: 100%; background: #f9f9f9; border-right: 1px solid #ccc; z-index: 2000; box-shadow: 2px 0 5px rgba(0,0,0,0.1); padding: 15px; overflow-y: auto; }
    #settings-panel.open { display: block; }
    .panel-header { display: flex; justify-content: flex-end; margin-bottom: 20px; }
    .panel-close { cursor: pointer; font-weight: bold; font-size: 18px; }
    #expand-btn { display: none; position: fixed; top: 10px; left: 10px; z-index: 3000; padding: 10px 15px; font-weight: bold; background: #fff; border: 2px solid #333; cursor: pointer; }

    .menu-btn { width: 100%; padding: 10px; text-align: left; margin-bottom: 5px; cursor: pointer; background: #fff; border: 1px solid #ddd; }
    .menu-btn:hover { background: #eee; }
    .screen { display: none; }
    .screen.active { display: block; }
    .row { margin-bottom: 10px; }
    .row label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 12px; }
    .row input[type="text"], .row input[type="password"] { width: 100%; padding: 5px; box-sizing: border-box; }
    .item-list { border: 1px solid #eee; padding: 5px; max-height: 200px; overflow-y: auto; margin-bottom: 10px; }
    .item { padding: 3px; cursor: pointer; display: flex; align-items: center; }
    .item:hover { background: #eef; }
    .item.selected { background: #ddf; border-left: 3px solid blue; }
    #count { min-width: 40px; text-align: center; display: inline-block; font-size: 12px; }
    .status-msg { font-size: 10px; color: blue; margin-top: 5px; }
  </style>
</head>
<body>
  <button id="expand-btn">â¤¢ å±•é–‹ (å…ƒã«æˆ»ã™)</button>

  <div id="settings-panel">
    <div class="panel-header"><span class="panel-close">â˜’</span></div>
    
    <div id="menu-screen" class="screen active">
      <button class="menu-btn" id="btn-editor-mode">ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¢ãƒ¼ãƒ‰ ã‚ªãƒ³</button>
      <button class="menu-btn" id="btn-transform">å¤‰æ›</button>
      <button class="menu-btn" id="btn-pc-view">PCè¡¨ç¤º</button>
      <button class="menu-btn" id="btn-import">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <button class="menu-btn" id="btn-export">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="menu-btn" id="btn-memo-list">ãƒ¡ãƒ¢ä¸€è¦§</button>
      <button class="menu-btn" id="btn-memo-save">ãƒ¡ãƒ¢ä¿å­˜</button>
      <hr>
      <button class="menu-btn" id="btn-gh-settings">GitHubè¨­å®š</button>
    </div>

    <div id="gh-settings-screen" class="screen">
      <button class="back-btn">â†æˆ»ã‚‹</button>
      <h3>GitHubè¨­å®š</h3>
      <div class="row"><label>GitHubã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³</label><input type="password" id="gh-token"></div>
      <div class="row"><label>ãƒªãƒã‚¸ãƒˆãƒªURL</label><input type="text" id="gh-repo" placeholder="https://github.com/user/repo"></div>
      <div class="row"><label>ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«å</label><input type="text" id="gh-filename" placeholder="memo_data.json"></div>
      <button id="gh-save-config">è¨­å®šä¿å­˜ & åˆæœŸåŒ–</button>
      <div id="gh-status" class="status-msg"></div>
    </div>
    
    <div id="transform-screen" class="screen">
      <button class="back-btn">â†æˆ»ã‚‹</button>
      <h3>å¤‰æ›</h3>
      <label><input type="radio" name="trans-type" value="encode" checked> ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰</label><br>
      <label><input type="radio" name="trans-type" value="decode"> ãƒ‡ã‚³ãƒ¼ãƒ‰</label><br>
      <label><input type="radio" name="trans-type" value="remove-comment"> ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤</label>
      <label style="margin-left:20px;"><input type="checkbox" id="chk-one-line"> 1æ–‡</label><br>
      <label><input type="radio" name="trans-type" value="custom"> ã‚«ã‚¹ã‚¿ãƒ </label>
      <div class="row" style="margin-top:10px;"><label>å¤‰æ›å…ƒ</label><input type="text" id="trans-from"></div>
      <div class="row"><label>å¤‰æ›å…ˆ</label><input type="text" id="trans-to"></div>
      <div style="display:flex; justify-content:space-between; margin-top:15px;">
        <button id="do-transform">å¤‰æ›</button>
        <button id="do-confirm-transform">ç¢ºèª</button>
      </div>
    </div>

    <div id="import-screen" class="screen">
      <button class="back-btn">â†æˆ»ã‚‹</button>
      <h3>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
      <div class="row"><label>URL</label><input type="text" id="import-url" placeholder="GitHub Raw / ãƒªãƒã‚¸ãƒˆãƒª / ã‚µã‚¤ãƒˆURL"></div>
      <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <button id="do-import-url">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <button id="btn-import-file">ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰</button>
        <input type="file" id="file-input" style="display:none">
        <button id="btn-candidates">å€™è£œ</button>
      </div>
    </div>

    <div id="candidate-screen" class="screen">
      <button class="back-btn" data-target="import-screen">â†æˆ»ã‚‹</button>
      <button id="save-candidates" style="float:right;">ä¿å­˜</button>
      <h3>å€™è£œç·¨é›†</h3>
      <div class="row">
        <input type="radio" name="cand-sel" id="cand-new" checked> <label style="display:inline;">æ–°è¦/é¸æŠãªã—</label>
        <div id="candidate-list" class="item-list" style="height: 100px;"></div>
      </div>
      <div class="row"><label>åå‰</label><input type="text" id="cand-name"></div>
      <div class="row"><label>URL</label><input type="text" id="cand-url"></div>
      <div>
        <button id="cand-add">è¿½åŠ </button>
        <button id="cand-del">å‰Šé™¤</button>
        <button id="cand-up">â†‘</button>
        <button id="cand-down">â†“</button>
      </div>
    </div>

    <div id="export-screen" class="screen">
      <button class="back-btn">â†æˆ»ã‚‹</button>
      <h3>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
      <div class="row"><label>ãƒ•ã‚¡ã‚¤ãƒ«å</label><input type="text" id="export-name" placeholder="example"></div>
      <div class="row"><label>æ‹¡å¼µå­</label><input type="text" id="export-ext" placeholder="txt"></div>
      <button id="do-export">ä¿å­˜</button>
    </div>

    <div id="list-screen" class="screen">
      <button class="back-btn">â†æˆ»ã‚‹</button>
      <button id="sync-save" style="float:right;">ä¿å­˜</button>
      <h3>ãƒ¡ãƒ¢ä¸€è¦§</h3>
      <div id="memo-tree-view" class="item-list" style="min-height:200px;">Loading...</div>
      <div class="row"><button id="btn-edit-mode">ç·¨é›†</button></div>
      <div id="new-folder-area" class="row">
        <label>ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ</label>
        <input type="text" id="new-folder-name" placeholder="ãƒ•ã‚©ãƒ«ãƒ€å">
        <button id="create-folder">ä½œæˆ</button>
      </div>
    </div>

    <div id="list-edit-ui" class="screen">
       <button id="list-edit-back">è²¼ã‚Šä»˜ã‘(çµ‚äº†)</button>
       <h3>ç·¨é›†ä¸­</h3>
       <div id="memo-tree-edit" class="item-list"></div>
       <div style="display:flex; gap:5px; flex-wrap:wrap;">
         <button id="edit-move">ç§»å‹•</button>
         <button id="edit-copy">ã‚³ãƒ”ãƒ¼</button>
         <button id="edit-del">å‰Šé™¤</button>
       </div>
       <div id="move-controls" style="display:none; margin-top:5px;">
         <button id="move-up">ä¸Šã¸</button>
         <button id="move-down">ä¸‹ã¸</button>
         <button id="move-in">â†ä¸‹ã®éšå±¤ã¸</button>
         <button id="move-paste">è²¼ã‚Šä»˜ã‘</button>
       </div>
    </div>

    <div id="save-screen" class="screen">
      <button class="back-btn">â†æˆ»ã‚‹</button>
      <h3>ãƒ¡ãƒ¢ä¿å­˜</h3>
      <div class="row"><label>ã‚¿ã‚¤ãƒˆãƒ«å</label><input type="text" id="save-title"></div>
      <div id="save-tree-view" class="item-list"></div>
      <div style="display:flex; justify-content:space-between;">
        <button id="do-save-memo">ä¿å­˜</button>
        <button id="do-save-temp">ä¸€æ™‚ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div class="controls">
    <button id="settings-btn">âš™ï¸</button>
    <button id="undo">â†</button>
    <button id="redo">â†’</button>
    <button id="clear">ã‚¯ãƒªã‚¢</button>
    <button id="copy">ã‚³ãƒ”ãƒ¼</button>
    <input id="search" type="text" placeholder="ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢">
    <button id="prev"><</button>
    <span id="count">0/0</span>
    <button id="next">></button>
    <input id="prefix" type="text" placeholder="å§‹ã‚">
    <input id="suffix" type="text" placeholder="çµ‚ã‚ã‚Š">
    <button id="add-prefix-suffix">è¿½åŠ </button>
    <select id="exec-type">
      <option value="js">JavaScript</option>
      <option value="html">HTML</option>
      <option value="md">Markdown</option>
      <option value="svg">SVG</option>
    </select>
    <button id="do-exec">å®Ÿè¡Œ</button>
    <button id="open-url">ï¼‹</button>
    <button id="char-count-btn" title="æ–‡å­—æ•°">0</button>
  </div>

  <div id="editor-container">
    <div id="memo" contenteditable="true"></div>
    <div id="code-editor"></div>
  </div>

<script>
/* -------------------------------------------------------------------------- */
/* åˆæœŸåŒ–                                       */
/* -------------------------------------------------------------------------- */
const memo = document.getElementById('memo');
const editorDiv = document.getElementById('code-editor');
let aceEditor = null;
let isEditorMode = false;
let history = [''];
let currentStep = 0;

function initAce() {
  aceEditor = ace.edit("code-editor");
  aceEditor.setTheme("ace/theme/twilight"); 
  aceEditor.session.setMode("ace/mode/javascript");
  aceEditor.setOptions({ fontSize: "14px", showLineNumbers: true, wrap: true });
  aceEditor.on("change", () => updateHistory(aceEditor.getValue()));
}
initAce();

document.getElementById('exec-type').addEventListener('change', (e) => {
  const modeMap = {'js':'ace/mode/javascript','html':'ace/mode/html','md':'ace/mode/markdown','svg':'ace/mode/xml'};
  if (aceEditor) aceEditor.session.setMode(modeMap[e.target.value]);
});

document.getElementById('btn-editor-mode').addEventListener('click', () => {
  const btn = document.getElementById('btn-editor-mode');
  if (!isEditorMode) {
    const current = memo.innerText;
    memo.style.display = 'none'; editorDiv.style.display = 'block';
    aceEditor.setValue(current, -1);
    isEditorMode = true; btn.textContent = "ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¢ãƒ¼ãƒ‰ ã‚ªãƒ•";
  } else {
    const current = aceEditor.getValue();
    editorDiv.style.display = 'none'; memo.style.display = 'block';
    memo.innerText = current;
    isEditorMode = false; btn.textContent = "ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¢ãƒ¼ãƒ‰ ã‚ªãƒ³";
  }
});

function getText() { return isEditorMode ? aceEditor.getValue() : memo.innerText; }
function setText(text) {
  if (isEditorMode) aceEditor.setValue(text, -1); else memo.innerText = text;
}
function updateHistory(text) {
  if (history[currentStep] !== text) {
    history = history.slice(0, currentStep + 1);
    history.push(text);
    currentStep++;
  }
  updateCharCount();
}

/* -------------------------------------------------------------------------- */
/* ãƒ‘ãƒãƒ«åˆ¶å¾¡                                    */
/* -------------------------------------------------------------------------- */
const panel = document.getElementById('settings-panel');
const screens = document.querySelectorAll('.screen');
const expandBtn = document.getElementById('expand-btn');

document.getElementById('settings-btn').addEventListener('click', () => { 
  panel.classList.add('open'); 
  showScreen('menu-screen'); 
  loadGhSettingsFromExt();
});
document.querySelector('.panel-close').addEventListener('click', () => panel.classList.remove('open'));
function showScreen(id) {
  screens.forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
document.querySelectorAll('.back-btn').forEach(btn => {
  btn.addEventListener('click', (e) => showScreen(e.target.dataset.target || 'menu-screen'));
});
const bindScreen = (id, screen) => document.getElementById(id).onclick = () => showScreen(screen);
bindScreen('btn-transform','transform-screen');
bindScreen('btn-import','import-screen');
bindScreen('btn-export','export-screen');
bindScreen('btn-gh-settings','gh-settings-screen');
document.getElementById('btn-memo-list').onclick = () => { fetchGitHubData(); showScreen('list-screen'); };
document.getElementById('btn-memo-save').onclick = () => { fetchGitHubData(); showScreen('save-screen'); };
document.getElementById('btn-candidates').onclick = () => { loadCandidatesUI(); showScreen('candidate-screen'); };

/* -------------------------------------------------------------------------- */
/* æ¤œç´¢æ©Ÿèƒ½                                      */
/* -------------------------------------------------------------------------- */
let searchMatches = [];
let searchIndex = 0;
function highlightSearch() {
  const term = document.getElementById('search').value;
  searchMatches = [];
  searchIndex = 0;
  if (!term) {
    document.getElementById('count').textContent = "0/0";
    if (!isEditorMode) memo.innerHTML = escapeHTML(getText());
    return;
  }
  if (isEditorMode) {
    aceEditor.findAll(term, {wrap: true, caseSensitive: false, regExp: false});
    const regex = new RegExp(escapeRegExp(term), 'gi');
    const count = (aceEditor.getValue().match(regex) || []).length;
    document.getElementById('count').textContent = count > 0 ? `1/${count}` : "0/0";
  } else {
    const text = getText();
    const regex = new RegExp(`(${escapeRegExp(term)})`, 'gi');
    memo.innerHTML = escapeHTML(text).replace(regex, '<span class="highlight">$1</span>');
    searchMatches = document.querySelectorAll('.highlight');
    if (searchMatches.length > 0) {
      searchMatches[0].scrollIntoView({block: "center", behavior: "smooth"});
      document.getElementById('count').textContent = `1/${searchMatches.length}`;
    } else { document.getElementById('count').textContent = "0/0"; }
  }
}
document.getElementById('search').addEventListener('input', highlightSearch);
document.getElementById('prev').onclick = () => {
  if (isEditorMode) { aceEditor.findPrevious(); return; }
  if (searchMatches.length === 0) return;
  searchIndex = (searchIndex - 1 + searchMatches.length) % searchMatches.length;
  searchMatches[searchIndex].scrollIntoView({block: "center", behavior: "smooth"});
  document.getElementById('count').textContent = `${searchIndex + 1}/${searchMatches.length}`;
};
document.getElementById('next').onclick = () => {
  if (isEditorMode) { aceEditor.findNext(); return; }
  if (searchMatches.length === 0) return;
  searchIndex = (searchIndex + 1) % searchMatches.length;
  searchMatches[searchIndex].scrollIntoView({block: "center", behavior: "smooth"});
  document.getElementById('count').textContent = `${searchIndex + 1}/${searchMatches.length}`;
};

/* -------------------------------------------------------------------------- */
/* è¡Œé ­ãƒ»è¡Œæœ« è¿½åŠ                                  */
/* -------------------------------------------------------------------------- */
document.getElementById('add-prefix-suffix').addEventListener('click', () => {
  const prefix = document.getElementById('prefix').value || "";
  const suffix = document.getElementById('suffix').value || "";
  const beforeText = getText();
  if (history[currentStep] !== beforeText) updateHistory(beforeText);

  if (isEditorMode) {
    const range = aceEditor.getSelectionRange();
    const doc = aceEditor.session.getDocument();
    for (let r = range.start.row; r <= range.end.row; r++) {
      let line = doc.getLine(r);
      aceEditor.session.replace(new ace.Range(r, 0, r, line.length), prefix + line + suffix);
    }
  } else {
    const sel = window.getSelection();
    if (!sel.rangeCount) return;
    const text = sel.toString();
    if (!text) return;
    const lines = text.split(/\r?\n/);
    const newTextSegment = lines.map(line => prefix + line + suffix).join('\n');
    const range = sel.getRangeAt(0);
    range.deleteContents();
    range.insertNode(document.createTextNode(newTextSegment));
    memo.innerText = memo.innerText; 
  }
  updateHistory(getText());
});

/* -------------------------------------------------------------------------- */
/* å¤‰æ›ãƒ»ç¢ºèªãƒ¢ãƒ¼ãƒ‰                                */
/* -------------------------------------------------------------------------- */
let originalContent = null;
let confirmMarkers = [];
function applyTransformLogic(text, type, isOneLine, customFrom, customTo) {
  let result = text;
  if (type === 'encode') result = encodeURIComponent(text);
  else if (type === 'decode') result = decodeURIComponent(text);
  else if (type === 'custom' && customFrom && customTo) result = text.split(customFrom).join(customTo);
  return result;
}
function getRanges(text, type, customFrom, customTo) {
  let ranges = [];
  if (type === 'remove-comment') {
    const lines = text.split('\n');
    let offset = 0; let inside = false;
    lines.forEach(line => {
      const len = line.length + 1;
      if (line.includes('// ==UserScript==')) inside = true;
      if (line.includes('// ==/UserScript==')) inside = false;
      if (!inside) {
        let m = line.match(/^(\s*)(\/\/.*)$/);
        if (m) ranges.push({start: offset, end: offset+line.length});
        else {
          let idx = line.search(/\s\/\//);
          if (idx !== -1) ranges.push({start: offset+idx+1, end: offset+line.length});
        }
        let blockRegex = /\/\*[\s\S]*?\*\//g;
        let bm;
        while((bm = blockRegex.exec(line))!==null) ranges.push({start: offset+bm.index, end: offset+bm.index+bm[0].length});
      }
      offset += len;
    });
  } else if (type === 'custom' && !customTo && customFrom) {
    let idx = text.indexOf(customFrom);
    while (idx !== -1) { ranges.push({start: idx, end: idx+customFrom.length}); idx = text.indexOf(customFrom, idx+1); }
  } else if (type === 'custom' && customTo && customFrom) {
    const newText = text.split(customFrom).join(customTo);
    let idx = newText.indexOf(customTo);
    while (idx !== -1) { ranges.push({start: idx, end: idx+customTo.length}); idx = newText.indexOf(customTo, idx+1); }
  }
  return ranges;
}
function executeTransform(isConfirm) {
  const type = document.querySelector('input[name="trans-type"]:checked').value;
  const isOneLine = document.getElementById('chk-one-line').checked;
  const customFrom = document.getElementById('trans-from').value;
  const customTo = document.getElementById('trans-to').value;
  const currentText = getText();
  let mode = 'change'; 
  if (type === 'remove-comment' || (type === 'custom' && !customTo)) mode = 'delete';

  if (isConfirm) {
    originalContent = currentText;
    panel.classList.remove('open');
    expandBtn.style.display = 'block';
    if (mode === 'change') {
      const result = applyTransformLogic(currentText, type, isOneLine, customFrom, customTo);
      if (type === 'custom' && customFrom && customTo) {
        if (isEditorMode) {
          aceEditor.setValue(result, -1); aceEditor.setReadOnly(true);
          const ranges = getRanges(currentText, type, customFrom, customTo);
          ranges.forEach(rng => {
             const doc = aceEditor.session.getDocument();
             const p1 = doc.indexToPosition(rng.start);
             const p2 = doc.indexToPosition(rng.end);
             const r = new ace.Range(p1.row, p1.column, p2.row, p2.column);
             confirmMarkers.push(aceEditor.session.addMarker(r, "ace-marker-change", "text"));
          });
        } else {
          const escapedTo = escapeHTML(customTo);
          const highlightedHtml = escapeHTML(result).split(escapedTo).join(`<span class="highlight-change">${escapedTo}</span>`);
          memo.innerHTML = highlightedHtml; memo.contentEditable = false;
        }
      } else {
        if (isEditorMode) {
          aceEditor.setValue(result, -1); aceEditor.setReadOnly(true);
          const r = new ace.Range(0, 0, aceEditor.session.getLength(), 0);
          confirmMarkers.push(aceEditor.session.addMarker(r, "ace-marker-change", "fullLine"));
        } else {
          memo.innerHTML = `<span class="highlight-change" style="width:100%; display:inline-block;">${escapeHTML(result)}</span>`;
          memo.contentEditable = false;
        }
      }
    } else {
      const ranges = getRanges(currentText, type, customFrom, null);
      if (isEditorMode) {
        aceEditor.setReadOnly(true);
        ranges.forEach(rng => {
          const doc = aceEditor.session.getDocument();
          const p1 = doc.indexToPosition(rng.start);
          const p2 = doc.indexToPosition(rng.end);
          const r = new ace.Range(p1.row, p1.column, p2.row, p2.column);
          confirmMarkers.push(aceEditor.session.addMarker(r, "ace-marker-delete", "text"));
        });
      } else {
        let html = ""; let last = 0;
        ranges.sort((a,b) => a.start - b.start);
        ranges.forEach(r => {
          html += escapeHTML(currentText.substring(last, r.start));
          html += `<span class="highlight-delete">${escapeHTML(currentText.substring(r.start, r.end))}</span>`;
          last = r.end;
        });
        html += escapeHTML(currentText.substring(last));
        memo.innerHTML = html.replace(/\n/g, '<br>');
        memo.contentEditable = false;
      }
    }
  } else {
    if (mode === 'change') {
      setText(applyTransformLogic(currentText, type, isOneLine, customFrom, customTo));
    } else {
      const ranges = getRanges(currentText, type, customFrom, null);
      let chars = currentText.split('');
      ranges.sort((a,b) => b.start - a.start);
      ranges.forEach(r => chars.splice(r.start, r.end - r.start));
      let result = chars.join('');
      if (type === 'remove-comment' && isOneLine) result = result.replace(/\r?\n/g, '');
      setText(result);
    }
  }
}
document.getElementById('do-transform').onclick = () => executeTransform(false);
document.getElementById('do-confirm-transform').onclick = () => executeTransform(true);
expandBtn.addEventListener('click', () => {
  if (originalContent !== null) {
    if (isEditorMode) {
      aceEditor.setValue(originalContent, -1); aceEditor.setReadOnly(false);
      confirmMarkers.forEach(id => aceEditor.session.removeMarker(id)); confirmMarkers = [];
    } else {
      memo.innerText = originalContent; memo.contentEditable = true;
    }
    originalContent = null;
  }
  expandBtn.style.display = 'none'; panel.classList.add('open');
});

/* -------------------------------------------------------------------------- */
/* GitHubé€£æº                                    */
/* -------------------------------------------------------------------------- */
function sendExtMessage(payload) {
  return new Promise((resolve, reject) => {
    const id = Date.now() + Math.random();
    let handled = false;
    const handler = (e) => {
      if (e.data && e.data.source === 'MEMO_EXTENSION' && e.data.id === id) {
        window.removeEventListener('message', handler);
        handled = true;
        resolve(e.data.payload);
      }
    };
    window.addEventListener('message', handler);
    window.postMessage({ source: 'MEMO_TOOL_V3', id, payload }, "*");
    setTimeout(() => {
      if (!handled) { window.removeEventListener('message', handler); reject('EXTENSION_TIMEOUT'); }
    }, 1000);
  });
}
async function loadGhSettingsFromExt() {
  try {
    const res = await sendExtMessage({ type: 'GET_SETTINGS' });
    if (res) {
      if(res.githubToken) document.getElementById('gh-token').value = res.githubToken;
      if(res.repoUrl) document.getElementById('gh-repo').value = res.repoUrl;
      if(res.fileName) document.getElementById('gh-filename').value = res.fileName;
      document.getElementById('gh-status').textContent = "æ‹¡å¼µæ©Ÿèƒ½ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ";
    }
  } catch(e) {
    if(e === 'EXTENSION_TIMEOUT') {
      document.getElementById('gh-status').textContent = "âš  æ‹¡å¼µæ©Ÿèƒ½ãŒæ¤œå‡ºã§ãã¾ã›ã‚“";
      document.getElementById('gh-status').style.color = 'red';
    }
  }
}
document.getElementById('gh-save-config').onclick = async () => {
  const token = document.getElementById('gh-token').value.trim();
  const repoUrl = document.getElementById('gh-repo').value.trim();
  const filename = document.getElementById('gh-filename').value.trim();
  const statusDiv = document.getElementById('gh-status');
  if (!token || !repoUrl || !filename) return alert('å…¨é …ç›®å…¥åŠ›ã—ã¦ãã ã•ã„');
  const match = repoUrl.match(/github\.com\/([^\/]+)\/([^\/\.]+)/);
  if (!match) return alert('ãƒªãƒã‚¸ãƒˆãƒªURLãŒç„¡åŠ¹ã§ã™');
  const owner = match[1];
  const repo = match[2].replace(/(\.git)+$/, '').replace(/#.*$/, '');
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${filename}`;
  statusDiv.textContent = "æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...";
  statusDiv.style.color = "blue";
  try {
    const res = await sendExtMessage({ type: 'GITHUB_FETCH', url: url, token: token });
    if (res.status === 404) {
      if(confirm("ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã—ã¾ã™ã‹ï¼Ÿ")) {
        const initialData = { folders: [], tempMemo: "", candidates: [] };
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(initialData, null, 2))));
        await sendExtMessage({ 
          type: 'GITHUB_FETCH', method: 'PUT', url: url, token: token,
          body: { message: "Init from MemoPad", content: content } 
        });
        statusDiv.textContent = "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä¿å­˜ã—ã¾ã—ãŸ";
        alert('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–°è¦ä½œæˆã—ã¾ã—ãŸ');
      } else { statusDiv.textContent = "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ"; }
    } else if (res.ok || res.success) {
      statusDiv.textContent = "æ¥ç¶šæˆåŠŸ"; alert('æ¥ç¶šæˆåŠŸ: æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¾ã—ãŸ');
    } else {
      statusDiv.textContent = "ã‚¨ãƒ©ãƒ¼: " + (res.status || res.error); alert('ã‚¨ãƒ©ãƒ¼: ' + res.error);
    }
    localStorage.setItem('gh_settings', JSON.stringify({ token, repo: repoUrl, filename }));
  } catch (e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e); }
};
async function getGhConfig() {
  const token = document.getElementById('gh-token').value;
  const repoUrl = document.getElementById('gh-repo').value;
  const filename = document.getElementById('gh-filename').value;
  if(!token) return null;
  const match = repoUrl.match(/github\.com\/([^\/]+)\/([^\/\.]+)/);
  if(!match) return null;
  return { token, owner: match[1], repo: match[2].replace(/(\.git)+$/, '').replace(/#.*$/, ''), filename };
}
let currentGitHubData = null; let currentSha = null;
async function fetchGitHubData() {
  try {
    const cfg = await getGhConfig();
    if (!cfg) { alert('GitHubè¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„'); return; }
    const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.filename}`;
    const res = await sendExtMessage({ type: 'GITHUB_FETCH', url: url, token: cfg.token });
    if (res.ok || res.success) {
      currentSha = res.data.sha;
      const content = decodeURIComponent(escape(atob(res.data.content)));
      currentGitHubData = JSON.parse(content);
      renderTree(document.getElementById('memo-tree-view'), currentGitHubData.folders || []);
      renderTree(document.getElementById('save-tree-view'), currentGitHubData.folders || [], true);
    } else { alert('å–å¾—ã‚¨ãƒ©ãƒ¼: ' + res.error); }
  } catch(e) { alert(e); }
}
async function saveToGitHub(data, msg) {
  try {
    const cfg = await getGhConfig();
    const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.filename}`;
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
    const res = await sendExtMessage({ 
      type: 'GITHUB_FETCH', method: 'PUT', url: url, token: cfg.token, 
      body: { message: msg, content: content, sha: currentSha }
    });
    if (res.ok || res.success) {
      currentSha = res.data.content.sha;
      if (data.tempMemo) sendExtMessage({ type: 'SET_TEMP_MEMO', text: data.tempMemo });
    } else { alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + res.error); }
  } catch(e) { alert(e); }
}
let currentPath = [];
function renderTree(container, folders, isSaveMode = false) {
  container.innerHTML = '';
  if (!isSaveMode && currentGitHubData?.tempMemo) {
    const d = document.createElement('div'); d.className='item'; d.innerHTML='ğŸ“‹ï¸ <b>ä¸€æ™‚ãƒ¡ãƒ¢</b>';
    d.onclick = () => { setText(currentGitHubData.tempMemo); panel.classList.remove('open'); };
    container.appendChild(d);
  }
  if (currentPath.length > 0) {
    const up = document.createElement('div'); up.className='item'; up.innerText='ğŸ“ ..';
    up.onclick = () => { currentPath.pop(); renderTree(container, folders, isSaveMode); };
    container.appendChild(up);
  }
  let target = { children: folders };
  for(const p of currentPath) target = target.children.find(c=>c.name===p);
  if(!target) return;
  (target.children||[]).forEach(node => {
    const div = document.createElement('div'); div.className='item';
    if(node.type==='folder') {
      div.innerHTML = `ğŸ“ ${escapeHTML(node.name)}`;
      div.onclick = () => {
        if (isSaveMode) {
             document.querySelectorAll('.item').forEach(i=>i.classList.remove('selected'));
             div.classList.add('selected');
             // ä¿å­˜ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¯ãƒªãƒƒã‚¯ã§ä¸­ã«å…¥ã‚‰ãšé¸æŠçŠ¶æ…‹ã«ã™ã‚‹ã ã‘ã«ã—ãŸã„å ´åˆã‚‚ã‚ã‚Šã¾ã™ãŒã€
             // è¦ä»¶ã®ã€Œéšå±¤è¡¨ç¤ºã€ã¨ã€Œãã®éšå±¤ã«ä¿å­˜ã€ã‚’ä¸¡ç«‹ã•ã›ã‚‹ãŸã‚ã€ã“ã“ã§ã¯
             // ã‚·ãƒ³ã‚°ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ä¸­ã«å…¥ã‚Šã€ç¾åœ¨åœ°(currentPath)ã«ä¿å­˜ã™ã‚‹ä»•æ§˜ã¨ã—ã¾ã™
             currentPath.push(node.name); renderTree(container, folders, isSaveMode);
        } else {
             currentPath.push(node.name); renderTree(container, folders, isSaveMode);
        }
      };
    } else {
      div.innerHTML = `ğŸ“‹ï¸ ${escapeHTML(node.name)}`;
      div.onclick = () => { if(!isSaveMode) { setText(node.content); panel.classList.remove('open'); } };
    }
    container.appendChild(div);
  });
}
document.getElementById('do-import-url').onclick = async () => {
  const url = document.getElementById('import-url').value;
  if(!url) return;
  let target = url;
  if(url.includes('github.com') && !url.includes('raw')) target = url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
  try {
    const res = await sendExtMessage({ type: 'FETCH_URL', url: target });
    if(res.success) setText(res.text); else alert('å¤±æ•—: '+res.error);
  } catch(e) { alert('æ‹¡å¼µæ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼: '+e); }
};
document.getElementById('do-exec').onclick = () => {
  const type = document.getElementById('exec-type').value;
  let code = getText();
  if (type === 'js') { try { new Function(code)(); } catch(e) { alert(e); } }
  else {
    const w = window.open();
    if (type === 'md') w.document.write(marked.parse(code)); else w.document.write(code);
    w.document.close();
  }
};
function escapeHTML(s) { return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m])); }
function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
function updateCharCount() { document.getElementById('char-count-btn').textContent = getText().length; }
document.getElementById('clear').onclick=()=>{setText('');};
document.getElementById('undo').onclick=()=>{if(currentStep>0){currentStep--;setText(history[currentStep]);}};
document.getElementById('redo').onclick=()=>{if(currentStep<history.length-1){currentStep++;setText(history[currentStep]);}};
document.getElementById('copy').onclick=()=>{navigator.clipboard.writeText(getText());};

// -----------------------------------------------------------
// ä¿®æ­£: ãƒ¡ãƒ¢ä¿å­˜ãƒ»ä¸€æ™‚ä¿å­˜ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
// -----------------------------------------------------------
document.getElementById('do-save-memo').onclick = async () => {
  const title = document.getElementById('save-title').value;
  if(!title) return alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  
  // currentPath ã«å¾“ã£ã¦ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’ç‰¹å®š
  let target = { children: currentGitHubData.folders };
  for(const p of currentPath) {
    target = target.children.find(c => c.type === 'folder' && c.name === p);
    if (!target) return alert('éšå±¤ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }
  if (!target.children) target.children = [];
  
  const existingIdx = target.children.findIndex(c => c.type === 'memo' && c.name === title);
  const newMemo = { type: 'memo', name: title, content: getText() };
  
  if (existingIdx >= 0) {
    if(!confirm('åŒåã®ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) return;
    target.children[existingIdx] = newMemo;
  } else {
    target.children.push(newMemo);
  }
  
  await saveToGitHub(currentGitHubData, `Save memo: ${title}`);
  alert('ä¿å­˜ã—ã¾ã—ãŸ');
  // ãƒ„ãƒªãƒ¼å†æç”»
  renderTree(document.getElementById('save-tree-view'), currentGitHubData.folders, true);
};

document.getElementById('do-save-temp').onclick = async () => {
  currentGitHubData.tempMemo = getText();
  await saveToGitHub(currentGitHubData, "Update temp memo");
  alert('ä¸€æ™‚ä¿å­˜ã—ã¾ã—ãŸ');
};
</script>
</body>
</html>
