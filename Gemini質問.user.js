// ==UserScript==
// @name         Gemini質問.user
// @namespace    http://tampermonkey.net/
// @version      1.1
// @description  Generated by UserScript Site
// @author       You
// @match       http*://*/*
// @grant        none
// @license      MIT
// ==/UserScript==
(function() {
    'use strict';
    const button = document.createElement('div');

    button.style.position = 'fixed';
    button.style.top = '0px';
    button.style.left = '30px';
    button.style.width = '30px';
    button.style.height = '30px';
    button.style.zIndex = '10000';
    button.style.cursor = 'pointer';
    button.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
    button.style.borderRadius = '5px';
    button.style.border = '1px solid white';
    button.style.display = 'flex';
    button.style.flexDirection = 'column';
    button.style.alignItems = 'center';
    button.style.justifyContent = 'center';
    button.style.opacity = '0'; // Initially transparent
    button.style.transition = 'opacity 0.2s ease-in-out';

    for (let i = 0; i < 3; i++) {
        const line = document.createElement('div');
        line.style.width = '20px';
        line.style.height = '3px';
        line.style.backgroundColor = 'white';
        line.style.margin = '2px 0';
        button.appendChild(line);
    }
    document.body.appendChild(button);

    const cursorArea = { top: 0, left: 30, bottom: 30, right: 60 };
    let isCursorInArea = false;

    document.addEventListener('mousemove', (e) => {
        const wasInArea = isCursorInArea;
        isCursorInArea = e.clientX >= cursorArea.left && e.clientX <= cursorArea.right &&
                         e.clientY >= cursorArea.top && e.clientY <= cursorArea.bottom;

        if (wasInArea !== isCursorInArea) {
            button.style.opacity = isCursorInArea ? '1' : '0';
        }
    });
    button.addEventListener('click', () => {
        javascript:(function(){const BM_META={"name":"gemini質問パネル"};const URL_RULES=[{"url":"https://x.com/","settings":{"defaultOpacityPercent":100,"useCursorZone":"no","defaultPromptName":"X","promptSuffixSource":"clipboard"}}];let USER_SETTINGS={"defaultOpacityPercent":30,"useCursorZone":"yes","cursorZoneConfig":{"top":"0px","left":"30px","width":"30px","height":"30px"},"defaultPromptName":"要約","promptSuffixSource":"clipboard","apiKey":"AIzaSyDwLUInN0AfnQeLcaDpHZta39ToptagoIk","prompts":[{"name":"問題","content":"以下の問題を答えだけ表示して"},{"name":"X","content":"以下の文章について、Xでのポスト用に文字数制限内でよりカジュアルな文章にして。ハッシュタグはいらない："}]};const currentUrl=window.location.href;for(const rule of URL_RULES){if(rule.url&&currentUrl.startsWith(rule.url)){USER_SETTINGS={...USER_SETTINGS,...rule.settings};break;}}const main=function(){ if(!USER_SETTINGS.apiKey){ alert("APIキーが設定されていません。"); return; } var oldTrigger=document.getElementById('gemini-trigger-zone-10'); if(oldTrigger) oldTrigger.remove(); var oldPanel=document.getElementById('gemini-panel-10'); if(oldPanel) oldPanel.remove(); var prefersDark=false; try{ prefersDark = !!(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches); }catch(_e){} var colors = prefersDark ? { panelBg:'#0f1419', text:'#e6edf3', border:'#30363d', headerBg:'rgba(22,27,34,0.9)', close:'#8b949e', primary:'#1f6feb', primaryText:'#ffffff', subtleBg:'#161b22', subtleBtnBg:'#21262d', subtleBtnBorder:'#30363d', subtleBtnText:'#e6edf3', errorBg:'#2d1f1f', errorText:'#ffb4a9' } : { panelBg:'#ffffff', text:'#202124', border:'#dadce0', headerBg:'rgba(248,249,250,0.95)', close:'#5f6368', primary:'#1a73e8', primaryText:'#ffffff', subtleBg:'#f1f3f4', subtleBtnBg:'#f1f3f4', subtleBtnBorder:'#ccc', subtleBtnText:'#202124', errorBg:'#fce8e6', errorText:'#d93025' }; var panel=null; var triggerZone=null; var fadeTimer=null; var isFading=false; var defaultOpacity=(USER_SETTINGS.defaultOpacityPercent||100)/100; var lastOpacity=defaultOpacity; function ensurePanel(){ if(panel && panel.isConnected) return; panel = document.createElement('div'); panel.id='gemini-panel-10'; document.body.appendChild(panel); var header=document.createElement('div'); header.style.padding='10px 16px'; header.style.borderBottom='1px solid '+colors.border; header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center'; header.style.backgroundColor=colors.headerBg; header.style.cursor='move'; var leftWrap=document.createElement('div'); leftWrap.style.display='flex'; leftWrap.style.alignItems='center'; leftWrap.style.gap='8px'; var gear=document.createElement('button'); gear.type='button'; gear.title='設定 / ヘルプ'; gear.textContent='⚙️'; gear.style.background='transparent'; gear.style.border='1px solid '+colors.border; gear.style.borderRadius='6px'; gear.style.width='28px'; gear.style.height='28px'; gear.style.cursor='pointer'; gear.style.fontSize='16px'; gear.style.lineHeight='1'; gear.style.display='flex'; gear.style.alignItems='center'; gear.style.justifyContent='center'; gear.onclick=function(){ try{ var w = window.open('https://sites.google.com/view/geminitoolpanel/%E3%83%9B%E3%83%BC%E3%83%A0','_blank'); if(w){ try{ w.opener = null; }catch(_e){} } }catch(_e){} }; var select=document.createElement('select'); select.id='gemini-prompt-select-10'; select.style.fontSize='14px'; select.style.border='1px solid '+colors.border; select.style.borderRadius='6px'; select.style.padding='4px'; select.style.background=colors.panelBg; select.style.color=colors.text; (USER_SETTINGS.prompts||[]).forEach(function(p){ var opt=document.createElement('option'); opt.textContent = p.name||''; opt.dataset.content = p.content||''; if(p.name===USER_SETTINGS.defaultPromptName) opt.selected=true; select.appendChild(opt); }); leftWrap.appendChild(gear); leftWrap.appendChild(select); var right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='15px'; var range=document.createElement('input'); range.type='range'; range.min='0'; range.max='100'; var initialTransparencyValue = 100 - (USER_SETTINGS.defaultOpacityPercent || 100); range.value=String(initialTransparencyValue); range.title='透明度'; range.style.cursor='pointer'; range.style.margin='0'; var closeBtn=document.createElement('button'); closeBtn.id='gemini-close-btn-10'; closeBtn.title='終了'; closeBtn.style.background='0'; closeBtn.style.border='0'; closeBtn.style.width='24px'; closeBtn.style.height='24px'; closeBtn.style.cursor='pointer'; closeBtn.style.fontSize='20px'; closeBtn.style.fontWeight='700'; closeBtn.style.color=colors.close; closeBtn.style.padding='0'; closeBtn.style.lineHeight='1'; closeBtn.textContent='×'; right.appendChild(range); right.appendChild(closeBtn); header.appendChild(leftWrap); header.appendChild(right); var content=document.createElement('div'); content.id='gemini-content-10'; content.style.padding='16px'; content.style.overflowY='auto'; content.style.flexGrow='1'; content.style.color=colors.text; panel.appendChild(header); panel.appendChild(content); panel.style.position='fixed'; panel.style.top='20px'; panel.style.left='20px'; panel.style.width='420px'; panel.style.maxHeight='90vh'; panel.style.backgroundColor=colors.panelBg; panel.style.border='1px solid '+colors.border; panel.style.borderRadius='12px'; panel.style.boxShadow='0 4px 12px rgba(0,0,0,.25)'; panel.style.zIndex='2147483647'; panel.style.fontFamily="'Google Sans','Roboto',Arial,sans-serif"; panel.style.fontSize='15px'; panel.style.lineHeight='1.6'; panel.style.color=colors.text; panel.style.display='flex'; panel.style.flexDirection='column'; panel.style.transition='opacity .15s ease-in-out'; panel.style.opacity= String(defaultOpacity); panel.addEventListener('mouseenter', function(){ cancelHide(); }); panel.addEventListener('mouseleave', function(){ scheduleHide(); }); var closeEl=document.getElementById('gemini-close-btn-10'); closeEl.onclick=function(){ try{ var tz=document.getElementById('gemini-trigger-zone-10'); if(tz) tz.remove(); }catch(_e){} try{ if(panel && panel.parentNode){ panel.parentNode.removeChild(panel); } }catch(_e){} }; range.oninput=function(e){ var v = typeof e.target.value==='string' ? parseFloat(e.target.value) : e.target.value; var op = (100 - v) / 100; lastOpacity = op; panel.style.opacity = String(op); panel.style.pointerEvents = (v>=90) ? 'none' : 'auto'; }; } function showPanel(){ ensurePanel(); cancelHide(); panel.style.display='flex'; panel.style.transition='opacity .15s ease-in-out'; panel.style.opacity= String(lastOpacity); } function scheduleHide(){ if(!panel || isFading) return; isFading = true; panel.style.transition='opacity 1s ease'; panel.style.opacity='0'; fadeTimer = setTimeout(function(){ if(panel){ panel.style.display='none'; } isFading = false; fadeTimer = null; }, 1000); } function cancelHide(){ if(fadeTimer){ clearTimeout(fadeTimer); fadeTimer=null; } if(isFading){ isFading=false; panel.style.transition='opacity .15s ease-in-out'; panel.style.opacity= String(lastOpacity); } } async function runInitialLogic(colors){ var source=USER_SETTINGS.promptSuffixSource; if(source==='none'){ showQuestionUI(colors,''); return; } try{ var suffixText=''; if(source==='selection'){ suffixText = String(window.getSelection().toString()).trim(); } else{ suffixText = await navigator.clipboard.readText(); } if(!suffixText){ alert(source==='selection'?'テキストが範囲選択されていません。':'クリップボードが空です。'); showQuestionUI(colors, source==='selection'?'テキスト未選択':'クリップボード空'); return; } var sel=document.getElementById('gemini-prompt-select-10'); var base = (sel && sel.selectedOptions && sel.selectedOptions[0] && sel.selectedOptions[0].dataset && sel.selectedOptions[0].dataset.content) ? sel.selectedOptions[0].dataset.content : ''; await executeApiCall(colors, base + suffixText); }catch(err){ try{ console.error(err); }catch(_e){} alert('テキスト取得に失敗。HTTPSサイトか、ブラウザ権限を確認してください。'); showQuestionUI(colors,'テキスト取得失敗'); } } function showQuestionUI(colors, initialMessage){ var contentDiv=document.getElementById('gemini-content-10'); if(!contentDiv) return; while(contentDiv.firstChild) contentDiv.removeChild(contentDiv.firstChild); if(initialMessage){ var p=document.createElement('p'); p.style.fontSize='13px'; p.style.color=colors.errorText; p.style.background=colors.errorBg; p.style.padding='8px'; p.style.borderRadius='6px'; p.style.border='1px solid '+colors.border; p.textContent=initialMessage; contentDiv.appendChild(p); } var ta=document.createElement('textarea'); ta.id='gemini-question-input-10'; ta.style.width='98%'; ta.style.height='92px'; ta.style.marginBottom='10px'; ta.style.border='1px solid '+colors.border; ta.style.borderRadius='6px'; ta.style.padding='8px'; ta.style.fontSize='14px'; ta.style.background=colors.panelBg; ta.style.color=colors.text; ta.placeholder='ここに質問を入力...'; var btn=document.createElement('button'); btn.id='gemini-submit-question-10'; btn.textContent='質問'; btn.style.width='100%'; btn.style.padding='10px'; btn.style.border='0'; btn.style.backgroundColor=colors.primary; btn.style.color=colors.primaryText; btn.style.borderRadius='6px'; btn.style.fontSize='15px'; btn.style.cursor='pointer'; btn.onclick=function(){ var q=ta.value||''; if(q) executeApiCall(colors,q); }; contentDiv.appendChild(ta); contentDiv.appendChild(btn); } async function executeApiCall(colors, promptText){ var contentDiv=document.getElementById('gemini-content-10'); if(!contentDiv) return; while(contentDiv.firstChild) contentDiv.removeChild(contentDiv.firstChild); var loading=document.createElement('p'); loading.innerHTML='<strong>問い合わせ中...</strong>'; contentDiv.appendChild(loading); try{ var res = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key='+USER_SETTINGS.apiKey,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ contents:[{ parts:[{ text: String(promptText||'') }]}] }) }); if(!res.ok) throw new Error('APIエラー: '+res.status+' '+res.statusText); var data = await res.json(); var ok = data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && typeof data.candidates[0].content.parts[0].text==='string'; if(ok){ var html = String(data.candidates[0].content.parts[0].text).replace(/\n/g,'<br>'); var div=document.createElement('div'); div.innerHTML = html; contentDiv.innerHTML=''; contentDiv.appendChild(div); }else{ throw new Error((data && data.error && data.error.message) ? data.error.message : '有効な応答がありませんでした。'); } }catch(err){ try{ console.error(err); }catch(_e){} var p=document.createElement('p'); p.style.color=colors.errorText; p.innerHTML='<b>エラー:</b> '+(err && err.message ? err.message : String(err)); contentDiv.innerHTML=''; contentDiv.appendChild(p); }finally{ var cDiv=document.getElementById('gemini-content-10'); if(cDiv){ var re=document.createElement('button'); re.textContent='再質問する'; re.style.width='100%'; re.style.padding='10px'; re.style.border='1px solid '+colors.subtleBtnBorder; re.style.backgroundColor=colors.subtleBtnBg; re.style.color=colors.subtleBtnText; re.style.borderRadius='6px'; re.style.fontSize='15px'; re.style.cursor='pointer'; re.style.marginTop='15px'; re.onclick=function(){ showQuestionUI(colors,''); }; cDiv.appendChild(re); } } } if(USER_SETTINGS.useCursorZone==='yes'){ triggerZone=document.createElement('div'); triggerZone.id='gemini-trigger-zone-10'; var config = USER_SETTINGS.cursorZoneConfig || {top:'0px',left:'30px',width:'30px',height:'30px'}; triggerZone.style.position='fixed'; triggerZone.style.top=String(config.top); triggerZone.style.left=String(config.left); triggerZone.style.width=String(config.width); triggerZone.style.height=String(config.height); triggerZone.style.zIndex='2147483646'; document.body.appendChild(triggerZone); triggerZone.addEventListener('mouseenter', function(){ showPanel(); }); }else{ showPanel(); } ensurePanel(); runInitialLogic(colors);};main();})()
    });
})();